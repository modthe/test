<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kahoot FS</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- Excel Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
color: #333;
line-height: 1.6;
min-height: 100vh;
padding: 20px;
}

.container {
width: 95%;
max-width: 1400px;
background: white;
border-radius: 12px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
overflow: hidden;
margin: 0 auto;
}

/* Enhanced Compact Header */
header {
background: linear-gradient(135deg, #6e8efb, #a777e3);
color: white;
padding: 1rem 1.5rem;
text-align: center;
position: relative;
}

.quiz-timer {
position: absolute;
top: 10px;
right: 20px;
background: rgba(255, 255, 255, 0.2);
padding: 5px 10px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
}

h1 {
font-size: 2rem;
margin-bottom: 0.3rem;
}

.subtitle {
font-size: 1rem;
opacity: 0.9;
}

/* Enhanced Compact Tabs */
.tabs {
display: flex;
background: #f0f0f0;
border-bottom: 2px solid #ddd;
position: sticky;
top: 0;
z-index: 100;
flex-wrap: nowrap;
overflow-x: auto;
}

.tab {
padding: 1rem 1.2rem;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
text-align: center;
flex: 1;
font-size: 0.95rem;
min-width: 120px;
white-space: nowrap;
}

.tab:hover {
background: #e0e0e0;
}

.tab.active {
background: white;
border-bottom: 3px solid #6e8efb;
}

/* Enhanced Compact Content */
.content {
padding: 1.5rem;
min-height: 500px;
}

.tab-content {
display: none;
}

.tab-content.active {
display: block;
animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

/* Enhanced Compact Cards */
.card {
background: white;
border-radius: 10px;
padding: 1.2rem;
margin: 1rem 0;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
border-left: 4px solid #6e8efb;
}

h2 {
font-size: 1.6rem;
color: #6e8efb;
margin-bottom: 0.8rem;
}

h3 {
font-size: 1.3rem;
color: #a777e3;
margin: 1rem 0 0.6rem;
}

/* Enhanced Form Elements */
input, button, select, textarea {
padding: 0.8rem 1rem;
margin: 0.5rem 0;
border-radius: 6px;
border: 1px solid #ddd;
font-size: 0.9rem;
}

input, select, textarea {
width: 100%;
max-width: 320px;
}

textarea {
min-height: 90px;
resize: vertical;
}

button {
background: #6e8efb;
color: white;
border: none;
cursor: pointer;
transition: all 0.3s ease;
font-weight: 600;
}

button:hover {
background: #5a7df9;
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

button:disabled {
background: #ccc;
cursor: not-allowed;
transform: none;
box-shadow: none;
}

/* Enhanced Answer Grid */
.answers-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin: 1.2rem 0;
}

.answer-btn {
display: flex;
align-items: center;
justify-content: center;
text-align: center;
margin: 0;
padding: 1.3rem;
background: #f8f9fa;
color: #333;
border: 2px solid #ddd;
border-radius: 10px;
transition: all 0.3s ease;
font-size: 1.05rem;
font-weight: 500;
min-height: 90px;
word-wrap: break-word;
hyphens: auto;
cursor: pointer;
position: relative;
}

.answer-btn:hover {
background: #e9ecef;
transform: translateY(-3px);
border-color: #6e8efb;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.answer-btn.correct {
background-color: #4caf50 !important;
color: white !important;
border-color: #4caf50 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.answer-btn.incorrect {
background-color: #f44336 !important;
color: white !important;
border-color: #f44336 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
}

.answer-btn:disabled {
opacity: 0.7;
pointer-events: none;
}

.answer-btn.other-option {
opacity: 0.6;
background: #f0f0f0;
}

/* Enhanced Compact Sections */
.compact-section {
background: #f8f9fa;
border-left: 4px solid #6e8efb;
padding: 1rem;
margin: 0.8rem 0;
border-radius: 6px;
}

.compact-section h3 {
margin-top: 0;
font-size: 1.2rem;
}

/* Enhanced Status Messages */
.url-status {
margin-top: 8px;
padding: 8px;
border-radius: 5px;
text-align: center;
font-size: 0.9rem;
}

.url-status.success {
background-color: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.url-status.error {
background-color: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

/* Enhanced Quick Actions */
.quick-actions {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
gap: 12px;
margin: 1.2rem 0;
}

.quick-action-btn {
padding: 1rem;
text-align: center;
background: #6e8efb;
color: white;
border-radius: 8px;
cursor: pointer;
transition: all 0.3s ease;
font-size: 0.95rem;
font-weight: 600;
}

.quick-action-btn:hover {
background: #5a7df9;
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Enhanced Collapsible Sections */
.collapsible {
background: #f8f9fa;
border: 1px solid #ddd;
border-radius: 8px;
margin: 0.8rem 0;
overflow: hidden;
}

.collapsible-header {
padding: 1rem 1.2rem;
background: #e9ecef;
cursor: pointer;
font-weight: 600;
display: flex;
justify-content: space-between;
align-items: center;
transition: all 0.3s ease;
}

.collapsible-header:hover {
background: #dee2e6;
}

.collapsible-content {
padding: 0;
max-height: 0;
overflow: hidden;
transition: max-height 0.3s ease;
}

.collapsible-content.active {
padding: 1.2rem;
max-height: 2000px;
}

/* Enhanced Countdown */
.countdown {
font-size: 1.3rem;
font-weight: bold;
text-align: center;
margin: 1rem 0;
color: #6e8efb;
padding: 0.8rem;
background: #f8f9fa;
border-radius: 8px;
}

/* Enhanced Stats Grid */
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 12px;
margin: 1.2rem 0;
}

.stat-card {
background: white;
padding: 1rem;
border-radius: 8px;
text-align: center;
box-shadow: 0 3px 10px rgba(0,0,0,0.1);
transition: transform 0.3s ease;
}

.stat-card:hover {
transform: translateY(-2px);
}

.stat-number {
display: block;
font-size: 1.8rem;
font-weight: bold;
color: #6e8efb;
}

.stat-label {
font-size: 0.8rem;
color: #666;
margin-top: 0.3rem;
}

/* Enhanced Results Table */
.results-table {
margin-top: 1.2rem;
border: 1px solid #ddd;
border-radius: 8px;
overflow: auto;
max-height: 500px;
}

.result-header, .result-row {
display: grid;
grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 1fr;
gap: 1px;
padding: 0.8rem;
min-width: 800px;
}

.result-header {
background: #6e8efb;
color: white;
font-weight: bold;
position: sticky;
top: 0;
}

.result-row {
background: #f9f9f9;
border-bottom: 1px solid #eee;
transition: background 0.3s ease;
}

.result-row:hover {
background: #f0f0f0;
}

.result-row.correct {
background: #e8f5e9;
}

.result-row.incorrect {
background: #ffebee;
}

/* Enhanced Admin Controls */
.admin-controls {
display: flex;
gap: 8px;
margin-top: 0.8rem;
flex-wrap: wrap;
}

.admin-btn {
padding: 0.5rem 0.8rem;
font-size: 0.8rem;
border-radius: 4px;
}

.admin-btn.edit {
background: #ff9800;
}

.admin-btn.toggle {
background: #9c27b0;
}

.admin-btn.delete {
background: #f44336;
}

.admin-btn.view {
background: #2196f3;
}

/* Enhanced User Management */
.user-management {
background: #e8f5e9;
border-left: 4px solid #4caf50;
padding: 1rem;
margin: 1rem 0;
border-radius: 6px;
}

.user-list {
margin: 1rem 0;
max-height: 400px;
overflow-y: auto;
border: 1px solid #ddd;
border-radius: 6px;
padding: 1rem;
background: #f9f9f9;
}

.user-item {
padding: 0.8rem;
border-bottom: 1px solid #eee;
display: flex;
justify-content: space-between;
align-items: center;
transition: background 0.3s ease;
}

.user-item:hover {
background: #f0f0f0;
}

.user-item:last-child {
border-bottom: none;
}

/* Enhanced Quiz Models */
.quiz-model {
background: #f3e5f5;
border-left: 4px solid #9c27b0;
padding: 1rem;
margin: 1rem 0;
border-radius: 6px;
}

.model-item {
padding: 0.8rem;
border-bottom: 1px solid #eee;
display: flex;
justify-content: space-between;
align-items: center;
cursor: pointer;
transition: all 0.3s ease;
}

.model-item:hover {
background: #f3e5f5;
}

.model-item:last-child {
border-bottom: none;
}

/* Enhanced Question View Modal */
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
backdrop-filter: blur(5px);
}

.modal-content {
background-color: white;
margin: 5% auto;
padding: 2rem;
border-radius: 12px;
width: 90%;
max-width: 600px;
max-height: 80vh;
overflow-y: auto;
box-shadow: 0 10px 30px rgba(0,0,0,0.3);
animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
from { transform: translateY(-50px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 2px solid #f0f0f0;
}

.close-modal {
background: none;
border: none;
font-size: 1.5rem;
cursor: pointer;
color: #666;
padding: 0.5rem;
}

.close-modal:hover {
color: #333;
}

/* Enhanced Responsive Design */
@media (max-width: 768px) {
.container {
width: 100%;
margin: 10px;
border-radius: 8px;
}

.content {
padding: 1rem;
}

.answers-grid {
grid-template-columns: 1fr;
gap: 10px;
}

.quick-actions {
grid-template-columns: 1fr;
}

.tab {
padding: 0.8rem 1rem;
min-width: 100px;
font-size: 0.85rem;
}

.result-header, .result-row {
grid-template-columns: 1fr;
font-size: 0.8rem;
min-width: auto;
padding: 0.6rem;
}

.stats-grid {
grid-template-columns: repeat(2, 1fr);
}

.admin-controls {
flex-direction: column;
}

.modal-content {
margin: 10% auto;
padding: 1.5rem;
width: 95%;
}
}

@media (max-width: 480px) {
body {
padding: 10px;
}

header {
padding: 0.8rem;
}

h1 {
font-size: 1.5rem;
}

.quiz-timer {
position: static;
margin-top: 10px;
display: inline-block;
}

.card {
padding: 1rem;
margin: 0.8rem 0;
}
}

/* Print Styles */
@media print {
.tabs, .quick-actions, button {
display: none !important;
}

.tab-content {
display: block !important;
}

.container {
box-shadow: none;
border-radius: 0;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>Kahoot FS</h1>
<p class="subtitle">Enhanced Quiz Platform with All Features</p>
<div class="quiz-timer" id="quiz-timer">Quiz: Not started</div>
</header>

<div class="tabs">
<div class="tab active" onclick="switchTab('player')">Player</div>
<div class="tab" onclick="switchTab('host')">Host</div>
<div class="tab" onclick="switchTab('results')">Results</div>
<div class="tab" onclick="switchTab('models')">Quiz Models</div>
</div>

<div class="content">
<!-- Player Tab -->
<div id="player" class="tab-content active">
<h2>Join Quiz</h2>
<div class="compact-section" id="quiz-time-info">
<p><strong id="quiz-time-range">Tomorrow from 12:00 PM to 12:30 PM</strong></p>
<p>Status: <span id="quiz-status-text">Not started</span></p>
</div>

<div class="card">
<input id="player-code" placeholder="Enter your access code">
<button id="joinBtn">Join Game</button>

<div id="player-question"></div>
<div id="countdown" class="countdown"></div>
<div id="player-answers"></div>
</div>

<div class="collapsible">
<div class="collapsible-header" onclick="toggleCollapsible('player-instructions')">
📋 Player Instructions
<span>▼</span>
</div>
<div id="player-instructions" class="collapsible-content">
<ol>
<li>Enter your access code and click "Join Game"</li>
<li>Wait for the host to start the quiz</li>
<li>Select your answer when questions appear</li>
<li>Your answers and response time will be recorded</li>
<li>Each device has separate session - codes won't conflict</li>
<li>View your results and download them at the end</li>
<li><strong>Note:</strong> You can only complete the quiz once per session</li>
</ol>
</div>
</div>
</div>

<!-- Host Tab -->
<div id="host" class="tab-content">
<h2>Quiz Host (Admin)</h2>

<div class="compact-section">
<h3>🔐 Admin Access</h3>
<input type="password" id="admin-code" placeholder="Enter admin code">
<button onclick="verifyAdmin()">Access Admin Features</button>
<div id="admin-status" class="url-status">Enter the admin code to access host features</div>
</div>

<div id="admin-features" style="display: none;">
<div class="quick-actions">
<div class="quick-action-btn" onclick="scrollToSection('active-model')">Active Model</div>
<div class="quick-action-btn" onclick="scrollToSection('users')">Users</div>
<div class="quick-action-btn" onclick="scrollToSection('questions')">Questions</div>
<div class="quick-action-btn" onclick="scrollToSection('time')">Time Settings</div>
<div class="quick-action-btn" onclick="loadQuizResults()">View Results</div>
</div>

<!-- Active Model Display -->
<div class="compact-section" id="active-model">
<h3>🎯 Active Quiz Model</h3>
<p id="active-model-info">No model selected. Players will see all questions.</p>
<button onclick="clearActiveModel()" class="admin-btn" style="background: #ff9800;">Clear Selection</button>
</div>

<!-- User Management -->
<div class="user-management" id="users">
<h3>👥 User Management</h3>
<input type="text" id="user-name" placeholder="User's real name">
<input type="text" id="user-code" placeholder="Unique access code">
<button onclick="addUser()">Add User</button>
<div id="user-status" class="url-status">Add users with unique access codes</div>

<div class="user-list">
<h4>Current Users</h4>
<div id="users-container"></div>
</div>
</div>

<!-- Question Management -->
<div class="compact-section" id="questions">
<h3>❓ Question Management</h3>

<select id="question-model">
<option value="">-- Select a Model --</option>
</select>
<textarea id="question-text" placeholder="Enter your question"></textarea>

<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
<input type="text" id="answer-1" placeholder="Enter answer 1">
<input type="radio" name="correct-answer" value="0" checked> Correct
</div>
<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
<input type="text" id="answer-2" placeholder="Enter answer 2">
<input type="radio" name="correct-answer" value="1"> Correct
</div>
<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
<input type="text" id="answer-3" placeholder="Enter answer 3">
<input type="radio" name="correct-answer" value="2"> Correct
</div>
<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
<input type="text" id="answer-4" placeholder="Enter answer 4">
<input type="radio" name="correct-answer" value="3"> Correct
</div>

<button onclick="addQuestion()">Add Question</button>
<div id="question-status" class="url-status">Add a new question to the quiz</div>

<div class="collapsible">
<div class="collapsible-header" onclick="toggleCollapsible('questions-list-content')">
📝 Current Questions
<span>▼</span>
</div>
<div id="questions-list-content" class="collapsible-content">
<div id="questions-container"></div>
</div>
</div>
</div>

<!-- Time Settings -->
<div class="compact-section" id="time">
<h3>⏰ Quiz Timing Configuration</h3>
<input type="datetime-local" id="quiz-start-time">
<input type="number" id="quiz-duration" placeholder="Duration (minutes)" value="30" min="5" max="240">
<button onclick="saveQuizTime()">Save Quiz Time</button>
<div id="host-time-status" class="url-status">Configure when your quiz will be active</div>
</div>

<!-- Password Change -->
<div class="compact-section">
<h3>🔑 Change Admin Password</h3>
<input type="password" id="current-password" placeholder="Current password">
<input type="password" id="new-password" placeholder="New password">
<input type="password" id="confirm-password" placeholder="Confirm new password">
<button onclick="changeAdminPassword()">Change Password</button>
<div id="password-status" class="url-status">Change your admin password here</div>
</div>
</div>
</div>

<!-- Results Tab -->
<div id="results" class="tab-content">
<h2>📊 Quiz Results</h2>

<div class="quick-actions">
<div class="quick-action-btn" onclick="exportToExcel()">📈 Export to Excel</div>
<div class="quick-action-btn" onclick="downloadAllUserResults()">📥 Download All Users</div>
<div class="quick-action-btn" onclick="loadQuizResults()" style="background: #4caf50;">🔄 Refresh Results</div>
<div class="quick-action-btn" onclick="confirmDeleteResults()" style="background: #f44336;">🗑️ Delete All</div>
</div>

<div class="compact-section">
<h3>📈 Statistics Overview</h3>
<div id="stats-container"></div>
</div>

<div class="collapsible">
<div class="collapsible-header" onclick="toggleCollapsible('results-content')">
📋 Detailed Results
<span>▼</span>
</div>
<div id="results-content" class="collapsible-content">
<div id="results-container"></div>
</div>
</div>

<div class="collapsible">
<div class="collapsible-header" onclick="toggleCollapsible('user-results-content')">
👤 Individual User Results
<span>▼</span>
</div>
<div id="user-results-content" class="collapsible-content">
<div id="user-results-container"></div>
</div>
</div>
</div>

<!-- Quiz Models Tab -->
<div id="models" class="tab-content">
<h2>📚 Quiz Models Management</h2>

<div class="quiz-model">
<h3>🎯 Create New Model</h3>
<input type="text" id="model-name" placeholder="Enter model name">
<button onclick="addQuizModel()">Create New Model</button>
<div id="model-status" class="url-status">Create quiz models to organize questions</div>

<div class="collapsible">
<div class="collapsible-header" onclick="toggleCollapsible('models-content')">
📁 Current Models
<span>▼</span>
</div>
<div id="models-content" class="collapsible-content">
<div id="models-container"></div>
</div>
</div>

<div class="compact-section" style="background: #fff3cd; border-left-color: #ff9800;">
<h3>🔧 Model Recovery Tools</h3>
<button onclick="recoverMissingModels()" class="admin-btn" style="background: #ff9800;">Recover Missing Models</button>
<button onclick="validateAllModels()" class="admin-btn" style="background: #2196f3;">Validate All Models</button>
<button onclick="debugModelQuestions()" class="admin-btn" style="background: #607d8b;">Debug Models</button>
</div>
</div>
</div>
</div>
</div>

<!-- Question View Modal -->
<div id="questionViewModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>👁️ View Question</h3>
<button class="close-modal" onclick="closeQuestionView()">&times;</button>
</div>
<div id="question-view-content">
<!-- Question content will be loaded here -->
</div>
</div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyDnt-BAUsCbQMZ-PPALhp3_tsYqcHAKEZ8",
authDomain: "thequizfs.firebaseapp.com",
databaseURL: "https://thequizfs-default-rtdb.firebaseio.com",
projectId: "thequizfs",
storageBucket: "thequizfs.firebasestorage.app",
messagingSenderId: "16144411406",
appId: "1:16144411406:web:d83affb2013dea665e055f",
measurementId: "G-NXX4GQZ4NF"
};

// Initialize Firebase
let app;
try {
app = firebase.initializeApp(firebaseConfig);
} catch (error) {
if (error.code === 'app/duplicate-app') {
app = firebase.app();
}
}
const database = firebase.database();

// Global variables
let questions = [];
let users = [];
let quizModels = [];
let adminCode = "adminHafsa";
let currentIndex = 0;
let playerCode = "";
let countdownInterval;
let timeLeft = 15;
let questionStartTime;
let quizActive = false;
let currentModelFilter = null;
let activeQuizModel = null;
let quizStartTime, quizEndTime;

// Player results
let playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};

// Enhanced data persistence with better error handling
function initializeQuizTime() {
const savedStartTime = localStorage.getItem('quizStartTime');
const savedEndTime = localStorage.getItem('quizEndTime');

if (savedStartTime && savedEndTime) {
quizStartTime = parseInt(savedStartTime);
quizEndTime = parseInt(savedEndTime);
} else {
const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
tomorrow.setHours(12, 0, 0, 0);
quizStartTime = tomorrow.getTime();
quizEndTime = quizStartTime + (30 * 60000);
localStorage.setItem('quizStartTime', quizStartTime);
localStorage.setItem('quizEndTime', quizEndTime);
}
}

// Enhanced data loading with better error handling
function loadDataFromFirebase() {
console.log("Loading data from Firebase...");

// Load admin password first
database.ref('adminPassword').on('value', (snapshot) => {
const savedPassword = snapshot.val();
if (savedPassword) {
adminCode = savedPassword;
console.log("Admin password loaded from Firebase");
}
}, (error) => {
console.error("Error loading admin password:", error);
});

// Load quiz time
database.ref('quizTime').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
quizStartTime = data.startTime;
quizEndTime = data.endTime;
localStorage.setItem('quizStartTime', quizStartTime);
localStorage.setItem('quizEndTime', quizEndTime);
updateQuizTimeInfo();
}
}, (error) => {
console.error("Error loading quiz time:", error);
});

// Load questions with enhanced error handling
database.ref('questions').on('value', (snapshot) => {
try {
const data = snapshot.val();
questions = data ? Object.values(data) : [];
localStorage.setItem('quizQuestions', JSON.stringify(questions));
displayQuestions();

if (document.getElementById('player').classList.contains('active') &&
document.getElementById('player-question').innerHTML !== "") {
showPlayerQuestion();
}
} catch (error) {
console.error("Error processing questions:", error);
}
}, (error) => {
console.error("Error loading questions:", error);
});

// Load users
database.ref('users').on('value', (snapshot) => {
try {
const data = snapshot.val();
users = data ? Object.values(data) : [];
localStorage.setItem('quizUsers', JSON.stringify(users));
if (document.getElementById('host').classList.contains('active')) {
displayUsers();
}
} catch (error) {
console.error("Error processing users:", error);
}
});

// Load quiz models
database.ref('quizModels').on('value', (snapshot) => {
try {
const data = snapshot.val();
quizModels = data ? Object.values(data) : [];
localStorage.setItem('quizModels', JSON.stringify(quizModels));
if (document.getElementById('host').classList.contains('active') ||
document.getElementById('models').classList.contains('active')) {
displayQuizModels();
updateModelDropdown();
}
} catch (error) {
console.error("Error processing quiz models:", error);
}
});

// Load active quiz model
database.ref('activeQuizModel').on('value', (snapshot) => {
try {
const data = snapshot.val();
activeQuizModel = data;
updateActiveModelDisplay();
} catch (error) {
console.error("Error loading active model:", error);
}
});
}

// Enhanced save functions with retry logic
function saveQuestionsToFirebase() {
const maxRetries = 3;
let retries = 0;

function attemptSave() {
database.ref('questions').set(questions)
.then(() => {
console.log("Questions saved successfully");
if (document.getElementById('question-status')) {
document.getElementById('question-status').textContent = 'Questions saved successfully!';
document.getElementById('question-status').className = 'url-status success';
}
})
.catch((error) => {
console.error("Save error:", error);
retries++;
if (retries < maxRetries) {
setTimeout(attemptSave, 1000 * retries);
} else {
if (document.getElementById('question-status')) {
document.getElementById('question-status').textContent = 'Error saving questions. Please check connection.';
document.getElementById('question-status').className = 'url-status error';
}
}
});
}

attemptSave();
}

function saveUsersToFirebase() {
database.ref('users').set(users)
.then(() => {
console.log("Users saved successfully");
if (document.getElementById('user-status')) {
document.getElementById('user-status').textContent = 'Users saved successfully!';
document.getElementById('user-status').className = 'url-status success';
}
})
.catch((error) => {
console.error("Error saving users:", error);
});
}

function saveQuizModelsToFirebase() {
database.ref('quizModels').set(quizModels)
.then(() => {
console.log("Models saved successfully");
if (document.getElementById('model-status')) {
document.getElementById('model-status').textContent = 'Models saved successfully!';
document.getElementById('model-status').className = 'url-status success';
}
})
.catch((error) => {
console.error("Error saving models:", error);
});
}

function saveQuizTimeToFirebase() {
database.ref('quizTime').set({
startTime: quizStartTime,
endTime: quizEndTime
}).then(() => {
if (document.getElementById('host-time-status')) {
document.getElementById('host-time-status').textContent = 'Quiz time saved successfully!';
document.getElementById('host-time-status').className = 'url-status success';
}
}).catch((error) => {
console.error("Error saving quiz time:", error);
});
}

function saveActiveQuizModel(modelId) {
database.ref('activeQuizModel').set(modelId)
.then(() => {
console.log("Active quiz model saved to Firebase");
})
.catch((error) => {
console.error("Error saving active quiz model:", error);
});
}

function saveAdminPasswordToFirebase(newPassword) {
database.ref('adminPassword').set(newPassword)
.then(() => {
console.log("Admin password saved to Firebase");
})
.catch((error) => {
console.error("Error saving admin password:", error);
});
}

// Enhanced session management
function getSessionId() {
let sessionId = sessionStorage.getItem('playerSessionId');
if (!sessionId) {
sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
sessionStorage.setItem('playerSessionId', sessionId);
}
return sessionId;
}

// Tab management
function switchTab(tabName) {
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
document.getElementById(tabName).classList.add('active');

document.querySelectorAll('.tab').forEach(tab => {
tab.classList.remove('active');
});
event.target.classList.add('active');

if (tabName === 'host' || tabName === 'models') {
loadHostTimeSettings();
loadUsers();
loadQuizModels();
updateActiveModelDisplay();
} else if (tabName === 'results') {
loadQuizResults();
}
}

// Enhanced collapsible sections
function toggleCollapsible(id) {
const content = document.getElementById(id);
const header = content.previousElementSibling;
const arrow = header.querySelector('span');

content.classList.toggle('active');
arrow.textContent = content.classList.contains('active') ? '▲' : '▼';
}

// Quick navigation
function scrollToSection(sectionId) {
const element = document.getElementById(sectionId);
if (element) {
element.scrollIntoView({ behavior: 'smooth' });

// Auto-expand if it's a collapsible section
const content = document.getElementById(sectionId + '-content');
if (content && !content.classList.contains('active')) {
toggleCollapsible(sectionId + '-content');
}
}
}

// Enhanced user management
function addUser() {
const userName = document.getElementById('user-name').value.trim();
const userCode = document.getElementById('user-code').value.trim();

if (!userName || !userCode) {
document.getElementById('user-status').textContent = 'Please fill in all fields';
document.getElementById('user-status').className = 'url-status error';
return;
}

if (users.some(u => u.code === userCode)) {
document.getElementById('user-status').textContent = 'This access code is already in use';
document.getElementById('user-status').className = 'url-status error';
return;
}

const newUser = {
name: userName,
code: userCode,
active: true,
createdAt: new Date().toISOString()
};

users.push(newUser);
saveUsersToFirebase();

document.getElementById('user-status').textContent = 'User added successfully!';
document.getElementById('user-status').className = 'url-status success';

document.getElementById('user-name').value = '';
document.getElementById('user-code').value = '';

setTimeout(() => {
document.getElementById('user-status').textContent = 'Add users with unique access codes';
document.getElementById('user-status').className = 'url-status';
}, 3000);
}

function displayUsers() {
const container = document.getElementById('users-container');
if (!container) return;

container.innerHTML = '';

if (users.length === 0) {
container.innerHTML = '<p>No users added yet.</p>';
return;
}

users.forEach((user, index) => {
const userItem = document.createElement('div');
userItem.className = 'user-item';

userItem.innerHTML = `
<div class="user-info">
<div class="user-name">${user.name}</div>
<div class="user-code">Access Code: ${user.code}</div>
</div>
<span class="user-status" style="background: ${user.active ? '#4caf50' : '#f44336'}; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">
${user.active ? 'ACTIVE' : 'INACTIVE'}
</span>
<div class="admin-controls">
<button class="admin-btn toggle" onclick="toggleUserStatus(${index})">
${user.active ? 'Deactivate' : 'Activate'}
</button>
<button class="admin-btn delete" onclick="deleteUser(${index})">Delete</button>
</div>
`;
container.appendChild(userItem);
});
}

function toggleUserStatus(index) {
users[index].active = !users[index].active;
saveUsersToFirebase();
displayUsers();
}

function deleteUser(index) {
if (confirm(`Are you sure you want to delete user: ${users[index].name}?`)) {
users.splice(index, 1);
saveUsersToFirebase();
displayUsers();
}
}

// Enhanced question management with VIEW feature
function addQuestion() {
const questionText = document.getElementById('question-text').value.trim();
const answer1 = document.getElementById('answer-1').value.trim();
const answer2 = document.getElementById('answer-2').value.trim();
const answer3 = document.getElementById('answer-3').value.trim();
const answer4 = document.getElementById('answer-4').value.trim();
const modelId = document.getElementById('question-model').value;

if (!questionText || !answer1 || !answer2 || !answer3 || !answer4) {
document.getElementById('question-status').textContent = 'Please fill in all fields';
document.getElementById('question-status').className = 'url-status error';
return;
}

if (!modelId) {
document.getElementById('question-status').textContent = 'Please select a model';
document.getElementById('question-status').className = 'url-status error';
return;
}

const selectedModel = quizModels.find(m => m.id === modelId);
if (!selectedModel) {
document.getElementById('question-status').textContent = 'Error: Selected model no longer exists. Please select a valid model.';
document.getElementById('question-status').className = 'url-status error';
displayQuizModels();
return;
}

const correctAnswerIndex = parseInt(document.querySelector('input[name="correct-answer"]:checked').value);
const answers = [answer1, answer2, answer3, answer4];
const correctAnswer = answers[correctAnswerIndex];

const newQuestion = {
question: questionText,
answers: answers,
correct: correctAnswer,
hidden: false,
modelId: modelId,
modelName: selectedModel.name,
timestamp: new Date().toISOString(),
questionId: 'q-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
};

questions.push(newQuestion);
saveQuestionsToFirebase();

document.getElementById('question-status').textContent = `Question added successfully to "${selectedModel.name}" model!`;
document.getElementById('question-status').className = 'url-status success';

// Clear form but keep model selection
document.getElementById('question-text').value = '';
document.getElementById('answer-1').value = '';
document.getElementById('answer-2').value = '';
document.getElementById('answer-3').value = '';
document.getElementById('answer-4').value = '';
document.querySelector('input[name="correct-answer"][value="0"]').checked = true;

displayQuestions();

setTimeout(() => {
document.getElementById('question-status').textContent = 'Add a new question to the quiz';
document.getElementById('question-status').className = 'url-status';
}, 4000);
}

function displayQuestions() {
const container = document.getElementById('questions-container');
if (!container) return;

container.innerHTML = '';

// Add "Show All" button when filtered
if (currentModelFilter) {
const showAllButton = document.createElement('button');
showAllButton.className = 'admin-btn';
showAllButton.textContent = 'Show All Questions';
showAllButton.onclick = showAllQuestions;
showAllButton.style.marginBottom = '1rem';
container.appendChild(showAllButton);
}

let filteredQuestions = questions;
if (currentModelFilter) {
filteredQuestions = questions.filter(q => q.modelId === currentModelFilter);
}

if (filteredQuestions.length === 0) {
container.innerHTML += '<p>No questions found.</p>';
return;
}

filteredQuestions.forEach((q, index) => {
const actualIndex = questions.findIndex(question => question === q);
const questionItem = document.createElement('div');
questionItem.className = `compact-section ${q.hidden ? 'hidden' : ''}`;
if (q.hidden) {
questionItem.style.opacity = '0.6';
questionItem.style.background = '#f5f5f5';
}

const correctIndex = q.answers.indexOf(q.correct);
const model = quizModels.find(m => m.id === q.modelId);
const modelName = model ? model.name : 'No Model';

questionItem.innerHTML = `
<strong>Q${index + 1}:</strong> ${q.question}
<span style="background: #6e8efb; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-left: 10px;">
${modelName}
</span>
<span style="background: ${q.hidden ? '#f44336' : '#4caf50'}; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-left: 5px;">
${q.hidden ? 'HIDDEN' : 'VISIBLE'}
</span>
<div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
Correct answer: ${q.correct} (Option ${correctIndex + 1})
</div>
<div class="admin-controls">
<button class="admin-btn view" onclick="viewQuestion(${actualIndex})">View</button>
<button class="admin-btn edit" onclick="editExistingQuestion(${actualIndex})">Edit</button>
<button class="admin-btn toggle" onclick="toggleQuestionVisibility(${actualIndex})">
${q.hidden ? 'Show' : 'Hide'}
</button>
<button class="admin-btn delete" onclick="deleteQuestion(${actualIndex})">Delete</button>
</div>
`;
container.appendChild(questionItem);
});
}

// NEW: View question function
function viewQuestion(index) {
const q = questions[index];
const correctIndex = q.answers.indexOf(q.correct);
const model = quizModels.find(m => m.id === q.modelId);
const modelName = model ? model.name : 'No Model';

const modalContent = document.getElementById('question-view-content');
modalContent.innerHTML = `
<div style="margin-bottom: 1.5rem;">
<h4 style="color: #6e8efb; margin-bottom: 0.5rem;">Question:</h4>
<p style="font-size: 1.1rem; background: #f8f9fa; padding: 1rem; border-radius: 6px;">${q.question}</p>
</div>

<div style="margin-bottom: 1.5rem;">
<h4 style="color: #6e8efb; margin-bottom: 0.5rem;">Answer Options:</h4>
<div style="display: grid; gap: 0.5rem;">
${q.answers.map((answer, i) => `
<div style="display: flex; align-items: center; padding: 0.8rem; background: ${i === correctIndex ? '#e8f5e9' : '#f8f9fa'}; border-radius: 6px; border-left: 4px solid ${i === correctIndex ? '#4caf50' : '#6e8efb'};">
<span style="font-weight: bold; margin-right: 1rem;">${i + 1}.</span>
<span>${answer}</span>
${i === correctIndex ? '<span style="margin-left: auto; background: #4caf50; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">CORRECT</span>' : ''}
</div>
`).join('')}
</div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
<div>
<h4 style="color: #6e8efb; margin-bottom: 0.5rem;">Model:</h4>
<p style="background: #f3e5f5; padding: 0.5rem; border-radius: 4px;">${modelName}</p>
</div>
<div>
<h4 style="color: #6e8efb; margin-bottom: 0.5rem;">Status:</h4>
<p style="background: ${q.hidden ? '#ffebee' : '#e8f5e9'}; padding: 0.5rem; border-radius: 4px;">
${q.hidden ? 'Hidden' : 'Visible'}
</p>
</div>
</div>

<div>
<h4 style="color: #6e8efb; margin-bottom: 0.5rem;">Created:</h4>
<p style="color: #666;">${new Date(q.timestamp).toLocaleString()}</p>
</div>
`;

document.getElementById('questionViewModal').style.display = 'block';
}

function closeQuestionView() {
document.getElementById('questionViewModal').style.display = 'none';
}

function editExistingQuestion(index) {
const q = questions[index];

document.getElementById('question-text').value = q.question;
document.getElementById('answer-1').value = q.answers[0];
document.getElementById('answer-2').value = q.answers[1];
document.getElementById('answer-3').value = q.answers[2];
document.getElementById('answer-4').value = q.answers[3];
document.getElementById('question-model').value = q.modelId || '';

const correctIndex = q.answers.indexOf(q.correct);
document.querySelectorAll('input[name="correct-answer"]').forEach((radio, i) => {
radio.checked = (i === correctIndex);
});

questions.splice(index, 1);
saveQuestionsToFirebase();

document.getElementById('question-status').textContent = 'Editing question. Update the fields above and click "Add Question" to save changes.';
document.getElementById('question-status').className = 'url-status success';

document.getElementById('question-text').scrollIntoView({ behavior: 'smooth' });
}

function toggleQuestionVisibility(index) {
questions[index].hidden = !questions[index].hidden;
saveQuestionsToFirebase();
displayQuestions();
}

function deleteQuestion(index) {
if (confirm('Are you sure you want to delete this question?')) {
questions.splice(index, 1);
saveQuestionsToFirebase();
displayQuestions();
}
}

function showAllQuestions() {
currentModelFilter = null;
displayQuestions();
}

// Enhanced quiz models management
function addQuizModel() {
const modelName = document.getElementById('model-name').value.trim();

if (!modelName) {
document.getElementById('model-status').textContent = 'Please enter a model name';
document.getElementById('model-status').className = 'url-status error';
return;
}

if (quizModels.some(m => m.name.toLowerCase() === modelName.toLowerCase())) {
document.getElementById('model-status').textContent = 'Model name already exists';
document.getElementById('model-status').className = 'url-status error';
return;
}

const newModel = {
id: 'model-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
name: modelName,
createdAt: new Date().toISOString()
};

quizModels.push(newModel);
saveQuizModelsToFirebase();

document.getElementById('model-status').textContent = 'Model created successfully!';
document.getElementById('model-status').className = 'url-status success';

document.getElementById('model-name').value = '';

setTimeout(() => {
document.getElementById('model-status').textContent = 'Create quiz models to organize questions';
document.getElementById('model-status').className = 'url-status';
}, 3000);
}

function displayQuizModels() {
const container = document.getElementById('models-container');
const modelSelect = document.getElementById('question-model');

if (container) {
container.innerHTML = '';
}
if (modelSelect) {
modelSelect.innerHTML = '<option value="">-- Select a Model --</option>';
}

if (quizModels.length === 0) {
if (container) {
container.innerHTML = '<p>No models created yet.</p>';
}
return;
}

quizModels.forEach((model, index) => {
const questionCount = questions.filter(q => q.modelId === model.id).length;
const isActive = activeQuizModel === model.id;

// Add to models container
if (container) {
const modelItem = document.createElement('div');
modelItem.className = 'model-item';
modelItem.onclick = function() {
filterQuestionsByModel(model.id);
};

modelItem.innerHTML = `
<div class="model-info">
<div class="model-name" style="font-weight: bold; font-size: 1.1rem;">
${model.name} ${isActive ? '⭐' : ''}
</div>
<div class="model-count" style="font-size: 0.9rem; color: #666;">
${questionCount} questions | Created: ${new Date(model.createdAt).toLocaleDateString()}
</div>
</div>
<div class="admin-controls">
${isActive ?
`<button class="admin-btn" style="background: #ff9800;" onclick="event.stopPropagation(); deselectQuizModel()">Deselect</button>` :
`<button class="admin-btn" style="background: #4caf50;" onclick="event.stopPropagation(); selectQuizModel('${model.id}')">Select</button>`
}
<button class="admin-btn delete" onclick="event.stopPropagation(); deleteQuizModel(${index})">Delete</button>
</div>
`;
container.appendChild(modelItem);
}

// Add to model select dropdown
if (modelSelect) {
const option = document.createElement('option');
option.value = model.id;
option.textContent = model.name;
modelSelect.appendChild(option);
}
});
}

function updateModelDropdown() {
const modelSelect = document.getElementById('question-model');
if (!modelSelect) return;

modelSelect.innerHTML = '<option value="">-- Select a Model --</option>';
quizModels.forEach(model => {
const option = document.createElement('option');
option.value = model.id;
option.textContent = model.name;
modelSelect.appendChild(option);
});
}

function selectQuizModel(modelId) {
activeQuizModel = modelId;
saveActiveQuizModel(modelId);

const model = quizModels.find(m => m.id === modelId);
const modelName = model ? model.name : 'Unknown Model';

if (document.getElementById('model-status')) {
document.getElementById('model-status').textContent = `"${modelName}" is now the active quiz model. Players will only see questions from this model.`;
document.getElementById('model-status').className = 'url-status success';
}

displayQuizModels();
updateActiveModelDisplay();

setTimeout(() => {
if (document.getElementById('model-status')) {
document.getElementById('model-status').textContent = 'Create quiz models to organize questions';
document.getElementById('model-status').className = 'url-status';
}
}, 5000);
}

function deselectQuizModel() {
activeQuizModel = null;
saveActiveQuizModel(null);

if (document.getElementById('model-status')) {
document.getElementById('model-status').textContent = 'Model deselected. Players will see all questions.';
document.getElementById('model-status').className = 'url-status success';
}

displayQuizModels();
updateActiveModelDisplay();

setTimeout(() => {
if (document.getElementById('model-status')) {
document.getElementById('model-status').textContent = 'Create quiz models to organize questions';
document.getElementById('model-status').className = 'url-status';
}
}, 5000);
}

function filterQuestionsByModel(modelId) {
currentModelFilter = modelId;
displayQuestions();
}

function deleteQuizModel(index) {
const model = quizModels[index];
const modelQuestions = questions.filter(q => q.modelId === model.id);

if (modelQuestions.length > 0) {
if (!confirm(`This model has ${modelQuestions.length} questions. Deleting it will remove the model association from these questions. Are you sure you want to delete this model?`)) {
return;
}

questions.forEach(question => {
if (question.modelId === model.id) {
question.modelId = null;
question.modelName = null;
}
});
saveQuestionsToFirebase();
}

if (activeQuizModel === model.id) {
activeQuizModel = null;
saveActiveQuizModel(null);
}

quizModels.splice(index, 1);
saveQuizModelsToFirebase();
displayQuizModels();

if (currentModelFilter === model.id) {
showAllQuestions();
}
}

function updateActiveModelDisplay() {
const activeModelInfo = document.getElementById('active-model-info');
if (!activeModelInfo) return;

if (activeQuizModel) {
const model = quizModels.find(m => m.id === activeQuizModel);
const modelName = model ? model.name : 'Unknown Model';
const questionCount = questions.filter(q => q.modelId === activeQuizModel).length;

activeModelInfo.innerHTML = `
<strong>${modelName}</strong> - ${questionCount} questions
<br><small style="color: #666;">Players will only see questions from this model</small>
`;
} else {
activeModelInfo.innerHTML = `
<strong>No model selected</strong>
<br><small style="color: #666;">Players will see all questions from all models</small>
`;
}
}

function clearActiveModel() {
activeQuizModel = null;
saveActiveQuizModel(null);
updateActiveModelDisplay();
displayQuizModels();

if (document.getElementById('model-status')) {
document.getElementById('model-status').textContent = 'Active model cleared. Players will see all questions.';
document.getElementById('model-status').className = 'url-status success';
}
}

// Model recovery tools
function recoverMissingModels() {
let recoveredCount = 0;
let assignedToDefault = 0;

questions.forEach(question => {
if (!question.modelId || question.modelId === "No Model" || !quizModels.find(m => m.id === question.modelId)) {
if (question.modelName && quizModels.length > 0) {
const model = quizModels.find(m => m.name === question.modelName);
if (model) {
question.modelId = model.id;
recoveredCount++;
return;
}
}

if (quizModels.length > 0) {
const firstModel = quizModels[0];
question.modelId = firstModel.id;
question.modelName = firstModel.name;
assignedToDefault++;
}
}
});

if (recoveredCount > 0 || assignedToDefault > 0) {
saveQuestionsToFirebase();
displayQuestions();
let message = '';
if (recoveredCount > 0) message += `Recovered ${recoveredCount} questions with missing model associations! `;
if (assignedToDefault > 0) message += `Assigned ${assignedToDefault} questions to default model.`;
alert(message);
} else {
alert('No questions with missing models found.');
}
}

function validateAllModels() {
let issuesFound = 0;

questions.forEach((question, index) => {
if (!question.modelId || !quizModels.find(m => m.id === question.modelId)) {
console.warn(`Question ${index} has missing model:`, question);
issuesFound++;
}
});

quizModels.forEach(model => {
const modelQuestions = questions.filter(q => q.modelId === model.id);
if (modelQuestions.length === 0) {
console.warn(`Model "${model.name}" has no questions`);
issuesFound++;
}
});

if (issuesFound === 0) {
alert('✅ All models and questions are properly linked!');
} else {
alert(`Found ${issuesFound} model-question linking issues. Check console for details.`);
}
}

function debugModelQuestions() {
console.log("=== DEBUG: Models and Questions ===");
console.log("Total models:", quizModels.length);
console.log("Total questions:", questions.length);

quizModels.forEach(model => {
const modelQuestions = questions.filter(q => q.modelId === model.id);
console.log(`Model "${model.name}" (${model.id}): ${modelQuestions.length} questions`);
});

const orphanedQuestions = questions.filter(q => !q.modelId || !quizModels.find(m => m.id === q.modelId));
console.log("Orphaned questions (no valid model):", orphanedQuestions.length);

alert(`Debug complete. Check console for details.\nTotal models: ${quizModels.length}\nTotal questions: ${questions.length}\nOrphaned questions: ${orphanedQuestions.length}`);
}

// Enhanced quiz timing
function loadHostTimeSettings() {
const quizDate = new Date(quizStartTime);
const startTimeInput = document.getElementById('quiz-start-time');
if (startTimeInput) {
startTimeInput.value = quizDate.toISOString().slice(0, 16);
}

const durationInput = document.getElementById('quiz-duration');
if (durationInput) {
const duration = Math.round((quizEndTime - quizStartTime) / 60000);
durationInput.value = duration;
}

displayQuestions();
displayUsers();
displayQuizModels();
}

function saveQuizTime() {
const startTimeInput = document.getElementById('quiz-start-time');
const durationInput = document.getElementById('quiz-duration');

if (!startTimeInput || !durationInput) return;

const startTime = new Date(startTimeInput.value).getTime();
const duration = parseInt(durationInput.value) * 60000;

if (isNaN(startTime) || isNaN(duration)) {
if (document.getElementById('host-time-status')) {
document.getElementById('host-time-status').textContent = 'Please enter valid time values';
document.getElementById('host-time-status').className = 'url-status error';
}
return;
}

quizStartTime = startTime;
quizEndTime = startTime + duration;

saveQuizTimeToFirebase();
updateQuizTimeInfo();

if (document.getElementById('host-time-status')) {
document.getElementById('host-time-status').textContent = 'Quiz time saved successfully!';
document.getElementById('host-time-status').className = 'url-status success';
}

setTimeout(() => {
if (document.getElementById('host-time-status')) {
document.getElementById('host-time-status').textContent = 'Configure when your quiz will be active';
document.getElementById('host-time-status').className = 'url-status';
}
}, 3000);
}

function updateQuizTimeInfo() {
const start = new Date(quizStartTime);
const end = new Date(quizEndTime);
const now = new Date().getTime();

const timeRangeElement = document.getElementById('quiz-time-range');
const statusElement = document.getElementById('quiz-status-text');
const timerElement = document.getElementById('quiz-timer');

if (timeRangeElement) {
timeRangeElement.textContent =
`${start.toLocaleDateString()} ${start.toLocaleTimeString()} - ${end.toLocaleTimeString()}`;
}

if (now < quizStartTime) {
const timeUntilStart = Math.floor((quizStartTime - now) / 1000);
const hours = Math.floor(timeUntilStart / 3600);
const minutes = Math.floor((timeUntilStart % 3600) / 60);
const seconds = timeUntilStart % 60;

if (timerElement) timerElement.textContent = `Starts in: ${hours}h ${minutes}m ${seconds}s`;
if (statusElement) {
statusElement.textContent = 'Not started';
statusElement.style.color = '#ff9800';
}
quizActive = false;
} else if (now >= quizStartTime && now <= quizEndTime) {
const timeLeft = Math.floor((quizEndTime - now) / 1000);
const minutes = Math.floor(timeLeft / 60);
const seconds = timeLeft % 60;

if (timerElement) timerElement.textContent = `Time left: ${minutes}m ${seconds}s`;
if (statusElement) {
statusElement.textContent = 'Active';
statusElement.style.color = '#4caf50';
}
quizActive = true;
} else {
if (timerElement) timerElement.textContent = 'Quiz ended';
if (statusElement) {
statusElement.textContent = 'Ended';
statusElement.style.color = '#f44336';
}
quizActive = false;
}
}

// Enhanced admin functions
function verifyAdmin() {
const code = document.getElementById('admin-code').value;
const status = document.getElementById('admin-status');

document.getElementById('admin-code').value = '';

if (code === adminCode) {
document.getElementById('admin-features').style.display = 'block';
status.textContent = 'Admin access granted! Features unlocked.';
status.className = 'url-status success';
loadQuizResults();

document.querySelector('.compact-section:first-child').style.display = 'none';
} else {
status.textContent = 'Invalid admin code. Please try again.';
status.className = 'url-status error';
}
}

function changeAdminPassword() {
const currentPassword = document.getElementById('current-password').value;
const newPassword = document.getElementById('new-password').value;
const confirmPassword = document.getElementById('confirm-password').value;
const status = document.getElementById('password-status');

if (currentPassword !== adminCode) {
status.textContent = 'Current password is incorrect.';
status.className = 'url-status error';
return;
}

if (newPassword !== confirmPassword) {
status.textContent = 'New passwords do not match.';
status.className = 'url-status error';
return;
}

if (newPassword.length < 4) {
status.textContent = 'New password must be at least 4 characters long.';
status.className = 'url-status error';
return;
}

adminCode = newPassword;
saveAdminPasswordToFirebase(newPassword);

status.textContent = 'Password changed successfully!';
status.className = 'url-status success';

document.getElementById('current-password').value = '';
document.getElementById('new-password').value = '';
document.getElementById('confirm-password').value = '';
}

// Enhanced player quiz functions with accurate timing
document.getElementById('joinBtn').onclick = function() {
if (!quizActive) {
alert("The quiz is not currently active. Please check the quiz schedule.");
return;
}

// Check if already completed
if (sessionStorage.getItem('quizCompleted') === 'true') {
alert("You have already completed this quiz. You cannot retake it.");
return;
}

playerCode = document.getElementById("player-code").value.trim();
const user = users.find(u => u.code === playerCode);

if (!user) {
alert("Invalid access code. Please check your code and try again.");
return;
}

if (!user.active) {
alert("Your account is inactive. Please contact the quiz administrator.");
return;
}

// Mark quiz as started
sessionStorage.setItem('quizStarted', 'true');
sessionStorage.setItem('playerCode', playerCode);

// Reset results when starting new quiz
playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};

// Restore progress if exists
const savedProgress = sessionStorage.getItem('quizProgress');
if (savedProgress) {
const progress = JSON.parse(savedProgress);
currentIndex = progress.currentIndex || 0;
playerResults = progress.playerResults || playerResults;
} else {
currentIndex = 0;
}

document.getElementById("player-code").style.display = "none";
document.getElementById("joinBtn").style.display = "none";
showPlayerQuestion();
};

function showPlayerQuestion() {
const visibleQuestions = getVisibleQuestions();

if (currentIndex >= visibleQuestions.length) {
showPlayerResults();
return;
}

const q = visibleQuestions[currentIndex];
document.getElementById('player-question').innerHTML = `
<h3>Question ${currentIndex + 1} of ${visibleQuestions.length}</h3>
<p style="font-size: 1.2rem; line-height: 1.5;">${q.question}</p>
`;

const answersDiv = document.getElementById('player-answers');
answersDiv.innerHTML = '<h4>Select your answer:</h4>';

const grid = document.createElement('div');
grid.className = 'answers-grid';

questionStartTime = Date.now();

q.answers.forEach(answer => {
const btn = document.createElement('button');
btn.className = 'answer-btn';
btn.innerHTML = answer;
btn.onclick = function() {
handleAnswerSelection(answer, q.correct, q.modelId);
};
grid.appendChild(btn);
});

answersDiv.appendChild(grid);
startCountdown();
}

function handleAnswerSelection(selected, correct, modelId) {
const responseTime = (Date.now() - questionStartTime) / 1000; // Actual thinking time only
clearInterval(countdownInterval);

// INSTANT COLOR FEEDBACK
const allButtons = document.querySelectorAll('.answer-btn');
allButtons.forEach(button => {
button.disabled = true;
button.style.pointerEvents = 'none';

button.classList.remove('correct', 'incorrect', 'other-option');

if (button.innerHTML === correct) {
button.classList.add('correct');
} else if (button.innerHTML === selected) {
button.classList.add('incorrect');
} else {
button.classList.add('other-option');
}
});

// TRACK RESULTS - Response time does NOT include the 2-second delay
const isCorrect = selected === correct;
if (isCorrect) {
playerResults.correct++;
} else {
playerResults.incorrect++;
}
playerResults.total++;
playerResults.responseTimes.push(responseTime); // Only actual thinking time
playerResults.accuracy = (playerResults.correct / playerResults.total) * 100;

// Save to Firebase
const user = users.find(u => u.code === playerCode);
saveToFirebase(playerCode, user.name, questions[currentIndex].question, selected, correct, responseTime, "Answered", modelId);
saveQuizProgress();

// Move to next question after 2 seconds (this delay is NOT counted in response time)
setTimeout(() => {
currentIndex++;
showPlayerQuestion();
}, 2000);
}

function getVisibleQuestions() {
let visibleQuestions = questions.filter(q => !q.hidden);

if (activeQuizModel) {
visibleQuestions = visibleQuestions.filter(q => q.modelId === activeQuizModel);
}

return visibleQuestions;
}

function startCountdown() {
timeLeft = 15;
document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

clearInterval(countdownInterval);
countdownInterval = setInterval(() => {
timeLeft--;
document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

if (timeLeft <= 0) {
clearInterval(countdownInterval);
handleTimeout();
}
}, 1000);
}

function handleTimeout() {
const visibleQuestions = getVisibleQuestions();
const q = visibleQuestions[currentIndex];
const responseTime = 15; // Maximum time
const user = users.find(u => u.code === playerCode);

saveToFirebase(playerCode, user.name, q.question, "No Answer", q.correct, responseTime, "Timeout", q.modelId);

playerResults.incorrect++;
playerResults.total++;
playerResults.responseTimes.push(responseTime);
playerResults.accuracy = (playerResults.correct / playerResults.total) * 100;

saveQuizProgress();

// Move to next question after 2 seconds
setTimeout(() => {
currentIndex++;
showPlayerQuestion();
}, 2000);
}

function saveQuizProgress() {
const progress = {
currentIndex: currentIndex,
playerResults: playerResults,
timestamp: Date.now()
};
sessionStorage.setItem('quizProgress', JSON.stringify(progress));
}

function showPlayerResults() {
sessionStorage.setItem('quizCompleted', 'true');
sessionStorage.removeItem('quizProgress');

const avgResponseTime = playerResults.responseTimes.length > 0 ?
(playerResults.responseTimes.reduce((a, b) => a + b, 0) / playerResults.responseTimes.length).toFixed(2) : 0;

const user = users.find(u => u.code === playerCode);
const passFail = playerResults.accuracy >= 50 ? 'PASS' : 'FAIL';

document.getElementById('player-question').innerHTML = `
<div style="text-align: center; padding: 2rem;">
<h2 style="color: #6e8efb; margin-bottom: 1rem;">🎉 Quiz Completed! 🎉</h2>
<p style="font-size: 1.2rem; margin-bottom: 2rem;">Thank you for participating, <strong>${user.name}</strong>!</p>

<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin: 2rem 0;">
<div style="background: #e8f5e9; padding: 1.5rem; border-radius: 10px; text-align: center;">
<div style="font-size: 2.5rem; color: #4caf50; font-weight: bold;">${playerResults.correct}</div>
<div style="color: #666; font-weight: 600;">Correct Answers</div>
</div>
<div style="background: #ffebee; padding: 1.5rem; border-radius: 10px; text-align: center;">
<div style="font-size: 2.5rem; color: #f44336; font-weight: bold;">${playerResults.incorrect}</div>
<div style="color: #666; font-weight: 600;">Incorrect Answers</div>
</div>
<div style="background: #e3f2fd; padding: 1.5rem; border-radius: 10px; text-align: center;">
<div style="font-size: 2.5rem; color: #2196f3; font-weight: bold;">${playerResults.accuracy.toFixed(1)}%</div>
<div style="color: #666; font-weight: 600;">Accuracy</div>
</div>
<div style="background: #fff3e0; padding: 1.5rem; border-radius: 10px; text-align: center;">
<div style="font-size: 2.5rem; color: #ff9800; font-weight: bold;">${avgResponseTime}s</div>
<div style="color: #666; font-weight: 600;">Avg Response Time</div>
</div>
</div>

<div style="font-size: 1.8rem; color: ${passFail === 'PASS' ? '#4caf50' : '#f44336'}; margin: 2rem 0; font-weight: bold;">
Final Result: ${passFail}
</div>

<button onclick="downloadPlayerResults()" style="background: #4caf50; padding: 1.2rem 2.5rem; font-size: 1.1rem; border-radius: 8px;">
📥 Download My Results
</button>

<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin: 2rem 0; border-radius: 6px; text-align: left;">
<h3 style="color: #856404; margin-bottom: 0.5rem;">⚠️ Quiz Completed</h3>
<p style="color: #856404; margin: 0;">You have successfully completed this quiz and cannot retake it.</p>
</div>
</div>
`;

document.getElementById('player-answers').innerHTML = "";
document.getElementById('countdown').textContent = "";
}

// Enhanced Firebase save function
function saveToFirebase(playerCode, playerName, question, selectedAnswer, correctAnswer, responseTime, status, modelId) {
const responseId = database.ref().child('quizResults').push().key;

const quizData = {
playerCode: playerCode,
playerName: playerName,
question: question,
selectedAnswer: selectedAnswer,
correctAnswer: correctAnswer,
responseTime: responseTime,
status: status,
timestamp: new Date().toISOString(),
questionIndex: currentIndex,
sessionId: getSessionId(),
deviceType: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
modelId: modelId || "No Model"
};

database.ref('quizResults/' + responseId).set(quizData)
.then(() => {
console.log("Data saved successfully for session:", quizData.sessionId);
})
.catch((error) => {
console.error("Save error, retrying:", error);
setTimeout(() => {
database.ref('quizResults/' + responseId).set(quizData);
}, 500);
});
}

// Enhanced results functions
function loadQuizResults() {
const resultsContainer = document.getElementById('results-container');
const statsContainer = document.getElementById('stats-container');
const userResultsContainer = document.getElementById('user-results-container');

if (resultsContainer) resultsContainer.innerHTML = '<p>Loading results...</p>';
if (statsContainer) statsContainer.innerHTML = '<p>Loading statistics...</p>';
if (userResultsContainer) userResultsContainer.innerHTML = '<p>Loading user results...</p>';

database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();

if (!results) {
if (resultsContainer) resultsContainer.innerHTML = '<p>No results yet. Results will appear here as players answer questions.</p>';
if (statsContainer) statsContainer.innerHTML = '<p>No statistics available</p>';
if (userResultsContainer) userResultsContainer.innerHTML = '<p>No user results available</p>';
return;
}

const resultsArray = Object.values(results);
const totalResponses = resultsArray.length;
const correctAnswers = resultsArray.filter(r => r.selectedAnswer === r.correctAnswer).length;
const accuracy = totalResponses > 0 ? ((correctAnswers / totalResponses) * 100).toFixed(1) : 0;
const avgResponseTime = totalResponses > 0 ?
(resultsArray.reduce((sum, r) => sum + (r.responseTime || 0), 0) / totalResponses).toFixed(2) : 0;
const uniquePlayers = new Set(resultsArray.map(r => r.playerCode)).size;

// Update statistics
if (statsContainer) {
statsContainer.innerHTML = `
<div class="stats-grid">
<div class="stat-card">
<span class="stat-number">${uniquePlayers}</span>
<span class="stat-label">Unique Players</span>
</div>
<div class="stat-card">
<span class="stat-number">${totalResponses}</span>
<span class="stat-label">Total Responses</span>
</div>
<div class="stat-card">
<span class="stat-number">${correctAnswers}</span>
<span class="stat-label">Correct Answers</span>
</div>
<div class="stat-card">
<span class="stat-number">${accuracy}%</span>
<span class="stat-label">Accuracy</span>
</div>
<div class="stat-card">
<span class="stat-number">${avgResponseTime}s</span>
<span class="stat-label">Avg Response Time</span>
</div>
</div>
`;
}

// Update detailed results
if (resultsContainer) {
let resultsHTML = '<div class="results-table">';
resultsHTML += '<div class="result-header">';
resultsHTML += '<span>Player</span><span>Question</span><span>Answer</span><span>Correct</span><span>Time</span><span>Status</span><span>Model</span>';
resultsHTML += '</div>';

resultsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

resultsArray.forEach((result) => {
const isCorrect = result.selectedAnswer === result.correctAnswer;
const shortQuestion = result.question.length > 30 ?
result.question.substring(0, 30) + '...' : result.question;
const model = quizModels.find(m => m.id === result.modelId);
const modelName = model ? model.name : 'No Model';

resultsHTML += `
<div class="result-row ${isCorrect ? 'correct' : 'incorrect'}">
<span>${result.playerName} (${result.playerCode})</span>
<span title="${result.question}">${shortQuestion}</span>
<span>${result.selectedAnswer}</span>
<span>${result.correctAnswer}</span>
<span>${result.responseTime}s</span>
<span>${result.status}</span>
<span>${modelName}</span>
</div>
`;
});

resultsHTML += '</div>';
resultsContainer.innerHTML = resultsHTML;
}

// Update individual user results
if (userResultsContainer) {
loadIndividualUserResults(resultsArray);
}
})
.catch((error) => {
console.error("Error loading results:", error);
if (resultsContainer) resultsContainer.innerHTML = '<p>Error loading results.</p>';
});
}

function loadIndividualUserResults(resultsArray) {
const userResultsContainer = document.getElementById('user-results-container');
if (!userResultsContainer) return;

// Group results by playerCode
const resultsByUser = {};
resultsArray.forEach(result => {
if (!resultsByUser[result.playerCode]) {
resultsByUser[result.playerCode] = [];
}
resultsByUser[result.playerCode].push(result);
});

let userResultsHTML = '';

for (const [playerCode, userResults] of Object.entries(resultsByUser)) {
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

// Group results by model (quiz)
const resultsByModel = {};
userResults.forEach(result => {
if (!resultsByModel[result.modelId]) {
resultsByModel[result.modelId] = [];
}
resultsByModel[result.modelId].push(result);
});

userResultsHTML += `
<div class="compact-section">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
<div>
<strong>${userName}</strong> (Code: ${playerCode})
<br><small style="color: #666;">Total Quizzes Taken: ${Object.keys(resultsByModel).length}</small>
</div>
<div class="admin-controls">
<button class="admin-btn view" onclick="exportUserResults('${playerCode}')">Export</button>
<button class="admin-btn delete" onclick="deleteUserResults('${playerCode}')">Delete Results</button>
</div>
</div>`;

// Display results for each quiz separately
let quizCounter = 1;
Object.entries(resultsByModel).forEach(([modelId, modelResults]) => {
const model = quizModels.find(m => m.id === modelId);
const modelName = model ? model.name : 'Unknown Quiz';

// Get first attempt only
const firstAttempt = modelResults.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))[0];
const firstAttemptResults = modelResults.filter(r =>
new Date(r.timestamp).toDateString() === new Date(firstAttempt.timestamp).toDateString()
);

const correctAnswers = firstAttemptResults.filter(r => r.selectedAnswer === r.correctAnswer).length;
const totalAnswers = firstAttemptResults.length;
const accuracy = totalAnswers > 0 ? ((correctAnswers / totalAnswers) * 100).toFixed(1) : 0;
const avgResponseTime = totalAnswers > 0 ?
(firstAttemptResults.reduce((sum, r) => sum + (r.responseTime || 0), 0) / totalAnswers).toFixed(2) : 0;
const passFail = accuracy >= 50 ? 'PASS' : 'FAIL';
const passFailClass = passFail === 'PASS' ? 'status-active' : 'status-inactive';

userResultsHTML += `
<div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin: 0.5rem 0;">
<div style="font-weight: bold; color: #6e8efb; margin-bottom: 0.5rem;">Quiz ${quizCounter}: ${modelName}</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
<div>
<div style="font-size: 1.2rem; font-weight: bold; color: #4caf50;">${correctAnswers}</div>
<div style="font-size: 0.8rem; color: #666;">Correct</div>
</div>
<div>
<div style="font-size: 1.2rem; font-weight: bold; color: #f44336;">${totalAnswers - correctAnswers}</div>
<div style="font-size: 0.8rem; color: #666;">Incorrect</div>
</div>
<div>
<div style="font-size: 1.2rem; font-weight: bold; color: #2196f3;">${accuracy}%</div>
<div style="font-size: 0.8rem; color: #666;">Accuracy</div>
</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
<div>
<div style="font-size: 1rem; font-weight: bold; color: #ff9800;">${avgResponseTime}s</div>
<div style="font-size: 0.8rem; color: #666;">Avg Time</div>
</div>
<div>
<div style="font-size: 1rem; font-weight: bold; background: ${passFail === 'PASS' ? '#4caf50' : '#f44336'}; color: white; padding: 0.3rem; border-radius: 15px;">
${passFail}
</div>
<div style="font-size: 0.8rem; color: #666;">Result</div>
</div>
</div>
</div>`;
quizCounter++;
});

userResultsHTML += `</div>`;
}

userResultsContainer.innerHTML = userResultsHTML;
}

// Enhanced export functions
function exportToExcel() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results to export.');
return;
}

const data = Object.values(results);
const worksheet = XLSX.utils.json_to_sheet(data);
const workbook = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(workbook, worksheet, "Quiz Results");
XLSX.writeFile(workbook, 'quiz-results.xlsx');
alert('Excel file downloaded successfully!');
})
.catch((error) => {
console.error("Error exporting to Excel:", error);
alert('Error exporting data.');
});
}

function downloadAllUserResults() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results to export.');
return;
}

const allResults = Object.values(results);
const resultsByUser = {};

// Group results by user and get first attempt only
allResults.forEach(result => {
if (result && result.playerCode) {
if (!resultsByUser[result.playerCode]) {
resultsByUser[result.playerCode] = [];
}
resultsByUser[result.playerCode].push(result);
}
});

if (Object.keys(resultsByUser).length === 0) {
alert('No valid user results to export.');
return;
}

const workbook = XLSX.utils.book_new();
const allUsersData = [];

// Header row for All Users Combined sheet
allUsersData.push([
'Player Name',
'Code',
'Quiz Model',
'First Attempt Date',
'Number of Questions Answered',
'Correct Answers',
'Wrong Answers',
'Accuracy %',
'Response Time Avg (seconds)',
'Pass/Fail'
]);

// Process each user and create ONE ROW per user for their FIRST ATTEMPT
Object.entries(resultsByUser).forEach(([playerCode, userResults]) => {
const user = users.find(u => u && u.code === playerCode);
const userName = user ? user.name : `Unknown User (${playerCode})`;

// Group results by model (quiz)
const resultsByModel = {};
userResults.forEach(result => {
if (result && result.modelId) {
if (!resultsByModel[result.modelId]) {
resultsByModel[result.modelId] = [];
}
resultsByModel[result.modelId].push(result);
}
});

// Create a row for each quiz the user took (first attempt only)
Object.entries(resultsByModel).forEach(([modelId, modelResults]) => {
const model = quizModels.find(m => m && m.id === modelId);
const modelName = model ? model.name : `Unknown Quiz (${modelId})`;

// Get first attempt only
const firstAttempt = modelResults.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))[0];
const firstAttemptResults = modelResults.filter(r =>
new Date(r.timestamp).toDateString() === new Date(firstAttempt.timestamp).toDateString()
);

const totalQuestions = firstAttemptResults.length;
const correctAnswers = firstAttemptResults.filter(r => r && r.selectedAnswer === r.correctAnswer).length;
const wrongAnswers = totalQuestions - correctAnswers;
const accuracy = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(1) : 0;

const totalResponseTime = firstAttemptResults.reduce((sum, r) => sum + (r.responseTime || 0), 0);
const avgResponseTime = totalQuestions > 0 ? (totalResponseTime / totalQuestions).toFixed(2) : 0;

const passFail = accuracy >= 50 ? 'PASS' : 'FAIL';
const firstAttemptDate = new Date(firstAttempt.timestamp).toLocaleString();

// Add ONE ROW for this user for this specific quiz (first attempt)
allUsersData.push([
userName,
playerCode,
modelName,
firstAttemptDate,
totalQuestions,
correctAnswers,
wrongAnswers,
accuracy + '%',
avgResponseTime,
passFail
]);
});
});

// Only create the "All Users Combined" sheet if we have data
if (allUsersData.length > 1) {
const allUsersSheet = XLSX.utils.aoa_to_sheet(allUsersData);
XLSX.utils.book_append_sheet(workbook, allUsersSheet, "First Attempts Only");
}

// Download the Excel file
XLSX.writeFile(workbook, `first-attempts-results-${new Date().toISOString().split('T')[0]}.xlsx`);

alert('All individual user results downloaded successfully! Showing first attempts only.');
})
.catch((error) => {
console.error("Error exporting all user results:", error);
alert('Error exporting data: ' + error.message);
});
}

function downloadPlayerResults() {
const avgResponseTime = playerResults.responseTimes.length > 0 ?
(playerResults.responseTimes.reduce((a, b) => a + b, 0) / playerResults.responseTimes.length).toFixed(2) : 0;

const user = users.find(u => u.code === playerCode);
const passFail = playerResults.accuracy >= 50 ? 'PASS' : 'FAIL';

const csvData = [
['Player Name', 'Player Code', 'Correct Answers', 'Incorrect Answers', 'Total Questions', 'Accuracy', 'Average Response Time', 'Final Result'],
[user.name, playerCode, playerResults.correct, playerResults.incorrect, playerResults.total, playerResults.accuracy.toFixed(1) + '%', avgResponseTime + 's', passFail]
];

const csv = csvData.map(row => row.join(',')).join('\n');
const blob = new Blob([csv], { type: 'text/csv' });
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `my-results-${user.name}.csv`;
a.click();
window.URL.revokeObjectURL(url);
}

function exportUserResults(playerCode) {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results to export.');
return;
}

const allResults = Object.values(results);
const userResults = allResults.filter(r => r.playerCode === playerCode);

if (userResults.length === 0) {
alert('No results found for this user.');
return;
}

const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

const workbook = XLSX.utils.book_new();
const userData = [];

// Header
userData.push(['Player Name', 'Player Code', 'Question', 'Selected Answer', 'Correct Answer', 'Response Time (s)', 'Status', 'Timestamp', 'Model']);

// Data
userResults.forEach(result => {
userData.push([
userName,
playerCode,
result.question,
result.selectedAnswer,
result.correctAnswer,
result.responseTime,
result.status,
new Date(result.timestamp).toLocaleString(),
quizModels.find(m => m.id === result.modelId)?.name || 'No Model'
]);
});

const worksheet = XLSX.utils.aoa_to_sheet(userData);
XLSX.utils.book_append_sheet(workbook, worksheet, `${userName} Results`);
XLSX.writeFile(workbook, `user-results-${userName}.xlsx`);

alert(`Results for ${userName} exported successfully!`);
})
.catch((error) => {
console.error("Error exporting user results:", error);
alert('Error exporting user results.');
});
}

function deleteUserResults(playerCode) {
if (confirm(`Are you sure you want to delete all results for user with code: ${playerCode}?`)) {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results found for this user.');
return;
}

const updates = {};
let foundResults = false;

Object.keys(results).forEach(key => {
if (results[key] && results[key].playerCode === playerCode) {
updates[key] = null;
foundResults = true;
}
});

if (!foundResults) {
alert('No results found for this user.');
return;
}

database.ref('quizResults').update(updates)
.then(() => {
alert(`All results for user ${playerCode} have been deleted successfully!`);
loadQuizResults();
})
.catch((error) => {
console.error("Error deleting user results:", error);
alert('Error deleting user results. Please try again.');
});
})
.catch((error) => {
console.error("Error loading results:", error);
alert('Error loading results.');
});
}
}

function confirmDeleteResults() {
if (confirm('⚠️ Are you sure you want to delete ALL quiz results?\n\nThis action cannot be undone!')) {
if (confirm('🚨 FINAL WARNING: This will permanently delete all quiz data. Continue?')) {
database.ref('quizResults').remove()
.then(() => {
alert('All quiz results have been deleted successfully!');
loadQuizResults();
})
.catch((error) => {
console.error("Error deleting results:", error);
alert('Error deleting results. Please try again.');
});
}
}
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
initializeQuizTime();
loadDataFromFirebase();
setInterval(updateQuizTimeInfo, 1000);

// Load any saved data from localStorage as backup
const savedQuestions = localStorage.getItem('quizQuestions');
const savedUsers = localStorage.getItem('quizUsers');
const savedModels = localStorage.getItem('quizModels');

if (savedQuestions) questions = JSON.parse(savedQuestions);
if (savedUsers) users = JSON.parse(savedUsers);
if (savedModels) quizModels = JSON.parse(savedModels);

// Check if user already completed quiz
if (sessionStorage.getItem('quizCompleted') === 'true') {
const playerCode = sessionStorage.getItem('playerCode') || 'Unknown';
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Player';

document.getElementById('player-question').innerHTML = `
<div style="text-align: center; padding: 2rem;">
<h2 style="color: #6e8efb;">🏁 Quiz Already Completed</h2>
<p style="font-size: 1.1rem; margin: 1rem 0;">Hello <strong>${userName}</strong>, you have successfully completed this quiz!</p>
<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin: 1rem 0; border-radius: 6px; text-align: left;">
<h3 style="color: #856404; margin-bottom: 0.5rem;">⚠️ Attempt Limit Reached</h3>
<p style="color: #856404; margin: 0;">Each participant can only complete the quiz once.</p>
</div>
</div>
`;
document.getElementById("player-code").style.display = "none";
document.getElementById("joinBtn").disabled = true;
document.getElementById("joinBtn").style.background = "#ccc";
document.getElementById("joinBtn").textContent = "Quiz Completed";
}

console.log("Enhanced Kahoot FS with All Features Initialized");
});

// Close modal when clicking outside
window.onclick = function(event) {
const modal = document.getElementById('questionViewModal');
if (event.target === modal) {
closeQuestionView();
}
}

// Enhanced session state management
window.addEventListener('beforeunload', function (e) {
if (sessionStorage.getItem('quizStarted') === 'true' && sessionStorage.getItem('quizCompleted') !== 'true') {
saveQuizProgress();
e.preventDefault();
e.returnValue = 'You have an ongoing quiz. Are you sure you want to leave?';
return 'You have an ongoing quiz. Are you sure you want to leave?';
}
});
</script>
</body>
</html>
