<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz Game with Admin Features</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
/* ... (all existing styles remain the same) ... */
</style>
</head>
<body>
<div class="container">
<!-- ... (all existing HTML structure remains the same) ... -->
</div>

<script>
// Firebase configuration - Replace with your own config
const firebaseConfig = {
  apiKey: "AIzaSyDnt-BAUsCbQMZ-PPALhp3_tsYqcHAKEZ8",
  authDomain: "thequizfs.firebaseapp.com",
  databaseURL: "https://thequizfs-default-rtdb.firebaseio.com",
  projectId: "thequizfs",
  storageBucket: "thequizfs.firebasestorage.app",
  messagingSenderId: "16144411406",
  appId: "1:16144411406:web:d83affb2013dea665e055f",
  measurementId: "G-NXX4GQZ4NF"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Tab switching functionality
function switchTab(tabName) {
  // ... (existing code remains the same)
}

// Initialize variables
var questions = [];
var currentIndex = 0;
var playerName = "";
var countdownInterval;
var timeLeft = 15;
var questionStartTime;
var quizActive = false;
var adminCode = "admin123"; // Default admin code
var webAppUrl = ""; // Will be loaded from Firebase

// Quiz timing configuration (default: tomorrow 12:00 PM to 12:30 PM)
var quizStartTime = localStorage.getItem('quizStartTime');
var quizEndTime = localStorage.getItem('quizEndTime');

if (!quizStartTime) {
  // Set default to tomorrow at 12:00 PM
  var tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(12, 0, 0, 0);
  quizStartTime = tomorrow.getTime();
  localStorage.setItem('quizStartTime', quizStartTime);
} else {
  quizStartTime = parseInt(quizStartTime);
}

if (!quizEndTime) {
  // Set default to tomorrow at 12:30 PM
  var endTime = new Date(quizStartTime);
  endTime.setMinutes(endTime.getMinutes() + 30);
  quizEndTime = endTime.getTime();
  localStorage.setItem('quizEndTime', quizEndTime);
} else {
  quizEndTime = parseInt(quizEndTime);
}

// Load data from Firebase
function loadDataFromFirebase() {
  // Listen for quiz time changes
  database.ref('quizTime').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      quizStartTime = data.startTime;
      quizEndTime = data.endTime;
      localStorage.setItem('quizStartTime', quizStartTime);
      localStorage.setItem('quizEndTime', quizEndTime);
      updateQuizTimeInfo();
      console.log("Quiz time updated from Firebase");
    }
  }, (error) => {
    console.error("Firebase read failed:", error);
    document.getElementById('firebase-init-status').textContent = "Error reading from Firebase: " + error.message;
    document.getElementById('firebase-init-status').className = 'url-status error';
  });

  // Listen for question changes
  database.ref('questions').on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      questions = Object.values(data);
      localStorage.setItem('quizQuestions', JSON.stringify(questions));
      displayQuestions();
      console.log("Questions updated from Firebase");
      
      // If we're on the player tab and a question is active, update it
      if (document.getElementById('player').classList.contains('active') && 
          document.getElementById('player-question').innerHTML !== "") {
        showPlayerQuestion();
      }
    }
  }, (error) => {
    console.error("Firebase read failed:", error);
    document.getElementById('firebase-init-status').textContent = "Error reading from Firebase: " + error.message;
    document.getElementById('firebase-init-status').className = 'url-status error';
  });

  // Listen for web app URL changes
  database.ref('webAppUrl').on('value', (snapshot) => {
    const url = snapshot.val();
    if (url) {
      webAppUrl = url;
      localStorage.setItem('webAppUrl', webAppUrl);
      document.getElementById('webAppUrl').value = webAppUrl;
      
      // Hide setup tab if URL is configured
      if (webAppUrl) {
        document.getElementById('setup-tab').style.display = 'none';
        document.getElementById('urlStatus').textContent = 'Web App URL loaded from Firebase';
        document.getElementById('urlStatus').className = 'url-status success';
      }
      console.log("Web App URL updated from Firebase:", webAppUrl);
    }
  }, (error) => {
    console.error("Firebase read failed:", error);
    document.getElementById('urlStatus').textContent = "Error reading URL from Firebase: " + error.message;
    document.getElementById('urlStatus').className = 'url-status error';
  });
}

// Initialize Firebase data structure
function initializeFirebaseData() {
  const statusElement = document.getElementById('firebase-init-status');
  statusElement.textContent = "Initializing Firebase data...";
  statusElement.className = 'url-status';
  
  // Initialize with default values if they don't exist
  database.ref('quizTime').once('value').then((snapshot) => {
    if (!snapshot.exists()) {
      // Set default quiz time (tomorrow 12:00 PM to 12:30 PM)
      var tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(12, 0, 0, 0);
      var startTime = tomorrow.getTime();
      var endTime = new Date(tomorrow.getTime() + 30 * 60000).getTime();
      
      return database.ref('quizTime').set({
        startTime: startTime,
        endTime: endTime
      });
    }
  }).then(() => {
    return database.ref('questions').once('value');
  }).then((snapshot) => {
    if (!snapshot.exists()) {
      // Set default questions
      const defaultQuestions = [
        {
          question: "What is 2 + 2?",
          answers: ["3", "4", "5", "6"],
          correct: "4"
        },
        {
          question: "Capital of France?",
          answers: ["London", "Paris", "Berlin", "Rome"],
          correct: "Paris"
        }
      ];
      return database.ref('questions').set(defaultQuestions);
    }
  }).then(() => {
    return database.ref('webAppUrl').once('value');
  }).then((snapshot) => {
    if (!snapshot.exists()) {
      // Initialize with empty URL
      return database.ref('webAppUrl').set("");
    }
  }).then(() => {
    statusElement.textContent = "Firebase data initialized successfully!";
    statusElement.className = 'url-status success';
    console.log("Firebase data initialized");
    
    // Reload data
    loadDataFromFirebase();
  }).catch((error) => {
    statusElement.textContent = "Error initializing Firebase: " + error.message;
    statusElement.className = 'url-status error';
    console.error("Firebase initialization error:", error);
  });
}

// Save web app URL to Firebase
function saveWebAppUrlToFirebase(url) {
  database.ref('webAppUrl').set(url).then(() => {
    document.getElementById('urlStatus').textContent = 'URL saved to Firebase and synced across all devices!';
    document.getElementById('urlStatus').className = 'url-status success';
    
    // Hide setup tab
    document.getElementById('setup-tab').style.display = 'none';
    
    // Hide setup form and show completion message
    document.getElementById('setup-form').style.display = 'none';
    document.getElementById('setup-complete-message').style.display = 'block';
  }).catch((error) => {
    document.getElementById('urlStatus').textContent = 'Error saving URL to Firebase: ' + error.message;
    document.getElementById('urlStatus').className = 'url-status error';
  });
}

// Save quiz time to Firebase
function saveQuizTimeToFirebase(startTime, endTime) {
  database.ref('quizTime').set({
    startTime: startTime,
    endTime: endTime
  }).then(() => {
    document.getElementById('host-time-status').textContent = 'Quiz time saved successfully!';
    document.getElementById('host-time-status').className = 'url-status success';
  }).catch((error) => {
    document.getElementById('host-time-status').textContent = 'Error saving quiz time: ' + error.message;
    document.getElementById('host-time-status').className = 'url-status error';
  });
}

// Save questions to Firebase
function saveQuestionsToFirebase() {
  database.ref('questions').set(questions).then(() => {
    document.getElementById('question-status').textContent = 'Questions saved successfully!';
    document.getElementById('question-status').className = 'url-status success';
  }).catch((error) => {
    document.getElementById('question-status').textContent = 'Error saving questions: ' + error.message;
    document.getElementById('question-status').className = 'url-status error';
  });
}

// Load questions from localStorage
var savedQuestions = localStorage.getItem('quizQuestions');
if (savedQuestions) {
  questions = JSON.parse(savedQuestions);
}

// Load host time settings into the form
function loadHostTimeSettings() {
  var quizDate = new Date(quizStartTime);
  document.getElementById('host-quiz-date').value = quizDate.toISOString().split('T')[0];

  var startTime = new Date(quizStartTime);
  var hours = startTime.getHours();
  var ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12; // Convert 0 to 12

  document.getElementById('host-start-hour').value = hours;
  document.getElementById('host-start-minute').value = startTime.getMinutes();
  document.getElementById('host-start-ampm').value = ampm;

  // Calculate duration in minutes
  var duration = Math.round((quizEndTime - quizStartTime) / 60000);
  document.getElementById('host-quiz-duration').value = duration;

  // Display questions
  displayQuestions();
}

// Verify admin code
function verifyAdmin() {
  var code = document.getElementById('admin-code').value;
  var status = document.getElementById('admin-status');

  if (code === adminCode) {
    document.getElementById('admin-features').style.display = 'block';
    status.textContent = 'Admin access granted!';
    status.className = 'url-status success';
  } else {
    status.textContent = 'Invalid admin code. Please try again.';
    status.className = 'url-status error';
  }
}

// Save quiz time configuration from host tab
function saveHostQuizTime() {
  var date = document.getElementById('host-quiz-date').value;
  var hour = parseInt(document.getElementById('host-start-hour').value);
  var minute = parseInt(document.getElementById('host-start-minute').value);
  var ampm = document.getElementById('host-start-ampm').value;
  var duration = document.getElementById('host-quiz-duration').value;

  if (!date || isNaN(hour) || isNaN(minute) || !duration) {
    document.getElementById('host-time-status').textContent = 'Please fill in all fields correctly';
    document.getElementById('host-time-status').className = 'url-status error';
    return;
  }

  // Convert to 24-hour format
  if (ampm === 'PM' && hour < 12) {
    hour += 12;
  } else if (ampm === 'AM' && hour === 12) {
    hour = 0;
  }

  var startDate = new Date(date);
  startDate.setHours(hour, minute, 0, 0);

  var endDate = new Date(startDate.getTime() + parseInt(duration) * 60000);

  quizStartTime = startDate.getTime();
  quizEndTime = endDate.getTime();

  // Save to Firebase instead of localStorage
  saveQuizTimeToFirebase(quizStartTime, quizEndTime);
  updateQuizTimeInfo();

  // Clear status after 3 seconds
  setTimeout(() => {
    document.getElementById('host-time-status').textContent = 'Quiz time configuration saved';
    document.getElementById('host-time-status').className = 'url-status';
  }, 3000);
}

// Add a new question
function addQuestion() {
  var questionText = document.getElementById('question-text').value;
  var answer1 = document.getElementById('answer-1').value;
  var answer2 = document.getElementById('answer-2').value;
  var answer3 = document.getElementById('answer-3').value;
  var answer4 = document.getElementById('answer-4').value;

  if (!questionText || !answer1 || !answer2 || !answer3 || !answer4) {
    document.getElementById('question-status').textContent = 'Please fill in all fields';
    document.getElementById('question-status').className = 'url-status error';
    return;
  }

  // Get the selected correct answer
  var correctAnswerIndex = parseInt(document.querySelector('input[name="correct-answer"]:checked').value);
  var answers = [answer1, answer2, answer3, answer4];
  var correctAnswer = answers[correctAnswerIndex];

  var newQuestion = {
    question: questionText,
    answers: answers,
    correct: correctAnswer
  };

  questions.push(newQuestion);
  // Save to Firebase instead of localStorage
  saveQuestionsToFirebase();

  document.getElementById('question-status').textContent = 'Question added successfully!';
  document.getElementById('question-status').className = 'url-status success';

  // Clear form
  document.getElementById('question-text').value = '';
  document.getElementById('answer-1').value = '';
  document.getElementById('answer-2').value = '';
  document.getElementById('answer-3').value = '';
  document.getElementById('answer-4').value = '';
  document.querySelector('input[name="correct-answer"][value="0"]').checked = true;

  // Clear status after 3 seconds
  setTimeout(() => {
    document.getElementById('question-status').textContent = 'Add a new question to the quiz';
    document.getElementById('question-status').className = 'url-status';
  }, 3000);
}

// Display all questions
function displayQuestions() {
  var container = document.getElementById('questions-container');
  container.innerHTML = '';

  if (questions.length === 0) {
    container.innerHTML = '<p>No questions added yet.</p>';
    return;
  }

  questions.forEach((q, index) => {
    var questionItem = document.createElement('div');
    questionItem.className = 'question-item';

    // Find the index of the correct answer
    var correctIndex = q.answers.indexOf(q.correct);

    questionItem.innerHTML = `
      <strong>Q${index + 1}:</strong> ${q.question}
      <div class="response-time">Correct answer: ${q.correct} (Option ${correctIndex + 1})</div>
      <div class="admin-controls">
        <button class="admin-btn edit" onclick="editQuestion(${index})">Edit</button>
        <button class="admin-btn delete" onclick="deleteQuestion(${index})">Delete</button>
      </div>
    `;
    container.appendChild(questionItem);
  });
}

// Edit a question
function editQuestion(index) {
  var q = questions[index];

  document.getElementById('question-text').value = q.question;
  document.getElementById('answer-1').value = q.answers[0];
  document.getElementById('answer-2').value = q.answers[1];
  document.getElementById('answer-3').value = q.answers[2];
  document.getElementById('answer-4').value = q.answers[3];

  // Find and select the correct answer
  var correctIndex = q.answers.indexOf(q.correct);
  document.querySelector(`input[name="correct-answer"][value="${correctIndex}"]`).checked = true;

  // Remove the question being edited
  questions.splice(index, 1);
  // Save to Firebase instead of localStorage
  saveQuestionsToFirebase();

  document.getElementById('question-status').textContent = 'Editing question. Update the fields and click "Add Question" to save changes.';
  document.getElementById('question-status').className = 'url-status';
}

// Delete a question
function deleteQuestion(index) {
  if (confirm('Are you sure you want to delete this question?')) {
    questions.splice(index, 1);
    // Save to Firebase instead of localStorage
    saveQuestionsToFirebase();
  }
}

// Update quiz time info display
function updateQuizTimeInfo() {
  var start = new Date(quizStartTime);
  var end = new Date(quizEndTime);

  var options = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };

  var timeRange = start.toLocaleDateString('en-US', options) + ' to ' +
                  end.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

  document.getElementById('quiz-time-range').textContent = timeRange;

  // Update quiz status
  var now = new Date().getTime();
  var quizTimer = document.getElementById('quiz-timer');
  var quizStatus = document.getElementById('quiz-status-text');

  if (now < quizStartTime) {
    // Quiz hasn't started yet
    var timeUntilStart = Math.floor((quizStartTime - now) / 1000);
    var hours = Math.floor(timeUntilStart / 3600);
    var minutes = Math.floor((timeUntilStart % 3600) / 60);
    var seconds = timeUntilStart % 60;

    quizTimer.textContent = `Starts in: ${hours}h ${minutes}m ${seconds}s`;
    quizStatus.textContent = 'Not started';
    quizStatus.style.color = '#ff9800';
    quizActive = false;
  } else if (now >= quizStartTime && now <= quizEndTime) {
    // Quiz is active
    var timeLeft = Math.floor((quizEndTime - now) / 1000);
    var minutes = Math.floor(timeLeft / 60);
    var seconds = timeLeft % 60;

    quizTimer.textContent = `Time left: ${minutes}m ${seconds}s`;
    quizStatus.textContent = 'Active';
    quizStatus.style.color = '#4caf50';
    quizActive = true;
  } else {
    // Quiz has ended
    quizTimer.textContent = 'Quiz ended';
    quizStatus.textContent = 'Ended';
    quizStatus.style.color = '#f44336';
    quizActive = false;
  }
}

// Update quiz timer every second
setInterval(updateQuizTimeInfo, 1000);
updateQuizTimeInfo();

// Get saved web app URL from local storage
webAppUrl = localStorage.getItem('webAppUrl') || '';
document.getElementById('webAppUrl').value = webAppUrl;

// Hide setup tab if URL is already configured
if (webAppUrl) {
  document.getElementById('setup-tab').style.display = 'none';
}

// Save web app URL to Firebase
function saveWebAppUrl() {
  var url = document.getElementById('webAppUrl').value;
  var urlStatus = document.getElementById('urlStatus');

  if (url) {
    // Save to Firebase instead of localStorage
    saveWebAppUrlToFirebase(url);
  } else {
    urlStatus.textContent = 'Please enter a valid URL';
    urlStatus.className = 'url-status error';
  }
}

// Function to send data to Google Sheets
function sendToGoogleSheet(playerName, question, selectedAnswer, correctAnswer, responseTime, status) {
  if (!webAppUrl) {
    console.error("Web app URL not configured");
    alert("Google Sheets integration not configured. Please set up the web app URL in the Setup tab.");
    switchTab('setup');
    return;
  }

  // Prepare data to send
  var data = {
    player: playerName,
    question: question,
    answer: selectedAnswer,
    correct: correctAnswer,
    responseTime: responseTime,
    status: status
  };

  // Send data to Google Apps Script web app
  fetch(webAppUrl, {
    method: "POST",
    mode: "no-cors",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(data)
  })
  .then(() => {
    console.log("Data sent to Google Sheets successfully");
  })
  .catch(error => {
    console.error("Error sending data to Google Sheets:", error);
  });
}

// Countdown timer function
function startCountdown() {
  timeLeft = 15;
  document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

  clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    timeLeft--;
    document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      // Record unanswered question
      var q = questions[currentIndex];
      var responseTime = (Date.now() - questionStartTime) / 1000;
      sendToGoogleSheet(playerName, q.question, "No Answer", q.correct, responseTime, "Unanswered");
      moveToNextQuestion();
    }
  }, 1000);
}

// Move to next question automatically
function moveToNextQuestion() {
  currentIndex++;
  if (currentIndex < questions.length) {
    showPlayerQuestion();
  } else {
    document.getElementById('player-question').innerHTML = "<h3>Quiz Completed!</h3>";
    document.getElementById('player-answers').innerHTML = "";
    document.getElementById('countdown').textContent = "";
  }
}

// Player view functions
function showPlayerQuestion() {
  var q = questions[currentIndex];
  document.getElementById("player-question").innerHTML = "<h3>Question " + (currentIndex + 1) + ":</h3><p>" + q.question + "</p>";

  var answersDiv = document.getElementById("player-answers");
  answersDiv.innerHTML = "<h3>Select your answer:</h3>";

  // Record question start time for response timing
  questionStartTime = Date.now();

  q.answers.forEach(a => {
    var btn = document.createElement("button");
    btn.className = "answer-btn";
    btn.innerText = a;
    btn.onclick = function() {
      // Check if quiz is active
      if (!quizActive) {
        alert("The quiz is not currently active. Please check the quiz schedule.");
        return;
      }

      var selected = a;
      var correct = q.correct;
      var responseTime = (Date.now() - questionStartTime) / 1000; // Response time in seconds

      // Clear the countdown
      clearInterval(countdownInterval);
      document.getElementById('countdown').textContent = "";

      // Color the answers
      var allButtons = document.querySelectorAll('.answer-btn');
      allButtons.forEach(button => {
        button.disabled = true;
        if (button.innerText === correct) {
          button.classList.add('correct');
        } else if (button.innerText === selected && selected !== correct) {
          button.classList.add('incorrect');
        }
      });

      // Send to Google Sheets with response time
      sendToGoogleSheet(playerName, q.question, selected, correct, responseTime, "Answered");

      // Move to next question after 5 seconds
      setTimeout(moveToNextQuestion, 5000);
    };
    answersDiv.appendChild(btn);
  });

  // Start countdown for this question
  startCountdown();
}

// Initialize the application
document.getElementById("joinBtn").onclick = function() {
  // Check if quiz is active
  if (!quizActive) {
    alert("The quiz is not currently active. Please check the quiz schedule.");
    return;
  }

  playerName = document.getElementById("name").value;
  if (playerName.trim() !== "") {
    // Remove the welcome message by hiding the input elements
    document.getElementById("name").style.display = "none";
    document.getElementById("joinBtn").style.display = "none";

    // Show first question
    showPlayerQuestion();
  } else {
    alert("Please enter your name to join the game.");
  }
};

// Initial setup - show player tab by default
document.querySelectorAll('.tab-content').forEach(tab => {
  tab.classList.remove('active');
});
document.getElementById('player').classList.add('active');

// Check if web app URL is configured
if (!webAppUrl) {
  console.log("Web app URL not configured. Please set it up in the Setup tab.");
  // Show setup tab if no URL is configured
  document.getElementById('setup-tab').style.display = 'flex';
}

// Initialize the quiz time display
updateQuizTimeInfo();

// Load data from Firebase when the page loads
loadDataFromFirebase();
</script>
</body>
</html>
