<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game with Pusher Integration</title>
    <style>
        /* ... (all your existing CSS remains the same) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (all your existing HTML remains the same) ... -->
    </div>

    <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
    <script>
        // Initialize variables
        let pusher = null;
        let quizChannel = null;
        let currentIndex = 0;
        let playerName = "";
        let countdownInterval;
        let timeLeft = 15;
        let questionStartTime;
        let quizActive = false;
        let adminCode = "admin123";
        let players = {};
        let playerId = Math.random().toString(36).substring(2, 10);

        // Quiz timing configuration - initialize with default values
        let quizStartTime = localStorage.getItem('quizStartTime');
        let quizEndTime = localStorage.getItem('quizEndTime');

        if (!quizStartTime) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(12, 0, 0, 0);
            quizStartTime = tomorrow.getTime();
            localStorage.setItem('quizStartTime', quizStartTime);
        } else {
            quizStartTime = parseInt(quizStartTime);
        }

        if (!quizEndTime) {
            const endTime = new Date(quizStartTime);
            endTime.setMinutes(endTime.getMinutes() + 30);
            quizEndTime = endTime.getTime();
            localStorage.setItem('quizEndTime', quizEndTime);
        } else {
            quizEndTime = parseInt(quizEndTime);
        }

        // Load questions from localStorage
        let questions = [];
        const savedQuestions = localStorage.getItem('quizQuestions');
        if (savedQuestions) {
            questions = JSON.parse(savedQuestions);
        }

        // Initialize Pusher if credentials are available
        function initializePusher() {
            const appId = localStorage.getItem('pusherAppId');
            const key = localStorage.getItem('pusherKey');
            const secret = localStorage.getItem('pusherSecret');
            const cluster = localStorage.getItem('pusherCluster') || 'mt1';
            
            if (appId && key && secret) {
                pusher = new Pusher(key, {
                    cluster: cluster,
                    encrypted: true
                });
                
                quizChannel = pusher.subscribe('quiz-game-channel');
                
                // Listen for player joined events
                quizChannel.bind('player-joined', function(data) {
                    if (data.playerId !== playerId) {
                        players[data.playerId] = data.playerName;
                        updatePlayersList();
                    }
                });
                
                // Listen for quiz control events
                quizChannel.bind('quiz-control', function(data) {
                    if (data.action === 'start') {
                        quizActive = true;
                        updateQuizStatus();
                        alert('Quiz has started!');
                    } else if (data.action === 'stop') {
                        quizActive = false;
                        updateQuizStatus();
                        alert('Quiz has ended!');
                    } else if (data.action === 'next') {
                        currentIndex = data.currentIndex;
                        if (playerName) {
                            showPlayerQuestion();
                        }
                    }
                });
                
                // Listen for question events
                quizChannel.bind('new-question', function(data) {
                    if (playerName) {
                        showQuestion(data.question);
                    }
                });
                
                // NEW: Listen for timing update events
                quizChannel.bind('timing-update', function(data) {
                    quizStartTime = data.startTime;
                    quizEndTime = data.endTime;
                    localStorage.setItem('quizStartTime', quizStartTime);
                    localStorage.setItem('quizEndTime', quizEndTime);
                    updateQuizTimeInfo();
                });
                
                console.log('Pusher initialized successfully');
            }
        }

        // NEW: Function to send timing updates to all clients
        function sendTimingUpdate() {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-timing-update', {
                    startTime: quizStartTime,
                    endTime: quizEndTime
                });
            }
        }

        // Update players list in host view
        function updatePlayersList() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            
            if (Object.keys(players).length === 0) {
                playersList.innerHTML = '<p>No players connected yet</p>';
                return;
            }
            
            for (const id in players) {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                playerItem.innerHTML = `
                    <span>${players[id]}</span>
                    <span>Connected</span>
                `;
                playersList.appendChild(playerItem);
            }
        }

        // Send player joined event
        function sendPlayerJoined() {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-player-joined', {
                    playerId: playerId,
                    playerName: playerName
                });
            }
        }

        // Send quiz control event
        function sendQuizControl(action, data = {}) {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-quiz-control', {
                    action: action,
                    ...data
                });
            }
        }

        // Send new question event
        function sendNewQuestion(question) {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-new-question', {
                    question: question
                });
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            event.target.classList.add('active');

            if (tabName === 'host') {
                loadHostTimeSettings();
            }
        }

        // Load host time settings into the form
        function loadHostTimeSettings() {
            const quizDate = new Date(quizStartTime);
            document.getElementById('host-quiz-date').value = quizDate.toISOString().split('T')[0];

            const startTime = new Date(quizStartTime);
            let hours = startTime.getHours();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;

            document.getElementById('host-start-hour').value = hours;
            document.getElementById('host-start-minute').value = startTime.getMinutes();
            document.getElementById('host-start-ampm').value = ampm;

            const duration = Math.round((quizEndTime - quizStartTime) / 60000);
            document.getElementById('host-quiz-duration').value = duration;

            displayQuestions();
        }

        // Verify admin code
        function verifyAdmin() {
            const code = document.getElementById('admin-code').value;
            const status = document.getElementById('admin-status');

            if (code === adminCode) {
                document.getElementById('admin-features').style.display = 'block';
                status.textContent = 'Admin access granted!';
                status.className = 'url-status success';
            } else {
                status.textContent = 'Invalid admin code. Please try again.';
                status.className = 'url-status error';
            }
        }

        // Save quiz time configuration from host tab
        function saveHostQuizTime() {
            const date = document.getElementById('host-quiz-date').value;
            const hour = parseInt(document.getElementById('host-start-hour').value);
            const minute = parseInt(document.getElementById('host-start-minute').value);
            const ampm = document.getElementById('host-start-ampm').value;
            const duration = document.getElementById('host-quiz-duration').value;

            if (!date || isNaN(hour) || isNaN(minute) || !duration) {
                document.getElementById('host-time-status').textContent = 'Please fill in all fields correctly';
                document.getElementById('host-time-status').className = 'url-status error';
                return;
            }

            // Convert to 24-hour format
            let hours24 = hour;
            if (ampm === 'PM' && hour < 12) {
                hours24 += 12;
            } else if (ampm === 'AM' && hour === 12) {
                hours24 = 0;
            }

            const startDate = new Date(date);
            startDate.setHours(hours24, minute, 0, 0);

            const endDate = new Date(startDate.getTime() + parseInt(duration) * 60000);

            quizStartTime = startDate.getTime();
            quizEndTime = endDate.getTime();

            localStorage.setItem('quizStartTime', quizStartTime);
            localStorage.setItem('quizEndTime', quizEndTime);

            // NEW: Send timing update to all clients
            sendTimingUpdate();

            document.getElementById('host-time-status').textContent = 'Quiz time saved and synchronized!';
            document.getElementById('host-time-status').className = 'url-status success';

            updateQuizTimeInfo();

            setTimeout(() => {
                document.getElementById('host-time-status').textContent = 'Quiz time configuration saved';
                document.getElementById('host-time-status').className = 'url-status';
            }, 3000);
        }

        // ... (rest of your JavaScript code remains the same) ...

        // Initialize the application
        document.getElementById("joinBtn").onclick = function() {
            if (!quizActive) {
                alert("The quiz is not currently active. Please check the quiz schedule.");
                return;
            }

            playerName = document.getElementById("name").value;
            if (playerName.trim() !== "") {
                document.getElementById("name").style.display = "none";
                document.getElementById("joinBtn").style.display = "none";

                // Send player joined event
                sendPlayerJoined();
                
                // Show first question if quiz is active
                if (quizActive && questions.length > 0) {
                    showPlayerQuestion();
                } else {
                    document.getElementById("player-question").innerHTML = "<h3>Waiting for the host to start the quiz...</h3>";
                }
            } else {
                alert("Please enter your name to join the game.");
            }
        };

        // Initial setup - show player tab by default
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById('player').classList.add('active');

        // Initialize Pusher if credentials are available
        initializePusher();

        // Initialize the quiz time display
        updateQuizTimeInfo();
    </script>
</body>
</html>
