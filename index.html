<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kahoot FS</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- Excel Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
color: #333;
line-height: 1.6;
min-height: 100vh;
padding: 20px;
display: flex;
justify-content: center;
align-items: center;
}

.container {
width: 95%;
max-width: 1200px;
background: white;
border-radius: 12px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
overflow: hidden;
}

header {
background: linear-gradient(135deg, #6e8efb, #a777e3);
color: white;
padding: 1.5rem;
text-align: center;
position: relative;
}

.quiz-timer {
position: absolute;
top: 10px;
right: 20px;
background: rgba(255, 255, 255, 0.2);
padding: 5px 10px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
}

h1 {
font-size: 2rem;
margin-bottom: 0.5rem;
}

.subtitle {
font-size: 1rem;
opacity: 0.9;
}

.tabs {
display: flex;
background: #f0f0f0;
border-bottom: 2px solid #ddd;
position: sticky;
top: 0;
z-index: 100;
flex-wrap: nowrap;
overflow-x: auto;
}

.tab {
padding: 1rem;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
text-align: center;
flex: 1;
font-size: 0.9rem;
min-width: 120px;
white-space: nowrap;
}

.tab:hover {
background: #e0e0e0;
}

.tab.active {
background: white;
border-bottom: 3px solid #6e8efb;
}

.content {
padding: 1.5rem;
min-height: 500px;
}

.tab-content {
display: none;
}

.tab-content.active {
display: block;
animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.card {
background: white;
border-radius: 10px;
padding: 1.5rem;
margin: 1.5rem 0;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
border-left: 4px solid #6e8efb;
}

h2 {
font-size: 1.6rem;
color: #6e8efb;
margin-bottom: 1rem;
}

h3 {
font-size: 1.3rem;
color: #a777e3;
margin: 1.2rem 0 0.8rem;
}

input, button, select, textarea {
padding: 0.8rem 1rem;
margin: 0.5rem 0;
border-radius: 5px;
border: 1px solid #ddd;
font-size: 0.9rem;
}

input, select, textarea {
width: 100%;
max-width: 300px;
}

textarea {
min-height: 100px;
resize: vertical;
}

button {
background: #6e8efb;
color: white;
border: none;
cursor: pointer;
transition: all 0.3s ease;
font-weight: 600;
}

button:hover {
background: #5a7df9;
transform: translateY(-2px);
}

button:disabled {
background: #ccc;
cursor: not-allowed;
transform: none;
}

.answer-btn {
display: block;
width: 100%;
text-align: left;
margin: 0.5rem 0;
padding: 1rem;
background: #f8f9fa;
color: #333;
border: 1px solid #ddd;
transition: all 0.2s ease;
}

.answer-btn:hover {
background: #e9ecef;
transform: translateX(5px);
}

.answer-btn.correct {
background-color: #4caf50;
color: white;
border-color: #4caf50;
}

.answer-btn.incorrect {
background-color: #f44336;
color: white;
border-color: #f44336;
}

.instructions {
background: #fff8e1;
border-left: 4px solid #ffc107;
padding: 1.2rem;
margin: 1.5rem 0;
border-radius: 4px;
}

.instructions h3 {
color: #ff9800;
margin-bottom: 0.8rem;
}

.instructions ol {
margin-left: 1.5rem;
margin-bottom: 1rem;
}

.instructions li {
margin-bottom: 0.5rem;
}

.countdown {
font-size: 1.4rem;
font-weight: bold;
text-align: center;
margin: 1rem 0;
color: #6e8efb;
}

.url-status {
margin-top: 10px;
padding: 8px;
border-radius: 4px;
text-align: center;
font-size: 0.9rem;
}

.url-status.success {
background-color: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.url-status.error {
background-color: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

.setup-complete {
text-align: center;
padding: 1.5rem;
background: #e8f5e9;
border-radius: 8px;
margin: 1.5rem 0;
}

.time-info {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.time-config {
background: #f3e5f5;
border-left: 4px solid #9c27b0;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.time-config h3 {
color: #7b1fa2;
}

.form-group {
margin: 1rem 0;
}

label {
display: block;
margin-bottom: 0.5rem;
font-weight: 600;
}

.admin-section {
background: #fff3e0;
border-left: 4px solid #ff9800;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.admin-section h3 {
color: #ef6c00;
}

.question-list {
margin: 1rem 0;
max-height: 300px;
overflow-y: auto;
border: 1px solid #ddd;
border-radius: 5px;
padding: 1rem;
background: #f9f9f9;
}

.question-item {
padding: 0.5rem;
border-bottom: 1px solid #eee;
}

.question-item:last-child {
border-bottom: none;
}

.admin-controls {
display: flex;
gap: 10px;
margin-top: 0.5rem;
flex-wrap: wrap;
}

.admin-btn {
padding: 0.5rem 1rem;
font-size: 0.8rem;
}

.admin-btn.edit {
background: #ff9800;
}

.admin-btn.delete {
background: #f44336;
}

.answer-option {
display: flex;
align-items: center;
margin-bottom: 0.5rem;
gap: 10px;
}

.answer-option input[type="text"] {
flex: 1;
max-width: none;
}

.response-time {
font-style: italic;
color: #666;
font-size: 0.9rem;
margin-top: 5px;
}

.time-input-group {
display: flex;
align-items: center;
gap: 10px;
flex-wrap: wrap;
}

.time-input-group input {
max-width: 100px;
}

.time-input-group select {
max-width: 100px;
}

.firebase-config-help {
background: #ffebee;
border-left: 4px solid #f44336;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.firebase-config-help h3 {
color: #c62828;
}

/* Results Styles */
.stats-container {
background: #f5f5f5;
padding: 1rem;
border-radius: 8px;
margin-bottom: 1rem;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin-top: 1rem;
}

.stat-card {
background: white;
padding: 1rem;
border-radius: 8px;
text-align: center;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-number {
display: block;
font-size: 1.8rem;
font-weight: bold;
color: #6e8efb;
}

.stat-label {
font-size: 0.8rem;
color: #666;
}

.results-table {
margin-top: 1rem;
border: 1px solid #ddd;
border-radius: 5px;
overflow: auto;
max-height: 400px;
}

.result-header, .result-row {
display: grid;
grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 2fr;
gap: 1px;
padding: 0.5rem;
min-width: 800px;
}

.result-header {
background: #6e8efb;
color: white;
font-weight: bold;
position: sticky;
top: 0;
}

.result-row {
background: #f9f9f9;
border-bottom: 1px solid #eee;
}

.result-row.correct {
background: #e8f5e9;
}

.result-row.incorrect {
background: #ffebee;
}

.result-row:last-child {
border-bottom: none;
}

.export-buttons {
display: flex;
gap: 10px;
margin: 1rem 0;
flex-wrap: wrap;
}

.export-btn {
background: #4caf50;
padding: 0.8rem 1.2rem;
}

.export-btn.csv {
background: #2196f3;
}

.export-btn.delete {
background: #f44336;
}

/* Host features container */
#admin-features {
max-height: 70vh;
overflow-y: auto;
}

/* Security notice */
.security-notice {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
font-size: 0.9rem;
}

.security-notice h4 {
color: #1565c0;
margin-bottom: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
.container {
width: 100%;
margin: 10px;
padding: 0;
}

header {
padding: 1rem;
}

h1 {
font-size: 1.6rem;
}

.tabs {
flex-direction: row;
overflow-x: auto;
}

.tab {
padding: 0.8rem;
min-width: 100px;
font-size: 0.8rem;
}

.content {
padding: 1rem;
}

.quiz-timer {
position: static;
margin-top: 10px;
display: inline-block;
}

.admin-controls {
flex-direction: column;
}

.answer-option {
flex-direction: column;
align-items: flex-start;
}

.answer-option input[type="text"] {
width: 100%;
margin-right: 0;
margin-bottom: 5px;
}

.time-input-group {
flex-direction: column;
align-items: flex-start;
}

.time-input-group input, .time-input-group select {
max-width: 100%;
}

.result-header, .result-row {
grid-template-columns: 1fr;
font-size: 0.8rem;
min-width: auto;
}

.stats-grid {
grid-template-columns: 1fr;
}

.export-buttons {
flex-direction: column;
}

.answer-btn {
padding: 0.8rem;
font-size: 0.9rem;
}
}

@media (min-width: 1200px) {
.container {
max-width: 1400px;
}

.content {
padding: 2rem;
}
}

@media (max-width: 480px) {
body {
padding: 10px;
}

.container {
border-radius: 8px;
}

.card {
padding: 1rem;
margin: 1rem 0;
}

h2 {
font-size: 1.3rem;
}

h3 {
font-size: 1.1rem;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>Kahoot FS</h1>
<p class="subtitle">Answer questions within the time limit</p>
<div class="quiz-timer" id="quiz-timer">Quiz: Not started</div>
</header>

<div class="tabs">
<div class="tab active" onclick="switchTab('player')">Player</div>
<div class="tab" onclick="switchTab('host')">Host</div>
<div class="tab" onclick="switchTab('firebase-help')">About</div>
</div>

<div class="content">
<!-- Player Tab -->
<div id="player" class="tab-content active">
<h2>Join Quiz</h2>
<div class="time-info" id="quiz-time-info">
<p>This quiz is scheduled for <strong id="quiz-time-range">tomorrow from 12:00 PM to 12:30 PM</strong></p>
<p id="quiz-status">Status: <span id="quiz-status-text">Not started</span></p>
</div>

<div class="card">
<input id="name" placeholder="Enter your name">
<button id="joinBtn">Join Game</button>

<div id="player-question"></div>
<div id="countdown" class="countdown"></div>
<div id="player-answers"></div>
</div>

<div class="instructions">
<h3>Player Instructions</h3>
<ol>
<li>Enter your name and click "Join Game"</li>
<li>Wait for the host to start the quiz</li>
<li>Select your answer when questions appear</li>
<li>Your answers and response time will be recorded</li>
<li>Each device has separate session - names won't conflict</li>
</ol>
</div>
</div>

<!-- Host Tab -->
<div id="host" class="tab-content">
<h2>Quiz Host (Admin)</h2>

<div class="admin-section">
<h3>Admin Access</h3>
<div class="security-notice">
<h4>üîí Security Notice</h4>
<p>Your admin password is <strong>never visible to other users</strong>. It's securely verified locally and never transmitted in clear text.</p>
</div>
<div class="form-group">
<label for="admin-code">Enter Admin Code:</label>
<input type="password" id="admin-code" placeholder="Enter admin code">
<button onclick="verifyAdmin()">Access Admin Features</button>
</div>
<div id="admin-status" class="url-status">Enter the admin code to access host features</div>
</div>

<div id="admin-features" style="display: none;">
<div class="time-config">
<h3>Quiz Timing Configuration</h3>
<p>Set when your quiz will be active</p>

<div class="form-group">
<label for="host-quiz-date">Quiz Date:</label>
<input type="date" id="host-quiz-date">
</div>

<div class="form-group">
<label for="host-start-time">Start Time:</label>
<div class="time-input-group">
<input type="number" id="host-start-hour" min="1" max="12" value="12" placeholder="Hour">
<input type="number" id="host-start-minute" min="0" max="59" value="0" placeholder="Minute">
<select id="host-start-ampm">
<option value="AM">AM</option>
<option value="PM" selected>PM</option>
</select>
</div>
</div>

<div class="form-group">
<label for="host-quiz-duration">Quiz Duration (minutes):</label>
<select id="host-quiz-duration">
<option value="15">15 minutes</option>
<option value="30" selected>30 minutes</option>
<option value="45">45 minutes</option>
<option value="60">1 hour</option>
<option value="90">1.5 hours</option>
<option value="120">2 hours</option>
</select>
</div>

<button onclick="saveHostQuizTime()">Save Quiz Time</button>
<div id="host-time-status" class="url-status">Configure when your quiz will be active</div>
</div>

<div class="admin-section">
<h3>Question Management</h3>

<div class="form-group">
<label for="question-text">Question:</label>
<textarea id="question-text" placeholder="Enter your question"></textarea>
</div>

<div class="form-group">
<label>Answer Options:</label>
<div class="answer-option">
<input type="text" id="answer-1" placeholder="Enter answer 1">
<input type="radio" name="correct-answer" value="0" checked> Correct Answer
</div>
<div class="answer-option">
<input type="text" id="answer-2" placeholder="Enter answer 2">
<input type="radio" name="correct-answer" value="1"> Correct Answer
</div>
<div class="answer-option">
<input type="text" id="answer-3" placeholder="Enter answer 3">
<input type="radio" name="correct-answer" value="2"> Correct Answer
</div>
<div class="answer-option">
<input type="text" id="answer-4" placeholder="Enter answer 4">
<input type="radio" name="correct-answer" value="3"> Correct Answer
</div>
</div>

<button onclick="addQuestion()">Add Question</button>
<div id="question-status" class="url-status">Add a new question to the quiz</div>
</div>

<div class="question-list">
<h3>Current Questions</h3>
<div id="questions-container"></div>
</div>

<div class="admin-section">
<h3>Quiz Results</h3>
<div class="export-buttons">
<button class="export-btn" onclick="exportToExcel()">üìä Export to Excel</button>
<button class="export-btn csv" onclick="exportToCSV()">üìÑ Export to CSV</button>
<button class="export-btn delete" onclick="confirmDeleteResults()">üóëÔ∏è Delete All Results</button>
<button onclick="loadQuizResults()">üîÑ Refresh Results</button>
</div>
<div id="results-container" class="question-list">Click "Refresh Results" to load quiz data</div>
</div>
</div>

<div class="instructions">
<h3>Host Instructions</h3>
<ol>
<li>Enter the admin code to access host features</li>
<li>Set the date and time for your quiz</li>
<li>Add questions using the question management form</li>
<li>View results in the Quiz Results section (now at the bottom)</li>
<li>Export results to Excel or CSV for analysis</li>
<li>Delete results when needed with the delete button</li>
<li>Supports 30+ concurrent users easily</li>
</ol>
</div>
</div>

<!-- Firebase Help Tab -->
<div id="firebase-help" class="tab-content">
<h2>System Information</h2>

<div class="setup-complete">
<h3>‚úÖ System Ready!</h3>
<p>Kahoot FS is optimized for production use with Firebase.</p>
<p><strong>Capacity:</strong> 30+ concurrent users | <strong>Storage:</strong> Firebase Realtime Database</p>
<button onclick="switchTab('player')">Go to Player Tab</button>
</div>

<div class="admin-section">
<h3>System Capacity</h3>
<div class="stats-grid">
<div class="stat-card">
<span class="stat-number">100</span>
<span class="stat-label">Max Concurrent Users</span>
</div>
<div class="stat-card">
<span class="stat-number">1GB</span>
<span class="stat-label">Monthly Data Limit</span>
</div>
<div class="stat-card">
<span class="stat-number">‚àû</span>
<span class="stat-label">Quiz Sessions</span>
</div>
<div class="stat-card">
<span class="stat-number">$0</span>
<span class="stat-label">Monthly Cost</span>
</div>
</div>
</div>

<div class="instructions">
<h3>Security Features</h3>
<ol>
<li><strong>Admin Control:</strong> Full Kahoot Control</li>
<li><strong>Session Isolation:</strong> Each device has separate session</li>
<li><strong>Data Protection:</strong> All data encrypted in Firebase</li>
</ol>
</div>

<div class="card">
<h3>Technical Details</h3>
<ul>
<li>‚úÖ Separate sessions for each device</li>
<li>‚úÖ Optimized for mobile and desktop</li>
<li>‚úÖ Handles 30+ concurrent users</li>
<li>‚úÖ Real-time results tracking</li>
<li>‚úÖ Secure admin authentication</li>
<li>‚úÖ Excel data exports</li>
</ul>
</div>
</div>
</div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDnt-BAUsCbQMZ-PPALhp3_tsYqcHAKEZ8",
  authDomain: "thequizfs.firebaseapp.com",
  databaseURL: "https://thequizfs-default-rtdb.firebaseio.com",
  projectId: "thequizfs",
  storageBucket: "thequizfs.firebasestorage.app",
  messagingSenderId: "16144411406",
  appId: "1:16144411406:web:d83affb2013dea665e055f",
  measurementId: "G-NXX4GQZ4NF"
};

// Initialize Firebase with error handling
let app;
try {
    app = firebase.initializeApp(firebaseConfig);
} catch (error) {
    if (error.code === 'app/duplicate-app') {
        app = firebase.app();
    } else {
        console.error('Firebase initialization error:', error);
    }
}
const database = firebase.database();

// Session management - unique for each device
if (!sessionStorage.getItem('playerSessionId')) {
    sessionStorage.setItem('playerSessionId', 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9));
}

// Tab switching functionality
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');

    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    event.target.classList.add('active');

    if (tabName === 'host') {
        loadHostTimeSettings();
    }
}

// Initialize variables
var questions = [];
var currentIndex = 0;
var playerName = "";
var countdownInterval;
var timeLeft = 15;
var questionStartTime;
var quizActive = false;
var adminCode = "adminHafsa";

// Quiz timing configuration
var quizStartTime = localStorage.getItem('quizStartTime');
var quizEndTime = localStorage.getItem('quizEndTime');

if (!quizStartTime) {
    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(12, 0, 0, 0);
    quizStartTime = tomorrow.getTime();
    localStorage.setItem('quizStartTime', quizStartTime);
} else {
    quizStartTime = parseInt(quizStartTime);
}

if (!quizEndTime) {
    var endTime = new Date(quizStartTime);
    endTime.setMinutes(endTime.getMinutes() + 30);
    quizEndTime = endTime.getTime();
    localStorage.setItem('quizEndTime', quizEndTime);
} else {
    quizEndTime = parseInt(quizEndTime);
}

// Load data from Firebase
function loadDataFromFirebase() {
    if (!firebase.apps.length) {
        setTimeout(loadDataFromFirebase, 1000);
        return;
    }

    database.ref('quizTime').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            quizStartTime = data.startTime;
            quizEndTime = data.endTime;
            localStorage.setItem('quizStartTime', quizStartTime);
            localStorage.setItem('quizEndTime', quizEndTime);
            updateQuizTimeInfo();
        }
    });

    database.ref('questions').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            questions = Object.values(data);
            localStorage.setItem('quizQuestions', JSON.stringify(questions));
            displayQuestions();
            
            if (document.getElementById('player').classList.contains('active') && 
                document.getElementById('player-question').innerHTML !== "") {
                showPlayerQuestion();
            }
        }
    });
}

// Initialize Firebase data structure
function initializeFirebaseData() {
    const statusElement = document.getElementById('firebase-init-status');
    if (statusElement) {
        statusElement.textContent = "Initializing Firebase data...";
        statusElement.className = 'url-status';
    }
    
    database.ref('quizTime').once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(12, 0, 0, 0);
            var startTime = tomorrow.getTime();
            var endTime = new Date(tomorrow.getTime() + 30 * 60000).getTime();
            
            return database.ref('quizTime').set({
                startTime: startTime,
                endTime: endTime
            });
        }
    }).then(() => {
        return database.ref('questions').once('value');
    }).then((snapshot) => {
        if (!snapshot.exists()) {
            const defaultQuestions = [
                {
                    question: "What is 2 + 2?",
                    answers: ["3", "4", "5", "6"],
                    correct: "4"
                },
                {
                    question: "Capital of France?",
                    answers: ["London", "Paris", "Berlin", "Rome"],
                    correct: "Paris"
                }
            ];
            return database.ref('questions').set(defaultQuestions);
        }
    }).then(() => {
        if (statusElement) {
            statusElement.textContent = "Firebase data initialized successfully!";
            statusElement.className = 'url-status success';
        }
        loadDataFromFirebase();
    }).catch((error) => {
        if (statusElement) {
            statusElement.textContent = "Error initializing Firebase: " + error.message;
            statusElement.className = 'url-status error';
        }
    });
}

// Save quiz time to Firebase
function saveQuizTimeToFirebase(startTime, endTime) {
    database.ref('quizTime').set({
        startTime: startTime,
        endTime: endTime
    }).then(() => {
        document.getElementById('host-time-status').textContent = 'Quiz time saved successfully!';
        document.getElementById('host-time-status').className = 'url-status success';
    }).catch((error) => {
        document.getElementById('host-time-status').textContent = 'Error saving quiz time: ' + error.message;
        document.getElementById('host-time-status').className = 'url-status error';
    });
}

// Save questions to Firebase
function saveQuestionsToFirebase() {
    database.ref('questions').set(questions).then(() => {
        document.getElementById('question-status').textContent = 'Questions saved successfully!';
        document.getElementById('question-status').className = 'url-status success';
    }).catch((error) => {
        document.getElementById('question-status').textContent = 'Error saving questions: ' + error.message;
        document.getElementById('question-status').className = 'url-status error';
    });
}

// Save quiz results to Firebase with session management
function saveToFirebase(playerName, question, selectedAnswer, correctAnswer, responseTime, status) {
    const responseId = database.ref().child('quizResults').push().key;
    
    const quizData = {
        player: playerName || "Unknown Player",
        question: question || "Unknown Question",
        selectedAnswer: selectedAnswer || "No Answer",
        correctAnswer: correctAnswer || "Unknown",
        responseTime: responseTime || 0,
        status: status || "Unknown",
        timestamp: new Date().toISOString(),
        questionIndex: currentIndex,
        sessionId: sessionStorage.getItem('playerSessionId'),
        deviceType: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
    };

    // Efficient save with error handling
    database.ref('quizResults/' + responseId).set(quizData)
        .then(() => {
            console.log("Data saved successfully for session:", quizData.sessionId);
        })
        .catch((error) => {
            console.error("Save error, retrying:", error);
            // Simple retry logic
            setTimeout(() => {
                database.ref('quizResults/' + responseId).set(quizData);
            }, 500);
        });
}

// Export functions
function exportToExcel() {
    database.ref('quizResults').once('value')
        .then((snapshot) => {
            const results = snapshot.val();
            if (!results) {
                alert('No results to export.');
                return;
            }
            
            const data = Object.values(results);
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Quiz Results");
            XLSX.writeFile(workbook, 'quiz-results.xlsx');
            alert('Excel file downloaded successfully!');
        })
        .catch((error) => {
            console.error("Error exporting to Excel:", error);
            alert('Error exporting data.');
        });
}

function exportToCSV() {
    database.ref('quizResults').once('value')
        .then((snapshot) => {
            const results = snapshot.val();
            if (!results) {
                alert('No results to export.');
                return;
            }
            
            const data = Object.values(results);
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quiz-results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            alert('CSV file downloaded successfully!');
        })
        .catch((error) => {
            console.error("Error exporting to CSV:", error);
            alert('Error exporting data.');
        });
}

function convertToCSV(data) {
    if (data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvRows = [];
    csvRows.push(headers.join(','));
    
    for (const row of data) {
        const values = headers.map(header => {
            const value = row[header] || '';
            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
        });
        csvRows.push(values.join(','));
    }
    
    return csvRows.join('\n');
}

// Delete all quiz results
function deleteAllResults() {
    database.ref('quizResults').remove()
        .then(() => {
            alert('All quiz results have been deleted successfully!');
            loadQuizResults(); // Refresh the results display
        })
        .catch((error) => {
            console.error("Error deleting results:", error);
            alert('Error deleting results. Please try again.');
        });
}

// Confirm before deleting results
function confirmDeleteResults() {
    if (confirm('‚ö†Ô∏è Are you sure you want to delete ALL quiz results?\n\nThis action cannot be undone!')) {
        if (confirm('üö® FINAL WARNING: This will permanently delete all quiz data. Continue?')) {
            deleteAllResults();
        }
    }
}

// Load and display quiz results
function loadQuizResults() {
    const resultsContainer = document.getElementById('results-container');
    resultsContainer.innerHTML = '<p>Loading results...</p>';
    
    database.ref('quizResults').once('value')
        .then((snapshot) => {
            const results = snapshot.val();
            resultsContainer.innerHTML = '';
            
            if (!results) {
                resultsContainer.innerHTML = '<p>No results yet. Results will appear here as players answer questions.</p>';
                return;
            }
            
            const resultsArray = Object.values(results);
            const totalResponses = resultsArray.length;
            const correctAnswers = resultsArray.filter(r => r.selectedAnswer === r.correctAnswer).length;
            const accuracy = totalResponses > 0 ? ((correctAnswers / totalResponses) * 100).toFixed(1) : 0;
            const avgResponseTime = totalResponses > 0 ? 
                (resultsArray.reduce((sum, r) => sum + (r.responseTime || 0), 0) / totalResponses).toFixed(2) : 0;
            
            // Count unique players by session ID
            const uniqueSessions = new Set(resultsArray.map(r => r.sessionId));
            const uniquePlayers = uniqueSessions.size;
            
            let resultsHTML = `
                <div class="stats-container">
                    <h3>Quiz Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number">${uniquePlayers}</span>
                            <span class="stat-label">Unique Players</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${totalResponses}</span>
                            <span class="stat-label">Total Responses</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${correctAnswers}</span>
                            <span class="stat-label">Correct Answers</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${accuracy}%</span>
                            <span class="stat-label">Accuracy</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${avgResponseTime}s</span>
                            <span class="stat-label">Avg Response Time</span>
                        </div>
                    </div>
                </div>
            `;
            
            resultsHTML += '<div class="results-table">';
            resultsHTML += '<div class="result-header">';
            resultsHTML += '<span>Player</span><span>Question</span><span>Answer</span><span>Correct</span><span>Time</span><span>Status</span><span>Device</span>';
            resultsHTML += '</div>';
            
            resultsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            resultsArray.forEach((result) => {
                const isCorrect = result.selectedAnswer === result.correctAnswer;
                const shortQuestion = result.question.length > 30 ? 
                    result.question.substring(0, 30) + '...' : result.question;
                
                resultsHTML += `
                    <div class="result-row ${isCorrect ? 'correct' : 'incorrect'}">
                        <span>${result.player}</span>
                        <span title="${result.question}">${shortQuestion}</span>
                        <span>${result.selectedAnswer}</span>
                        <span>${result.correctAnswer}</span>
                        <span>${result.responseTime}s</span>
                        <span>${result.status}</span>
                        <span>${result.deviceType}</span>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';
            resultsContainer.innerHTML = resultsHTML;
        })
        .catch((error) => {
            console.error("Error loading results:", error);
            resultsContainer.innerHTML = '<p>Error loading results.</p>';
        });
}

// Load questions from localStorage
var savedQuestions = localStorage.getItem('quizQuestions');
if (savedQuestions) {
    questions = JSON.parse(savedQuestions);
}

// Load host time settings
function loadHostTimeSettings() {
    var quizDate = new Date(quizStartTime);
    document.getElementById('host-quiz-date').value = quizDate.toISOString().split('T')[0];

    var startTime = new Date(quizStartTime);
    var hours = startTime.getHours();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;

    document.getElementById('host-start-hour').value = hours;
    document.getElementById('host-start-minute').value = startTime.getMinutes();
    document.getElementById('host-start-ampm').value = ampm;

    var duration = Math.round((quizEndTime - quizStartTime) / 60000);
    document.getElementById('host-quiz-duration').value = duration;

    displayQuestions();
}

// Verify admin code - SECURE: Password never visible to others
function verifyAdmin() {
    var code = document.getElementById('admin-code').value;
    var status = document.getElementById('admin-status');

    // Clear the password field for security
    document.getElementById('admin-code').value = '';

    if (code === adminCode) {
        document.getElementById('admin-features').style.display = 'block';
        status.textContent = 'Admin access granted! Features unlocked.';
        status.className = 'url-status success';
        loadQuizResults();
        
        // Hide the admin login section after successful login
        document.querySelector('.admin-section:first-child').style.display = 'none';
    } else {
        status.textContent = 'Invalid admin code. Please try again.';
        status.className = 'url-status error';
    }
}

// Save quiz time configuration
function saveHostQuizTime() {
    var date = document.getElementById('host-quiz-date').value;
    var hour = parseInt(document.getElementById('host-start-hour').value);
    var minute = parseInt(document.getElementById('host-start-minute').value);
    var ampm = document.getElementById('host-start-ampm').value;
    var duration = document.getElementById('host-quiz-duration').value;

    if (!date || isNaN(hour) || isNaN(minute) || !duration) {
        document.getElementById('host-time-status').textContent = 'Please fill in all fields correctly';
        document.getElementById('host-time-status').className = 'url-status error';
        return;
    }

    if (ampm === 'PM' && hour < 12) hour += 12;
    else if (ampm === 'AM' && hour === 12) hour = 0;

    var startDate = new Date(date);
    startDate.setHours(hour, minute, 0, 0);
    var endDate = new Date(startDate.getTime() + parseInt(duration) * 60000);

    quizStartTime = startDate.getTime();
    quizEndTime = endDate.getTime();

    saveQuizTimeToFirebase(quizStartTime, quizEndTime);
    updateQuizTimeInfo();

    setTimeout(() => {
        document.getElementById('host-time-status').textContent = 'Quiz time configuration saved';
        document.getElementById('host-time-status').className = 'url-status';
    }, 3000);
}

// Add a new question
function addQuestion() {
    var questionText = document.getElementById('question-text').value;
    var answer1 = document.getElementById('answer-1').value;
    var answer2 = document.getElementById('answer-2').value;
    var answer3 = document.getElementById('answer-3').value;
    var answer4 = document.getElementById('answer-4').value;

    if (!questionText || !answer1 || !answer2 || !answer3 || !answer4) {
        document.getElementById('question-status').textContent = 'Please fill in all fields';
        document.getElementById('question-status').className = 'url-status error';
        return;
    }

    var correctAnswerIndex = parseInt(document.querySelector('input[name="correct-answer"]:checked').value);
    var answers = [answer1, answer2, answer3, answer4];
    var correctAnswer = answers[correctAnswerIndex];

    var newQuestion = {
        question: questionText,
        answers: answers,
        correct: correctAnswer
    };

    questions.push(newQuestion);
    saveQuestionsToFirebase();

    document.getElementById('question-status').textContent = 'Question added successfully!';
    document.getElementById('question-status').className = 'url-status success';

    document.getElementById('question-text').value = '';
    document.getElementById('answer-1').value = '';
    document.getElementById('answer-2').value = '';
    document.getElementById('answer-3').value = '';
    document.getElementById('answer-4').value = '';
    document.querySelector('input[name="correct-answer"][value="0"]').checked = true;

    setTimeout(() => {
        document.getElementById('question-status').textContent = 'Add a new question to the quiz';
        document.getElementById('question-status').className = 'url-status';
    }, 3000);
}

// Display all questions
function displayQuestions() {
    var container = document.getElementById('questions-container');
    container.innerHTML = '';

    if (questions.length === 0) {
        container.innerHTML = '<p>No questions added yet.</p>';
        return;
    }

    questions.forEach((q, index) => {
        var questionItem = document.createElement('div');
        questionItem.className = 'question-item';
        var correctIndex = q.answers.indexOf(q.correct);

        questionItem.innerHTML = `
            <strong>Q${index + 1}:</strong> ${q.question}
            <div class="response-time">Correct answer: ${q.correct} (Option ${correctIndex + 1})</div>
            <div class="admin-controls">
                <button class="admin-btn edit" onclick="editQuestion(${index})">Edit</button>
                <button class="admin-btn delete" onclick="deleteQuestion(${index})">Delete</button>
            </div>
        `;
        container.appendChild(questionItem);
    });
}

// Edit a question
function editQuestion(index) {
    var q = questions[index];
    document.getElementById('question-text').value = q.question;
    document.getElementById('answer-1').value = q.answers[0];
    document.getElementById('answer-2').value = q.answers[1];
    document.getElementById('answer-3').value = q.answers[2];
    document.getElementById('answer-4').value = q.answers[3];

    var correctIndex = q.answers.indexOf(q.correct);
    document.querySelector(`input[name="correct-answer"][value="${correctIndex}"]`).checked = true;

    questions.splice(index, 1);
    saveQuestionsToFirebase();
    document.getElementById('question-status').textContent = 'Editing question. Update the fields and click "Add Question" to save changes.';
    document.getElementById('question-status').className = 'url-status';
}

// Delete a question
// Edit both question and answer with one button

function editQuestion(index) {

    const currentQuestion = questions[index];

    // Edit question text

    const newQuestion = prompt('Edit the question:', currentQuestion.question);

    if (newQuestion === null) return; // User cancelled

    if (newQuestion.trim() === '') {

        alert('Question cannot be empty!');

        return;

    }

    // Edit correct answer

    const newAnswer = prompt('Edit the correct answer:', currentQuestion.correctAnswer);

    if (newAnswer === null) return; // User cancelled

    if (newAnswer.trim() === '') {

        alert('Answer cannot be empty!');

        return;

    }

    // Update both

    questions[index].question = newQuestion.trim();

    questions[index].correctAnswer = newAnswer.trim();

    saveQuestionsToFirebase();

    renderQuestions();

}

// Delete function with last question protection

function deleteQuestion(index) {

    if (questions.length <= 1) {

        alert('You cannot delete the last question. You can edit it instead!');

        return;

    }

    if (confirm('Are you sure you want to delete this question?')) {

        questions.splice(index, 1);

        saveQuestionsToFirebase();

        renderQuestions();

    }

}
 
function editQuestion(index) {
   const newText = prompt('Edit your question:', questions[index].text);
   if (newText !== null && newText.trim() !== '') {
       questions[index].text = newText.trim();
       saveQuestionsToFirebase();
       renderQuestions();
   }
}

// Update quiz time info display
function updateQuizTimeInfo() {
    var start = new Date(quizStartTime);
    var end = new Date(quizEndTime);

    var options = {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    };

    var timeRange = start.toLocaleDateString('en-US', options) + ' to ' +
        end.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

    document.getElementById('quiz-time-range').textContent = timeRange;

    var now = new Date().getTime();
    var quizTimer = document.getElementById('quiz-timer');
    var quizStatus = document.getElementById('quiz-status-text');

    if (now < quizStartTime) {
        var timeUntilStart = Math.floor((quizStartTime - now) / 1000);
        var hours = Math.floor(timeUntilStart / 3600);
        var minutes = Math.floor((timeUntilStart % 3600) / 60);
        var seconds = timeUntilStart % 60;

        quizTimer.textContent = `Starts in: ${hours}h ${minutes}m ${seconds}s`;
        quizStatus.textContent = 'Not started';
        quizStatus.style.color = '#ff9800';
        quizActive = false;
    } else if (now >= quizStartTime && now <= quizEndTime) {
        var timeLeft = Math.floor((quizEndTime - now) / 1000);
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;

        quizTimer.textContent = `Time left: ${minutes}m ${seconds}s`;
        quizStatus.textContent = 'Active';
        quizStatus.style.color = '#4caf50';
        quizActive = true;
    } else {
        quizTimer.textContent = 'Quiz ended';
        quizStatus.textContent = 'Ended';
        quizStatus.style.color = '#f44336';
        quizActive = false;
    }
}

// Countdown timer function
function startCountdown() {
    timeLeft = 15;
    document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

    clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            var q = questions[currentIndex];
            var responseTime = (Date.now() - questionStartTime) / 1000;
            var currentPlayerName = playerName || "Unknown Player";
            saveToFirebase(currentPlayerName, q.question, "No Answer", q.correct, responseTime, "Unanswered");
            moveToNextQuestion();
        }
    }, 1000);
}

// Move to next question automatically
function moveToNextQuestion() {
    currentIndex++;
    if (currentIndex < questions.length) {
        showPlayerQuestion();
    } else {
        document.getElementById('player-question').innerHTML = "<h3>Quiz Completed!</h3>";
        document.getElementById('player-answers').innerHTML = "";
        document.getElementById('countdown').textContent = "";
    }
}

// Player view functions
function showPlayerQuestion() {
    var q = questions[currentIndex];
    document.getElementById("player-question").innerHTML = "<h3>Question " + (currentIndex + 1) + ":</h3><p>" + q.question + "</p>";

    var answersDiv = document.getElementById("player-answers");
    answersDiv.innerHTML = "<h3>Select your answer:</h3>";

    questionStartTime = Date.now();

    q.answers.forEach(a => {
        var btn = document.createElement("button");
        btn.className = "answer-btn";
        btn.innerText = a;
        btn.onclick = function() {
            if (!quizActive) {
                alert("The quiz is not currently active. Please check the quiz schedule.");
                return;
            }

            var selected = a;
            var correct = q.correct;
            var responseTime = (Date.now() - questionStartTime) / 1000;

            clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = "";

            var allButtons = document.querySelectorAll('.answer-btn');
            allButtons.forEach(button => {
                button.disabled = true;
                if (button.innerText === correct) {
                    button.classList.add('correct');
                } else if (button.innerText === selected && selected !== correct) {
                    button.classList.add('incorrect');
                }
            });

            saveToFirebase(playerName, q.question, selected, correct, responseTime, "Answered");

            setTimeout(moveToNextQuestion, 5000);
        };
        answersDiv.appendChild(btn);
    });

    startCountdown();
}

// Initialize the application
document.getElementById("joinBtn").onclick = function() {
    if (!quizActive) {
        alert("The quiz is not currently active. Please check the quiz schedule.");
        return;
    }

    playerName = document.getElementById("name").value;
    if (playerName.trim() !== "") {
        document.getElementById("name").style.display = "none";
        document.getElementById("joinBtn").style.display = "none";
        showPlayerQuestion();
    } else {
        alert("Please enter your name to join the game.");
    }
};

// Update quiz timer every second
setInterval(updateQuizTimeInfo, 1000);
updateQuizTimeInfo();

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById('player').classList.add('active');

    function initializeApp() {
        try {
            loadDataFromFirebase();
        } catch (error) {
            setTimeout(initializeApp, 2000);
        }
    }
    
    initializeApp();
    
    // Show system info
    console.log("Quiz System Initialized");
    console.log("Session ID:", sessionStorage.getItem('playerSessionId'));
    console.log("Device Type:", /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'Mobile' : 'Desktop');
    console.log("Security: Admin password verification is local and secure");
});
</script>
</body>
</html>







