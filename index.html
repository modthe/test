<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kahoot FS - Interactive Quiz Platform</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- Excel Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Confetti Library -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
color: #333;
line-height: 1.6;
min-height: 100vh;
padding: 20px;
display: flex;
justify-content: center;
align-items: center;
}

.container {
width: 95%;
max-width: 1200px;
background: white;
border-radius: 12px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
overflow: hidden;
}

header {
background: linear-gradient(135deg, #6e8efb, #a777e3);
color: white;
padding: 1.5rem;
text-align: center;
position: relative;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
transition: all 0.5s ease;
}

.header-content {
display: flex;
justify-content: space-between;
align-items: center;
width: 100%;
flex-wrap: wrap;
}

.header-title {
flex: 1;
text-align: center;
}

.quiz-timer {
background: rgba(255, 255, 255, 0.2);
padding: 8px 15px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
display: flex;
align-items: center;
gap: 8px;
min-width: 180px;
justify-content: center;
}

.player-count {
background: rgba(255, 255, 255, 0.3);
padding: 8px 15px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
display: flex;
align-items: center;
gap: 8px;
min-width: 180px;
justify-content: center;
}

.player-count.active {
background: rgba(76, 175, 80, 0.3);
animation: pulse 2s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

h1 {
font-size: 2rem;
margin-bottom: 0.5rem;
background: linear-gradient(45deg, #8e44ad, #3498db, #2ecc71, #f1c40f);
background-size: 400% 400%;
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
animation: gradientShift 5s ease infinite;
}

@keyframes gradientShift {
0% { background-position: 0% 50%; }
50% { background-position: 100% 50%; }
100% { background-position: 0% 50%; }
}

.subtitle {
font-size: 1rem;
opacity: 0.9;
}

.tabs {
display: flex;
background: #f0f0f0;
border-bottom: 2px solid #ddd;
position: sticky;
top: 0;
z-index: 100;
flex-wrap: nowrap;
overflow-x: auto;
}

.tab {
padding: 1rem;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
text-align: center;
flex: 1;
font-size: 0.9rem;
min-width: 120px;
white-space: nowrap;
}

.tab:hover {
background: #e0e0e0;
}

.tab.active {
background: white;
border-bottom: 3px solid #6e8efb;
}

.content {
padding: 1.5rem;
min-height: 500px;
}

.tab-content {
display: none;
}

.tab-content.active {
display: block;
animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.card {
background: white;
border-radius: 10px;
padding: 1.5rem;
margin: 1.5rem 0;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
border-left: 4px solid #6e8efb;
}

h2 {
font-size: 1.6rem;
color: #6e8efb;
margin-bottom: 1rem;
}

h3 {
font-size: 1.3rem;
color: #a777e3;
margin: 1.2rem 0 0.8rem;
}

input, button, select, textarea {
padding: 0.8rem 1rem;
margin: 0.5rem 0;
border-radius: 5px;
border: 1px solid #ddd;
font-size: 0.9rem;
}

input, select, textarea {
width: 100%;
max-width: 300px;
}

textarea {
min-height: 100px;
resize: vertical;
}

button {
background: #6e8efb;
color: white;
border: none;
cursor: pointer;
transition: all 0.3s ease;
font-weight: 600;
}

button:hover {
background: #5a7df9;
transform: translateY(-2px);
}

button:disabled {
background: #ccc;
cursor: not-allowed;
transform: none;
}

/* Enhanced answer button styles for grid layout with better spacing */
.answers-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin: 1.5rem 0;
}

.answer-btn {
display: flex;
align-items: center;
justify-content: center;
text-align: center;
margin: 0;
padding: 1.5rem;
background: #f8f9fa;
color: #333;
border: 2px solid #ddd;
border-radius: 10px;
transition: all 0.3s ease;
font-size: 1.1rem;
font-weight: 500;
min-height: 100px;
word-wrap: break-word;
hyphens: auto;
cursor: pointer;
position: relative;
}

.answer-btn:hover {
background: #e9ecef;
transform: translateY(-3px);
border-color: #6e8efb;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* INSTANT COLOR FEEDBACK - No lag */
.answer-btn.correct {
background-color: #4caf50 !important;
color: white !important;
border-color: #4caf50 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.answer-btn.incorrect {
background-color: #f44336 !important;
color: white !important;
border-color: #f44336 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
}

.answer-btn:disabled {
opacity: 0.7;
pointer-events: none;
}

.answer-btn.other-option {
opacity: 0.6;
background: #f0f0f0;
}

/* Celebration Styles */
.celebration {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 2000;
display: flex;
justify-content: center;
align-items: center;
background: rgba(0,0,0,0.7);
animation: fadeIn 0.5s ease;
}

.celebration-content {
background: white;
padding: 2rem;
border-radius: 15px;
text-align: center;
box-shadow: 0 10px 30px rgba(0,0,0,0.3);
max-width: 500px;
animation: popIn 0.5s ease;
}

@keyframes popIn {
0% { transform: scale(0.5); opacity: 0; }
100% { transform: scale(1); opacity: 1; }
}

.celebration-title {
font-size: 2.5rem;
margin-bottom: 1rem;
color: #4caf50;
font-weight: bold;
}

.celebration-message {
font-size: 1.2rem;
margin-bottom: 1.5rem;
color: #333;
}

.encouragement {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: rgba(255,255,255,0.95);
padding: 1.5rem;
border-radius: 10px;
text-align: center;
box-shadow: 0 5px 20px rgba(0,0,0,0.2);
z-index: 1500;
animation: slideUp 0.5s ease;
max-width: 400px;
}

@keyframes slideUp {
0% { transform: translate(-50%, -30%); opacity: 0; }
100% { transform: translate(-50%, -50%); opacity: 1; }
}

.encouragement-title {
font-size: 1.8rem;
margin-bottom: 0.5rem;
font-weight: bold;
}

.encouragement-message {
font-size: 1.1rem;
margin-bottom: 1rem;
}

.encouragement.correct {
border-left: 5px solid #4caf50;
}

.encouragement.incorrect {
border-left: 5px solid #f44336;
}

/* Rank Display Styles */
.rank-display {
position: fixed;
top: 100px;
right: 20px;
background: rgba(255,255,255,0.95);
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
border-left: 4px solid #6e8efb;
z-index: 1000;
min-width: 200px;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
transition: all 0.3s ease;
}

.rank-display.celebrate {
animation: pulse 1s infinite;
border-left-color: #ffd700 !important;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

/* Final Rank Display */
.final-rank-section {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 25px;
border-radius: 15px;
margin: 20px 0;
text-align: center;
box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

/* Responsive design for mobile */
@media (max-width: 768px) {
.answers-grid {
grid-template-columns: 1fr;
gap: 15px;
}

.answer-btn {
padding: 1.2rem;
min-height: 80px;
font-size: 1rem;
}

header {
padding: 1rem;
}

.header-content {
flex-direction: column;
gap: 10px;
}

.quiz-timer, .player-count {
min-width: 100%;
}

.rank-display {
position: relative;
top: auto;
right: auto;
margin: 1rem 0;
width: 100%;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="header-content">
<div class="quiz-timer" id="quiz-timer">
‚è±Ô∏è Quiz: Not started
</div>
<div class="header-title">
<h1>Kahoot FS</h1>
<p class="subtitle">Answer questions within the time limit</p>
</div>
<div class="player-count" id="player-count">
üë§ <span id="current-player-count">0</span> Players
</div>
</div>
</header>

<div class="tabs">
<div class="tab active" onclick="switchTab('player')">Player</div>
<div class="tab" onclick="switchTab('host')">Host</div>
</div>

<div class="content">
<!-- Player Tab -->
<div id="player" class="tab-content active">
<h2>Join Quiz</h2>
<div class="time-info" id="quiz-time-info">
<p>This quiz is scheduled for <strong id="quiz-time-range">tomorrow from 12:00 PM to 12:30 PM</strong></p>
<p id="quiz-status">Status: <span id="quiz-status-text">Not started</span></p>
</div>

<div class="card">
<input id="player-code" placeholder="Enter your access code">
<button id="joinBtn">Join Game</button>

<div id="player-question"></div>
<div id="countdown" class="countdown"></div>
<div id="player-answers"></div>
</div>
</div>

<!-- Host Tab -->
<div id="host" class="tab-content">
<h2>Quiz Host (Admin)</h2>
<div class="card">
<p>Host features available after admin authentication</p>
</div>
</div>
</div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyDnt-BAUsCbQMZ-PPALhp3_tsYqcHAKEZ8",
authDomain: "thequizfs.firebaseapp.com",
databaseURL: "https://thequizfs-default-rtdb.firebaseio.com",
projectId: "thequizfs",
storageBucket: "thequizfs.firebasestorage.app",
messagingSenderId: "16144411406",
appId: "1:16144411406:web:d83affb2013dea665e055f",
measurementId: "G-NXX4GQZ4NF"
};

// Initialize Firebase
let app;
try {
app = firebase.initializeApp(firebaseConfig);
} catch (error) {
if (error.code === 'app/duplicate-app') {
app = firebase.app();
}
}
const database = firebase.database();

// Tab switching functionality
function switchTab(tabName) {
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
document.getElementById(tabName).classList.add('active');

document.querySelectorAll('.tab').forEach(tab => {
tab.classList.remove('active');
});
event.target.classList.add('active');
}

// Initialize variables
var questions = [];
var users = [];
var currentIndex = 0;
var playerCode = "";
var countdownInterval;
var timeLeft = 15;
var questionStartTime;
var quizActive = false;

// Player results tracking
var playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};

// Real-time ranking system
let playerRankings = {};
let rankingUpdateInterval = null;

// Quiz timing configuration
var quizStartTime = localStorage.getItem('quizStartTime');
var quizEndTime = localStorage.getItem('quizEndTime');

if (!quizStartTime) {
var tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
tomorrow.setHours(12, 0, 0, 0);
quizStartTime = tomorrow.getTime();
localStorage.setItem('quizStartTime', quizStartTime);
} else {
quizStartTime = parseInt(quizStartTime);
}

if (!quizEndTime) {
var endTime = new Date(quizStartTime);
endTime.setMinutes(endTime.getMinutes() + 30);
quizEndTime = endTime.getTime();
localStorage.setItem('quizEndTime', quizEndTime);
} else {
quizEndTime = parseInt(quizEndTime);
}

// Celebration messages for correct answers
const celebrationMessages = [
"Amazing! You're a quiz master! üéâ",
"Brilliant! That was the right answer! ‚ú®",
"Fantastic! You're on fire! üî•",
"Outstanding! You nailed it! üí™",
"Excellent! You're crushing it! üöÄ"
];

// Encouragement messages for incorrect answers
const encouragementMessages = [
"Don't give up! You'll get the next one! üí™",
"Almost there! Keep going! üöÄ",
"Nice try! You're learning! üìö",
"Good effort! The next one is yours! ‚ú®",
"Keep pushing! You're improving! üí´"
];

// Fast response messages
const fastResponseMessages = [
"Lightning fast! ‚ö°",
"Incredible speed! üèÉ‚Äç‚ôÇÔ∏è",
"Super quick! üöÄ",
"Blazing fast! üî•",
"Speed demon! üëπ"
];

// Load data from Firebase
function loadDataFromFirebase() {
database.ref('questions').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
questions = Object.values(data);
}
});

database.ref('users').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
users = Object.values(data);
}
});

// Track active players
database.ref('activePlayers').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
const activePlayerCount = Object.keys(data).length;
document.getElementById('current-player-count').textContent = activePlayerCount;
  
const playerCountElement = document.getElementById('player-count');
if (activePlayerCount > 0) {
playerCountElement.classList.add('active');
} else {
playerCountElement.classList.remove('active');
}
} else {
document.getElementById('current-player-count').textContent = '0';
document.getElementById('player-count').classList.remove('active');
}
});
}

// Track active player
function trackActivePlayer(playerCode, action) {
if (!playerCode) return;
  
const playerRef = database.ref('activePlayers/' + playerCode);
  
if (action === 'join') {
playerRef.set({
joinedAt: new Date().toISOString(),
playerName: users.find(u => u.code === playerCode)?.name || 'Unknown'
});
} else if (action === 'leave') {
playerRef.remove();
}
}

// Show celebration for correct answer
function showCelebration(responseTime, isFast = false) {
const existingCelebration = document.querySelector('.celebration');
if (existingCelebration) {
existingCelebration.remove();
}

const celebration = document.createElement('div');
celebration.className = 'celebration';

const randomMessage = celebrationMessages[Math.floor(Math.random() * celebrationMessages.length)];
const fastMessage = isFast ? fastResponseMessages[Math.floor(Math.random() * fastResponseMessages.length)] : '';

celebration.innerHTML = `
<div class="celebration-content">
<div class="celebration-title">üéâ Correct! üéâ</div>
<div class="celebration-message">${randomMessage}</div>
${isFast ? `<div style="font-size: 1.5rem; color: #FFD700; margin-bottom: 1rem;">${fastMessage}</div>` : ''}
<div style="font-size: 1rem; color: #666;">Response time: ${responseTime.toFixed(2)} seconds</div>
<button onclick="this.closest('.celebration').remove()" style="margin-top: 1rem; padding: 0.8rem 1.5rem; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Continue</button>
</div>
`;

document.body.appendChild(celebration);

// Trigger confetti
confetti({
particleCount: 150,
spread: 70,
origin: { y: 0.6 }
});

setTimeout(() => {
if (celebration.parentNode) {
celebration.remove();
}
}, 3000);
}

// Show encouragement for incorrect answer
function showEncouragement() {
const existingEncouragement = document.querySelector('.encouragement');
if (existingEncouragement) {
existingEncouragement.remove();
}

const encouragement = document.createElement('div');
encouragement.className = 'encouragement incorrect';

const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];

encouragement.innerHTML = `
<div class="encouragement-title">Keep Going! üí™</div>
<div class="encouragement-message">${randomMessage}</div>
<button onclick="this.closest('.encouragement').remove()" style="padding: 0.5rem 1rem; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">OK</button>
`;

document.body.appendChild(encouragement);

setTimeout(() => {
if (encouragement.parentNode) {
encouragement.remove();
}
}, 3000);
}

// Save quiz results to Firebase
function saveToFirebase(playerCode, playerName, question, selectedAnswer, correctAnswer, responseTime, status) {
const responseId = database.ref().child('quizResults').push().key;

const quizData = {
playerCode: playerCode || "Unknown Code",
playerName: playerName || "Unknown Player",
question: question || "Unknown Question",
selectedAnswer: selectedAnswer || "No Answer",
correctAnswer: correctAnswer || "Unknown",
responseTime: responseTime || 0,
status: status || "Unknown",
timestamp: new Date().toISOString(),
questionIndex: currentIndex
};

database.ref('quizResults/' + responseId).set(quizData);
}

// Countdown timer function
function startCountdown() {
timeLeft = 15;
document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

clearInterval(countdownInterval);
countdownInterval = setInterval(() => {
timeLeft--;
document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

if (timeLeft <= 0) {
clearInterval(countdownInterval);
var q = questions[currentIndex];
var responseTime = (Date.now() - questionStartTime) / 1000;

const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

saveToFirebase(playerCode, userName, q.question, "No Answer", q.correct, responseTime, "Unanswered");

playerResults.incorrect++;
playerResults.total++;
playerResults.responseTimes.push(responseTime);
playerResults.accuracy = (playerResults.correct / playerResults.total) * 100;

moveToNextQuestion();
}
}, 1000);
}

// 2-second countdown before next question
function startNextQuestionCountdown() {
var countdownTime = 2;
document.getElementById('countdown').textContent = `Next question in: ${countdownTime}s`;
document.getElementById('countdown').style.color = "#6e8efb";
document.getElementById('countdown').style.fontWeight = "bold";

var countdownInterval = setInterval(function() {
countdownTime--;
document.getElementById('countdown').textContent = `Next question in: ${countdownTime}s`;

if (countdownTime <= 0) {
clearInterval(countdownInterval);
document.getElementById('countdown').textContent = "";
moveToNextQuestion();
}
}, 1000);
}

// Move to next question automatically
function moveToNextQuestion() {
currentIndex++;

if (currentIndex < questions.length) {
showPlayerQuestion();
} else {
showPlayerResults();
}
}

// Show player results at the end of quiz with final rank
function showPlayerResults() {
stopRankingSystem();
trackActivePlayer(playerCode, 'leave');

var avgResponseTime = playerResults.responseTimes.length > 0
? (playerResults.responseTimes.reduce((a, b) => a + b, 0) / playerResults.responseTimes.length).toFixed(2)
: 0;

const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

const accuracy = playerResults.accuracy;
const passFail = accuracy >= 50 ? 'PASS' : 'FAIL';
const passFailClass = passFail === 'PASS' ? 'result-correct' : 'result-incorrect';

const currentPlayerRank = playerRankings[playerCode];
const finalRank = currentPlayerRank ? currentPlayerRank.rank : 'N/A';
const totalPlayers = Object.keys(playerRankings).length;

const liveRankDisplay = document.getElementById('current-rank-display');
if (liveRankDisplay) {
liveRankDisplay.remove();
}

document.getElementById('player-question').innerHTML = `
<div class="player-results">
<h2>üéâ Quiz Completed! üéâ</h2>
<p>Thank you for participating, ${userName}!</p>

<div class="final-rank-section">
<div style="font-size: 1.2rem; margin-bottom: 10px; opacity: 0.9;">
Your Final Rank
</div>
<div style="font-size: 3.5rem; font-weight: bold; margin: 10px 0;">
#${finalRank}
</div>
<div style="font-size: 1rem; opacity: 0.8;">
out of ${totalPlayers} players
</div>
${finalRank <= 3 ? `
<div style="margin-top: 15px; font-size: 1.5rem;">
${finalRank === 1 ? 'ü•á GOLD MEDAL!' : ''}
${finalRank === 2 ? 'ü•à SILVER MEDAL!' : ''}
${finalRank === 3 ? 'ü•â BRONZE MEDAL!' : ''}
</div>
` : ''}
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 2rem 0;">
<div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
<span style="font-size: 2.5rem; font-weight: bold; color: #4caf50;">${playerResults.correct}</span>
<div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Correct Answers</div>
</div>
<div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
<span style="font-size: 2.5rem; font-weight: bold; color: #f44336;">${playerResults.incorrect}</span>
<div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Incorrect Answers</div>
</div>
<div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
<span style="font-size: 2.5rem; font-weight: bold; color: #2196f3;">${playerResults.accuracy.toFixed(1)}%</span>
<div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Accuracy</div>
</div>
<div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
<span style="font-size: 2.5rem; font-weight: bold; color: #ff9800;">${avgResponseTime}s</span>
<div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Avg Response Time</div>
</div>
<div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
<span style="font-size: 2.5rem; font-weight: bold; class="${passFailClass}">${passFail}</span>
<div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Final Result</div>
</div>
</div>
</div>
`;

document.getElementById('player-answers').innerHTML = "";
document.getElementById('countdown').textContent = "";
}

// Enhanced player view functions with grid layout and INSTANT COLOR FEEDBACK
function showPlayerQuestion() {
if (currentIndex >= questions.length) {
showPlayerResults();
return;
}

var q = questions[currentIndex];

document.getElementById("player-question").innerHTML = "<h3>Question " + (currentIndex + 1) + " of " + questions.length + ":</h3><p>" + q.question + "</p>";

var answersDiv = document.getElementById("player-answers");
answersDiv.innerHTML = "<h3>Select your answer:</h3>";

var gridContainer = document.createElement("div");
gridContainer.className = "answers-grid";

questionStartTime = Date.now();

q.answers.forEach(a => {
var btn = document.createElement("button");
btn.className = "answer-btn";
btn.innerHTML = a;
btn.onclick = function() {
if (!quizActive) {
alert("The quiz is not currently active. Please check the quiz schedule.");
return;
}

var selected = a;
var correct = q.correct;
var responseTime = (Date.now() - questionStartTime) / 1000;

clearInterval(countdownInterval);

// INSTANT COLOR FEEDBACK - No lag
var allButtons = document.querySelectorAll('.answer-btn');
allButtons.forEach(button => {
button.disabled = true;
button.style.pointerEvents = 'none';

button.classList.remove('correct', 'incorrect', 'other-option');

if (button.innerHTML === correct) {
button.classList.add('correct');
} else if (button.innerHTML === selected) {
button.classList.add('incorrect');
} else {
button.classList.add('other-option');
}
});

// TRACK RESULTS
if (selected === correct) {
playerResults.correct++;
const isFast = responseTime < 5;
showCelebration(responseTime, isFast);
} else {
playerResults.incorrect++;
showEncouragement();
}
playerResults.total++;
playerResults.responseTimes.push(responseTime);
playerResults.accuracy = (playerResults.correct / playerResults.total) * 100;

const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

saveToFirebase(playerCode, userName, q.question, selected, correct, responseTime, "Answered");

startNextQuestionCountdown();
};
gridContainer.appendChild(btn);
});

answersDiv.appendChild(gridContainer);
startCountdown();
}

// Real-time ranking system
function startRankingSystem() {
if (rankingUpdateInterval) {
clearInterval(rankingUpdateInterval);
}
rankingUpdateInterval = setInterval(updatePlayerRankings, 2000);
}

function stopRankingSystem() {
if (rankingUpdateInterval) {
clearInterval(rankingUpdateInterval);
rankingUpdateInterval = null;
}
}

function updatePlayerRankings() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) return;

const allResults = Object.values(results);
const currentTime = Date.now();
        
const recentResults = allResults.filter(result => 
currentTime - new Date(result.timestamp).getTime() < 5 * 60 * 1000
);

const playerScores = {};
        
recentResults.forEach(result => {
if (!playerScores[result.playerCode]) {
playerScores[result.playerCode] = {
correct: 0,
totalTime: 0,
questions: 0,
lastActivity: new Date(result.timestamp).getTime(),
playerName: result.playerName
};
}
            
const player = playerScores[result.playerCode];
player.questions++;
            
if (result.selectedAnswer === result.correctAnswer) {
player.correct++;
const speedBonus = Math.max(0, 15 - result.responseTime);
player.totalTime += result.responseTime;
}
            
player.lastActivity = Math.max(player.lastActivity, new Date(result.timestamp).getTime());
});

const rankedPlayers = Object.entries(playerScores).map(([playerCode, data]) => {
const accuracy = data.questions > 0 ? (data.correct / data.questions) * 100 : 0;
const avgTime = data.correct > 0 ? (data.totalTime / data.correct) : 0;
const speedScore = Math.max(0, 100 - (avgTime * 10));
const activityRecency = (currentTime - data.lastActivity) < 60000 ? 50 : 0;
            
return {
playerCode,
playerName: data.playerName,
score: (accuracy * 0.6) + (speedScore * 0.3) + (activityRecency * 0.1),
correct: data.correct,
questions: data.questions,
accuracy: accuracy,
avgTime: avgTime
};
});

rankedPlayers.sort((a, b) => b.score - a.score);
        
playerRankings = {};
rankedPlayers.forEach((player, index) => {
playerRankings[player.playerCode] = {
rank: index + 1,
...player
};
});

updateCurrentPlayerRankDisplay();
})
.catch((error) => {
console.error("Error updating rankings:", error);
});
}

function updateCurrentPlayerRankDisplay() {
if (!playerCode || !quizActive) return;
    
const currentPlayerRank = playerRankings[playerCode];
const rankDisplay = document.getElementById('current-rank-display');
    
if (!rankDisplay) {
const newRankDisplay = document.createElement('div');
newRankDisplay.id = 'current-rank-display';
newRankDisplay.className = 'rank-display';
document.body.appendChild(newRankDisplay);
}
    
const displayElement = document.getElementById('current-rank-display');
    
if (currentPlayerRank) {
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'You';
        
displayElement.innerHTML = `
<div style="font-weight: bold; margin-bottom: 8px; color: #6e8efb;">üèÜ Live Ranking</div>
<div style="font-size: 1.5rem; font-weight: bold; color: #4caf50; text-align: center;">
#${currentPlayerRank.rank}
</div>
<div style="font-size: 0.9rem; text-align: center; margin-bottom: 8px;">
${userName}
</div>
<div style="font-size: 0.8rem; color: #666;">
üìä ${currentPlayerRank.correct}/${currentPlayerRank.questions} correct
</div>
<div style="font-size: 0.8rem; color: #666;">
‚ö° Avg: ${currentPlayerRank.avgTime ? currentPlayerRank.avgTime.toFixed(1) + 's' : 'N/A'}
</div>
<div style="font-size: 0.8rem; color: #2196f3; margin-top: 5px;">
Total Players: ${Object.keys(playerRankings).length}
</div>
`;
        
if (currentPlayerRank.rank <= 3) {
displayElement.classList.add('celebrate');
} else {
displayElement.classList.remove('celebrate');
}
} else {
displayElement.innerHTML = `
<div style="font-weight: bold; margin-bottom: 8px; color: #6e8efb;">üèÜ Live Ranking</div>
<div style="font-size: 1.5rem; font-weight: bold; color: #666; text-align: center;">
--
</div>
<div style="font-size: 0.9rem; text-align: center; margin-bottom: 8px;">
${playerCode ? 'You' : 'Join to see rank'}
</div>
<div style="font-size: 0.8rem; color: #666;">
üìä Join quiz to see ranking
</div>
<div style="font-size: 0.8rem; color: #2196f3; margin-top: 5px;">
Players: ${Object.keys(playerRankings).length}
</div>
`;
}
}

// Update quiz time info display
function updateQuizTimeInfo() {
var start = new Date(quizStartTime);
var end = new Date(quizEndTime);

var options = {
weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
hour: '2-digit', minute: '2-digit'
};

var timeRange = start.toLocaleDateString('en-US', options) + ' to ' +
end.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

document.getElementById('quiz-time-range').textContent = timeRange;

var now = new Date().getTime();
var quizTimer = document.getElementById('quiz-timer');
var quizStatus = document.getElementById('quiz-status-text');

if (now < quizStartTime) {
var timeUntilStart = Math.floor((quizStartTime - now) / 1000);
var hours = Math.floor(timeUntilStart / 3600);
var minutes = Math.floor((timeUntilStart % 3600) / 60);
var seconds = timeUntilStart % 60;

quizTimer.textContent = `‚è±Ô∏è Starts in: ${hours}h ${minutes}m ${seconds}s`;
quizStatus.textContent = 'Not started';
quizStatus.style.color = '#ff9800';
quizActive = false;
stopRankingSystem();
} else if (now >= quizStartTime && now <= quizEndTime) {
var timeLeft = Math.floor((quizEndTime - now) / 1000);
var minutes = Math.floor(timeLeft / 60);
var seconds = timeLeft % 60;

quizTimer.textContent = `‚è±Ô∏è Time left: ${minutes}m ${seconds}s`;
quizStatus.textContent = 'Active';
quizStatus.style.color = '#4caf50';
quizActive = true;
} else {
quizTimer.textContent = '‚è±Ô∏è Quiz ended';
quizStatus.textContent = 'Ended';
quizStatus.style.color = '#f44336';
quizActive = false;
stopRankingSystem();
}
}

// Join game functionality
document.getElementById("joinBtn").addEventListener("click", function() {
playerCode = document.getElementById("player-code").value.trim();
    
if (!playerCode) {
alert("Please enter your access code");
return;
}

const user = users.find(u => u.code === playerCode && u.active);
if (!user) {
alert("Invalid access code or user is not active. Please contact the quiz administrator.");
return;
}

const now = new Date().getTime();
if (now < quizStartTime) {
alert("The quiz has not started yet. Please wait for the scheduled time.");
return;
} else if (now > quizEndTime) {
alert("The quiz has ended. You can no longer participate.");
return;
}

trackActivePlayer(playerCode, 'join');
startRankingSystem();
    
document.getElementById("player-code").style.display = "none";
document.getElementById("joinBtn").style.display = "none";
    
currentIndex = 0;
playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};
showPlayerQuestion();
});

// Initialize the application
window.onload = function() {
loadDataFromFirebase();
updateQuizTimeInfo();
setInterval(updateQuizTimeInfo, 1000);
};

console.log("Kahoot FS initialized successfully!");
</script>
</body>
</html>
