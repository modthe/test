<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game with Pusher Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 95%;
            max-width: 1000px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .quiz-timer {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 1rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f0f0f0;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
            font-size: 0.9rem;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #6e8efb;
        }

        .content {
            padding: 1.5rem;
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #6e8efb;
        }

        h2 {
            font-size: 1.6rem;
            color: #6e8efb;
            margin-bottom: 1rem;
        }

        h3 {
            font-size: 1.3rem;
            color: #a777e3;
            margin: 1.2rem 0 0.8rem;
        }

        input, button, select, textarea {
            padding: 0.8rem 1rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            max-width: 300px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            background: #6e8efb;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover {
            background: #5a7df9;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .answer-btn {
            display: block;
            width: 100%;
            text-align: left;
            margin: 0.5rem 0;
            padding: 1rem;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }

        .answer-btn:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .answer-btn.correct {
            background-color: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .answer-btn.incorrect {
            background-color: #f44336;
            color: white;
            border-color: #f44336;
        }

        .instructions {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 1.2rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .instructions h3 {
            color: #ff9800;
            margin-bottom: 0.8rem;
        }

        .instructions ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .instructions li {
            margin-bottom: 0.5rem;
        }

        .sheet-config {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 1.2rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .sheet-config h3 {
            color: #2e7d32;
            margin-bottom: 0.8rem;
        }

        .code-block {
            background: #2c3e50;
            color: #f5f7fa;
            padding: 1.2rem;
            border-radius: 8px;
            font-family: monospace;
            margin: 1.2rem 0;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        .countdown {
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
            color: #6e8efb;
        }

        .url-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }

        .url-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .url-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .setup-complete {
            text-align: center;
            padding: 1.5rem;
            background: #e8f5e9;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .time-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .time-config {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .time-config h3 {
            color: #7b1fa2;
        }

        .form-group {
            margin: 1rem 0;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .admin-section {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 1.2rem;
            margin: 1.2rem 0;
            border-radius: 4px;
        }

        .admin-section h3 {
            color: #ef6c00;
        }

        .question-list {
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            background: #f9f9f9;
        }

        .question-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .question-item:last-child {
            border-bottom: none;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            margin-top: 0.5rem;
        }

        .admin-btn {
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }

        .admin-btn.edit {
            background: #ff9800;
        }

        .admin-btn.delete {
            background: #f44336;
        }

        .answer-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .answer-option input[type="text"] {
            flex: 1;
            margin-right: 10px;
        }

        .response-time {
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-input-group input {
            max-width: 120px;
        }

        .time-input-group select {
            max-width: 80px;
        }

        .player-list {
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            background: #f9f9f9;
        }

        .player-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .pusher-config {
            background: #e1f5fe;
            border-left: 4px solid #03a9f4;
            padding: 1.2rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }

        .pusher-config h3 {
            color: #0288d1;
            margin-bottom: 0.8rem;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            h1 {
                font-size: 1.8rem;
            }

            .content {
                padding: 1rem;
            }

            .quiz-timer {
                position: static;
                margin-top: 10px;
                display: inline-block;
            }

            .admin-controls {
                flex-direction: column;
            }

            .answer-option {
                flex-direction: column;
                align-items: flex-start;
            }

            .answer-option input[type="text"] {
                width: 100%;
                margin-right: 0;
                margin-bottom: 5px;
            }

            .time-input-group {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (all your existing HTML remains the same) ... -->
    </div>

    <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
    <script>
        // Initialize variables
        let pusher = null;
        let quizChannel = null;
        let currentIndex = 0;
        let playerName = "";
        let countdownInterval;
        let timeLeft = 15;
        let questionStartTime;
        let quizActive = false;
        let adminCode = "admin123";
        let players = {};
        let playerId = Math.random().toString(36).substring(2, 10);

        // Quiz timing configuration - initialize with default values
        let quizStartTime = localStorage.getItem('quizStartTime');
        let quizEndTime = localStorage.getItem('quizEndTime');

        if (!quizStartTime) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(12, 0, 0, 0);
            quizStartTime = tomorrow.getTime();
            localStorage.setItem('quizStartTime', quizStartTime);
        } else {
            quizStartTime = parseInt(quizStartTime);
        }

        if (!quizEndTime) {
            const endTime = new Date(quizStartTime);
            endTime.setMinutes(endTime.getMinutes() + 30);
            quizEndTime = endTime.getTime();
            localStorage.setItem('quizEndTime', quizEndTime);
        } else {
            quizEndTime = parseInt(quizEndTime);
        }

        // Load questions from localStorage
        let questions = [];
        const savedQuestions = localStorage.getItem('quizQuestions');
        if (savedQuestions) {
            questions = JSON.parse(savedQuestions);
        }

        // Initialize Pusher if credentials are available
        function initializePusher() {
            const appId = localStorage.getItem('pusherAppId');
            const key = localStorage.getItem('pusherKey');
            const secret = localStorage.getItem('pusherSecret');
            const cluster = localStorage.getItem('pusherCluster') || 'mt1';
            
            if (appId && key && secret) {
                pusher = new Pusher(key, {
                    cluster: cluster,
                    encrypted: true
                });
                
                quizChannel = pusher.subscribe('quiz-game-channel');
                
                // Listen for player joined events
                quizChannel.bind('player-joined', function(data) {
                    if (data.playerId !== playerId) {
                        players[data.playerId] = data.playerName;
                        updatePlayersList();
                    }
                });
                
                // Listen for quiz control events
                quizChannel.bind('quiz-control', function(data) {
                    if (data.action === 'start') {
                        quizActive = true;
                        updateQuizStatus();
                        alert('Quiz has started!');
                    } else if (data.action === 'stop') {
                        quizActive = false;
                        updateQuizStatus();
                        alert('Quiz has ended!');
                    } else if (data.action === 'next') {
                        currentIndex = data.currentIndex;
                        if (playerName) {
                            showPlayerQuestion();
                        }
                    }
                });
                
                // Listen for question events
                quizChannel.bind('new-question', function(data) {
                    if (playerName) {
                        showQuestion(data.question);
                    }
                });
                
                // NEW: Listen for timing update events
                quizChannel.bind('timing-update', function(data) {
                    quizStartTime = data.startTime;
                    quizEndTime = data.endTime;
                    localStorage.setItem('quizStartTime', quizStartTime);
                    localStorage.setItem('quizEndTime', quizEndTime);
                    updateQuizTimeInfo();
                });
                
                console.log('Pusher initialized successfully');
            }
        }

        // NEW: Function to send timing updates to all clients
        function sendTimingUpdate() {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-timing-update', {
                    startTime: quizStartTime,
                    endTime: quizEndTime
                });
            }
        }

        // Update players list in host view
        function updatePlayersList() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            
            if (Object.keys(players).length === 0) {
                playersList.innerHTML = '<p>No players connected yet</p>';
                return;
            }
            
            for (const id in players) {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                playerItem.innerHTML = `
                    <span>${players[id]}</span>
                    <span>Connected</span>
                `;
                playersList.appendChild(playerItem);
            }
        }

        // Send player joined event
        function sendPlayerJoined() {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-player-joined', {
                    playerId: playerId,
                    playerName: playerName
                });
            }
        }

        // Send quiz control event
        function sendQuizControl(action, data = {}) {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-quiz-control', {
                    action: action,
                    ...data
                });
            }
        }

        // Send new question event
        function sendNewQuestion(question) {
            if (pusher && quizChannel) {
                quizChannel.trigger('client-new-question', {
                    question: question
                });
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            event.target.classList.add('active');

            if (tabName === 'host') {
                loadHostTimeSettings();
            }
        }

        // Load host time settings into the form
        function loadHostTimeSettings() {
            const quizDate = new Date(quizStartTime);
            document.getElementById('host-quiz-date').value = quizDate.toISOString().split('T')[0];

            const startTime = new Date(quizStartTime);
            let hours = startTime.getHours();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;

            document.getElementById('host-start-hour').value = hours;
            document.getElementById('host-start-minute').value = startTime.getMinutes();
            document.getElementById('host-start-ampm').value = ampm;

            const duration = Math.round((quizEndTime - quizStartTime) / 60000);
            document.getElementById('host-quiz-duration').value = duration;

            displayQuestions();
        }

        // Verify admin code
        function verifyAdmin() {
            const code = document.getElementById('admin-code').value;
            const status = document.getElementById('admin-status');

            if (code === adminCode) {
                document.getElementById('admin-features').style.display = 'block';
                status.textContent = 'Admin access granted!';
                status.className = 'url-status success';
            } else {
                status.textContent = 'Invalid admin code. Please try again.';
                status.className = 'url-status error';
            }
        }

        // Save quiz time configuration from host tab
        function saveHostQuizTime() {
            const date = document.getElementById('host-quiz-date').value;
            const hour = parseInt(document.getElementById('host-start-hour').value);
            const minute = parseInt(document.getElementById('host-start-minute').value);
            const ampm = document.getElementById('host-start-ampm').value;
            const duration = document.getElementById('host-quiz-duration').value;

            if (!date || isNaN(hour) || isNaN(minute) || !duration) {
                document.getElementById('host-time-status').textContent = 'Please fill in all fields correctly';
                document.getElementById('host-time-status').className = 'url-status error';
                return;
            }

            // Convert to 24-hour format
            let hours24 = hour;
            if (ampm === 'PM' && hour < 12) {
                hours24 += 12;
            } else if (ampm === 'AM' && hour === 12) {
                hours24 = 0;
            }

            const startDate = new Date(date);
            startDate.setHours(hours24, minute, 0, 0);

            const endDate = new Date(startDate.getTime() + parseInt(duration) * 60000);

            quizStartTime = startDate.getTime();
            quizEndTime = endDate.getTime();

            localStorage.setItem('quizStartTime', quizStartTime);
            localStorage.setItem('quizEndTime', quizEndTime);

            // NEW: Send timing update to all clients
            sendTimingUpdate();

            document.getElementById('host-time-status').textContent = 'Quiz time saved and synchronized!';
            document.getElementById('host-time-status').className = 'url-status success';

            updateQuizTimeInfo();

            setTimeout(() => {
                document.getElementById('host-time-status').textContent = 'Quiz time configuration saved';
                document.getElementById('host-time-status').className = 'url-status';
            }, 3000);
        }

        // ... (rest of your JavaScript code remains the same) ...

        // Initialize the application
        document.getElementById("joinBtn").onclick = function() {
            if (!quizActive) {
                alert("The quiz is not currently active. Please check the quiz schedule.");
                return;
            }

            playerName = document.getElementById("name").value;
            if (playerName.trim() !== "") {
                document.getElementById("name").style.display = "none";
                document.getElementById("joinBtn").style.display = "none";

                // Send player joined event
                sendPlayerJoined();
                
                // Show first question if quiz is active
                if (quizActive && questions.length > 0) {
                    showPlayerQuestion();
                } else {
                    document.getElementById("player-question").innerHTML = "<h3>Waiting for the host to start the quiz...</h3>";
                }
            } else {
                alert("Please enter your name to join the game.");
            }
        };

        // Initial setup - show player tab by default
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById('player').classList.add('active');

        // Initialize Pusher if credentials are available
        initializePusher();

        // Initialize the quiz time display
        updateQuizTimeInfo();
    </script>
</body>
</html>
