<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منصة الاختبارات القضائية</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- Excel Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background: linear-gradient(135deg, #1a3a5f 0%, #2c5c8a 100%);
color: #333;
line-height: 1.6;
min-height: 100vh;
padding: 20px;
display: flex;
justify-content: center;
align-items: center;
}

.container {
width: 95%;
max-width: 1200px;
background: white;
border-radius: 12px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
overflow: hidden;
}

header {
background: linear-gradient(135deg, #1a3a5f, #2c5c8a);
color: white;
padding: 1.5rem;
text-align: center;
position: relative;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
}

.header-content {
display: flex;
justify-content: space-between;
align-items: center;
width: 100%;
flex-wrap: wrap;
}

.header-title {
flex: 1;
text-align: center;
}

.quiz-timer {
background: rgba(255, 255, 255, 0.2);
padding: 8px 15px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
display: flex;
align-items: center;
gap: 8px;
min-width: 180px;
justify-content: center;
}

.player-count {
background: rgba(255, 255, 255, 0.3);
padding: 8px 15px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
display: flex;
align-items: center;
gap: 8px;
min-width: 180px;
justify-content: center;
}

.player-count.active {
background: rgba(76, 175, 80, 0.3);
animation: pulse 2s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

h1 {
font-size: 2rem;
margin-bottom: 0.5rem;
}

.subtitle {
font-size: 1rem;
opacity: 0.9;
}

.tabs {
display: flex;
background: #f0f0f0;
border-bottom: 2px solid #ddd;
position: sticky;
top: 0;
z-index: 100;
flex-wrap: nowrap;
overflow-x: auto;
}

.tab {
padding: 1rem;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
text-align: center;
flex: 1;
font-size: 0.9rem;
min-width: 120px;
white-space: nowrap;
}

.tab:hover {
background: #e0e0e0;
}

.tab.active {
background: white;
border-bottom: 3px solid #1a3a5f;
}

.content {
padding: 1.5rem;
min-height: 500px;
}

.tab-content {
display: none;
}

.tab-content.active {
display: block;
animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.card {
background: white;
border-radius: 10px;
padding: 1.5rem;
margin: 1.5rem 0;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
border-left: 4px solid #1a3a5f;
}

h2 {
font-size: 1.6rem;
color: #1a3a5f;
margin-bottom: 1rem;
}

h3 {
font-size: 1.3rem;
color: #2c5c8a;
margin: 1.2rem 0 0.8rem;
}

input, button, select, textarea {
padding: 0.8rem 1rem;
margin: 0.5rem 0;
border-radius: 5px;
border: 1px solid #ddd;
font-size: 0.9rem;
}

input, select, textarea {
width: 100%;
max-width: 300px;
}

textarea {
min-height: 100px;
resize: vertical;
}

button {
background: #1a3a5f;
color: white;
border: none;
cursor: pointer;
transition: all 0.3s ease;
font-weight: 600;
}

button:hover {
background: #2c5c8a;
transform: translateY(-2px);
}

button:disabled {
background: #ccc;
cursor: not-allowed;
transform: none;
}

.answers-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin: 1.5rem 0;
}

.answer-btn {
display: flex;
align-items: center;
justify-content: center;
text-align: center;
margin: 0;
padding: 1.5rem;
background: #f8f9fa;
color: #333;
border: 2px solid #ddd;
border-radius: 10px;
transition: all 0.3s ease;
font-size: 1.1rem;
font-weight: 500;
min-height: 100px;
word-wrap: break-word;
hyphens: auto;
cursor: pointer;
position: relative;
}

.answer-btn:hover {
background: #e9ecef;
transform: translateY(-3px);
border-color: #1a3a5f;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.answer-btn.correct {
background-color: #4caf50 !important;
color: white !important;
border-color: #4caf50 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.answer-btn.incorrect {
background-color: #f44336 !important;
color: white !important;
border-color: #f44336 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
}

.answer-btn:disabled {
opacity: 0.7;
pointer-events: none;
}

.answer-btn.other-option {
opacity: 0.6;
background: #f0f0f0;
}

@media (max-width: 768px) {
.answers-grid {
grid-template-columns: 1fr;
gap: 15px;
}

.answer-btn {
padding: 1.2rem;
min-height: 80px;
font-size: 1rem;
}

header {
padding: 1rem;
}

.header-content {
flex-direction: column;
gap: 10px;
}

.quiz-timer, .player-count {
min-width: 100%;
}
}

.instructions {
background: #fff8e1;
border-left: 4px solid #ffc107;
padding: 1.2rem;
margin: 1.5rem 0;
border-radius: 4px;
}

.instructions h3 {
color: #ff9800;
margin-bottom: 0.8rem;
}

.instructions ol {
margin-right: 1.5rem;
margin-bottom: 1rem;
}

.instructions li {
margin-bottom: 0.5rem;
}

.countdown {
font-size: 1.4rem;
font-weight: bold;
text-align: center;
margin: 1rem 0;
color: #1a3a5f;
}

.url-status {
margin-top: 10px;
padding: 8px;
border-radius: 4px;
text-align: center;
font-size: 0.9rem;
}

.url-status.success {
background-color: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.url-status.error {
background-color: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

.setup-complete {
text-align: center;
padding: 1.5rem;
background: #e8f5e9;
border-radius: 8px;
margin: 1.5rem 0;
}

.time-info {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.time-config {
background: #f3e5f5;
border-left: 4px solid #9c27b0;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.time-config h3 {
color: #7b1fa2;
}

.form-group {
margin: 1rem 0;
}

label {
display: block;
margin-bottom: 0.5rem;
font-weight: 600;
}

.admin-section {
background: #fff3e0;
border-left: 4px solid #ff9800;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.admin-section h3 {
color: #ef6c00;
}

.question-list {
margin: 1rem 0;
max-height: 300px;
overflow-y: auto;
border: 1px solid #ddd;
border-radius: 5px;
padding: 1rem;
background: #f9f9f9;
}

.question-item {
padding: 0.5rem;
border-bottom: 1px solid #eee;
}

.question-item:last-child {
border-bottom: none;
}

.admin-controls {
display: flex;
gap: 10px;
margin-top: 0.5rem;
flex-wrap: wrap;
}

.admin-btn {
padding: 0.5rem 1rem;
font-size: 0.8rem;
}

.admin-btn.edit {
background: #ff9800;
}

.admin-btn.toggle {
background: #9c27b0;
}

.admin-btn.delete {
background: #f44336;
}

.answer-option {
display: flex;
align-items: center;
margin-bottom: 0.5rem;
gap: 10px;
}

.answer-option input[type="text"] {
flex: 1;
max-width: none;
}

.response-time {
font-style: italic;
color: #666;
font-size: 0.9rem;
margin-top: 5px;
}

.time-input-group {
display: flex;
align-items: center;
gap: 10px;
flex-wrap: wrap;
}

.time-input-group input {
max-width: 100px;
}

.time-input-group select {
max-width: 100px;
}

.firebase-config-help {
background: #ffebee;
border-left: 4px solid #f44336;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.firebase-config-help h3 {
color: #c62828;
}

.stats-container {
background: #f5f5f5;
padding: 1rem;
border-radius: 8px;
margin-bottom: 1rem;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin-top: 1rem;
}

.stat-card {
background: white;
padding: 1rem;
border-radius: 8px;
text-align: center;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-number {
display: block;
font-size: 1.8rem;
font-weight: bold;
color: #1a3a5f;
}

.stat-label {
font-size: 0.8rem;
color: #666;
}

.results-table {
margin-top: 1rem;
border: 1px solid #ddd;
border-radius: 5px;
overflow: auto;
max-height: 400px;
}

.result-header, .result-row {
display: grid;
grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 2fr;
gap: 1px;
padding: 0.5rem;
min-width: 800px;
}

.result-header {
background: #1a3a5f;
color: white;
font-weight: bold;
position: sticky;
top: 0;
}

.result-row {
background: #f9f9f9;
border-bottom: 1px solid #eee;
}

.result-row.correct {
background: #e8f5e9;
}

.result-row.incorrect {
background: #ffebee;
}

.result-row:last-child {
border-bottom: none;
}

.export-buttons {
display: flex;
gap: 10px;
margin: 1rem 0;
flex-wrap: wrap;
}

.export-btn {
background: #4caf50;
padding: 0.8rem 1.2rem;
}

.export-btn.csv {
background: #2196f3;
}

.export-btn.delete {
background: #f44336;
}

#admin-features {
max-height: 70vh;
overflow-y: auto;
}

.security-notice {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
font-size: 0.9rem;
}

.security-notice h4 {
color: #1565c0;
margin-bottom: 0.5rem;
}

.question-toggle {
background: #ff9800;
padding: 0.3rem 0.8rem;
font-size: 0.8rem;
margin-right: 10px;
}

.question-toggle.hidden {
background: #f44336;
}

.question-item.hidden {
opacity: 0.6;
background: #f5f5f5;
border-left: 4px solid #ff9800;
}

.status-badge {
display: inline-block;
padding: 0.2rem 0.5rem;
border-radius: 12px;
font-size: 0.7rem;
font-weight: bold;
margin-right: 10px;
}

.status-visible {
background: #4caf50;
color: white;
}

.status-hidden {
background: #f44336;
color: white;
}

.player-results {
text-align: center;
padding: 2rem;
background: #f8f9fa;
border-radius: 10px;
margin: 1rem 0;
}

.result-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin: 2rem 0;
}

.result-stat {
background: white;
padding: 1.5rem;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.result-number {
font-size: 2.5rem;
font-weight: bold;
display: block;
}

.result-correct { color: #4caf50; }
.result-incorrect { color: #f44336; }
.result-accuracy { color: #2196f3; }
.result-time { color: #ff9800; }

.result-label {
font-size: 0.9rem;
color: #666;
margin-top: 0.5rem;
}

.download-btn {
background: #4caf50;
padding: 1rem 2rem;
font-size: 1.1rem;
margin: 1rem;
}

.download-btn:hover {
background: #45a049;
transform: translateY(-2px);
}

.session-warning {
background: #fff3cd;
border-left: 4px solid #ffc107;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
text-align: center;
}

.session-warning h3 {
color: #856404;
margin-bottom: 0.5rem;
}

.user-management {
background: #e8f5e9;
border-left: 4px solid #4caf50;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.user-management h3 {
color: #2e7d32;
}

.user-list {
margin: 1rem 0;
max-height: 300px;
overflow-y: auto;
border: 1px solid #ddd;
border-radius: 5px;
padding: 1rem;
background: #f9f9f9;
}

.user-item {
padding: 0.8rem;
border-bottom: 1px solid #eee;
display: flex;
justify-content: space-between;
align-items: center;
}

.user-item:last-child {
border-bottom: none;
}

.user-info {
flex: 1;
}

.user-name {
font-weight: bold;
}

.user-code {
font-size: 0.8rem;
color: #666;
margin-top: 0.2rem;
}

.user-status {
display: inline-block;
padding: 0.2rem 0.5rem;
border-radius: 12px;
font-size: 0.7rem;
font-weight: bold;
margin-right: 10px;
}

.status-active {
background: #4caf50;
color: white;
}

.status-inactive {
background: #f44336;
color: white;
}

.user-controls {
display: flex;
gap: 5px;
}

.user-btn {
padding: 0.3rem 0.8rem;
font-size: 0.7rem;
}

.user-btn.toggle {
background: #9c27b0;
}

.user-btn.delete {
background: #f44336;
}

.user-btn.export {
background: #2196f3;
}

.user-btn.delete-results {
background: #ff9800;
}

.user-results {
margin-top: 1rem;
}

.user-result-item {
background: white;
padding: 1rem;
margin: 0.5rem 0;
border-radius: 5px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.user-result-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
}

.user-result-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 0.5rem;
margin-top: 0.5rem;
}

.user-stat {
text-align: center;
padding: 0.5rem;
background: #f5f5f5;
border-radius: 4px;
}

.user-stat-number {
font-weight: bold;
font-size: 1.2rem;
}

.user-stat-label {
font-size: 0.7rem;
color: #666;
}

.password-change {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.password-change h3 {
color: #1565c0;
}

.quiz-model {
background: #f3e5f5;
border-left: 4px solid #9c27b0;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.quiz-model h3 {
color: #7b1fa2;
}

.model-badge {
display: inline-block;
padding: 0.3rem 0.8rem;
background: #9c27b0;
color: white;
border-radius: 15px;
font-size: 0.8rem;
font-weight: bold;
margin-right: 10px;
cursor: pointer;
transition: all 0.3s ease;
}

.model-badge:hover {
background: #7b1fa2;
transform: scale(1.05);
}

.model-item {
padding: 0.8rem;
border-bottom: 1px solid #eee;
display: flex;
justify-content: space-between;
align-items: center;
cursor: pointer;
transition: all 0.3s ease;
}

.model-item:hover {
background: #f3e5f5;
}

.model-item:last-child {
border-bottom: none;
}

.model-info {
flex: 1;
}

.model-name {
font-weight: bold;
font-size: 1.1rem;
}

.model-count {
font-size: 0.8rem;
color: #666;
margin-top: 0.2rem;
}

.model-controls {
display: flex;
gap: 5px;
}

.model-btn {
padding: 0.3rem 0.8rem;
font-size: 0.7rem;
}

.model-btn.delete {
background: #f44336;
}

.model-btn.select {
background: #4caf50;
}

.model-btn.selected {
background: #2e7d32;
}

.model-btn.deselect {
background: #ff9800;
}

.active-model-display {
background: #e8f5e9;
border-left: 4px solid #4caf50;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.active-model-display h3 {
color: #2e7d32;
margin-bottom: 0.5rem;
}

.quick-nav {
display: flex;
gap: 10px;
margin: 1rem 0;
flex-wrap: wrap;
}

.quick-nav-btn {
background: #1a3a5f;
padding: 0.5rem 1rem;
font-size: 0.8rem;
}

.quick-nav-btn:hover {
background: #2c5c8a;
}

.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
}

.modal-content {
background-color: white;
margin: 10% auto;
padding: 2rem;
border-radius: 10px;
width: 90%;
max-width: 500px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
}

.close-modal {
background: none;
border: none;
font-size: 1.5rem;
cursor: pointer;
color: #666;
}

.close-modal:hover {
color: #333;
}

.model-selection-list {
max-height: 300px;
overflow-y: auto;
margin: 1rem 0;
}

.model-selection-item {
padding: 1rem;
border: 1px solid #ddd;
border-radius: 5px;
margin-bottom: 0.5rem;
cursor: pointer;
transition: all 0.3s ease;
}

.model-selection-item:hover {
background: #f5f5f5;
border-color: #1a3a5f;
}

.model-selection-item.selected {
background: #e8f5e9;
border-color: #4caf50;
}

.quiz-separator {
border-top: 2px dashed #ddd;
margin: 2rem 0;
padding-top: 1rem;
}

.quiz-title {
font-size: 1.2rem;
font-weight: bold;
color: #1a3a5f;
margin-bottom: 1rem;
padding: 0.5rem;
background: #f8f9fa;
border-radius: 5px;
}

.rank-display {
position: fixed;
top: 100px;
right: 20px;
background: rgba(255,255,255,0.95);
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
border-left: 4px solid #1a3a5f;
z-index: 1000;
min-width: 200px;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
transition: all 0.3s ease;
}

.rank-display.celebrate {
animation: pulse 1s infinite;
border-left-color: #ffd700 !important;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

.final-rank-section {
background: linear-gradient(135deg, #1a3a5f 0%, #2c5c8a 100%);
color: white;
padding: 25px;
border-radius: 15px;
margin: 20px 0;
text-align: center;
box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.question-modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
overflow: auto;
}

.question-modal-content {
background-color: white;
margin: 5% auto;
padding: 2rem;
border-radius: 10px;
width: 90%;
max-width: 800px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
max-height: 80vh;
overflow-y: auto;
}

.question-modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
border-bottom: 1px solid #eee;
padding-bottom: 1rem;
}

.question-modal-title {
font-size: 1.5rem;
color: #1a3a5f;
}

.question-modal-body {
line-height: 1.6;
}

.question-modal-answers {
margin-top: 1.5rem;
}

.answer-item {
padding: 0.8rem;
margin: 0.5rem 0;
border-radius: 5px;
background: #f8f9fa;
border-left: 4px solid #ddd;
}

.answer-item.correct {
background: #e8f5e9;
border-left-color: #4caf50;
}

.answer-item.incorrect {
background: #ffebee;
border-left-color: #f44336;
}

.host-dashboard {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

.dashboard-card {
background: white;
border-radius: 10px;
padding: 1.5rem;
box-shadow: 0 5px 15px rgba(0,0,0,0.08);
border-left: 4px solid #1a3a5f;
}

.dashboard-card h3 {
margin-top: 0;
color: #1a3a5f;
}

.dashboard-stat {
font-size: 2rem;
font-weight: bold;
margin: 1rem 0;
color: #1a3a5f;
}

.dashboard-label {
font-size: 0.9rem;
color: #666;
}

.dashboard-actions {
margin-top: 1rem;
display: flex;
gap: 10px;
flex-wrap: wrap;
}

.news-events-section {
background: #f8f9fa;
border-left: 4px solid #1a3a5f;
padding: 1.5rem;
margin: 1.5rem 0;
border-radius: 8px;
}

.news-events-tabs {
display: flex;
border-bottom: 2px solid #ddd;
margin-bottom: 1rem;
}

.news-events-tab {
padding: 0.8rem 1.5rem;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
border-bottom: 3px solid transparent;
}

.news-events-tab.active {
border-bottom-color: #1a3a5f;
color: #1a3a5f;
}

.news-events-content {
display: none;
}

.news-events-content.active {
display: block;
}

.news-item, .event-item {
background: white;
padding: 1rem;
margin: 1rem 0;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
border-right: 4px solid #1a3a5f;
}

.news-title, .event-title {
font-size: 1.2rem;
font-weight: bold;
color: #1a3a5f;
margin-bottom: 0.5rem;
}

.news-date, .event-date {
font-size: 0.9rem;
color: #666;
margin-bottom: 0.5rem;
}

.news-content, .event-description {
line-height: 1.6;
}

.event-details {
margin-top: 0.5rem;
font-size: 0.9rem;
color: #555;
}

.event-location, .event-time {
display: flex;
align-items: center;
gap: 5px;
margin: 0.3rem 0;
}

.add-news-event {
margin-top: 1.5rem;
padding: 1rem;
background: #e3f2fd;
border-radius: 8px;
}

.add-news-event h4 {
color: #1565c0;
margin-bottom: 1rem;
}

.form-row {
display: flex;
gap: 1rem;
margin-bottom: 1rem;
flex-wrap: wrap;
}

.form-row input, .form-row textarea, .form-row select {
flex: 1;
min-width: 200px;
}

@media (max-width: 768px) {
.container {
width: 100%;
margin: 10px;
padding: 0;
}

header {
padding: 1rem;
}

h1 {
font-size: 1.6rem;
}

.tabs {
flex-direction: row;
overflow-x: auto;
}

.tab {
padding: 0.8rem;
min-width: 100px;
font-size: 0.8rem;
}

.content {
padding: 1rem;
}

.admin-controls {
flex-direction: column;
}

.answer-option {
flex-direction: column;
align-items: flex-start;
}

.answer-option input[type="text"] {
width: 100%;
margin-left: 0;
margin-bottom: 5px;
}

.time-input-group {
flex-direction: column;
align-items: flex-start;
}

.time-input-group input, .time-input-group select {
max-width: 100%;
}

.result-header, .result-row {
grid-template-columns: 1fr;
font-size: 0.8rem;
min-width: auto;
}

.stats-grid {
grid-template-columns: 1fr;
}

.export-buttons {
flex-direction: column;
}

.result-stats {
grid-template-columns: 1fr;
}

.user-item {
flex-direction: column;
align-items: flex-start;
}

.user-controls {
margin-top: 0.5rem;
width: 100%;
justify-content: flex-end;
}

.model-item {
flex-direction: column;
align-items: flex-start;
}

.model-controls {
margin-top: 0.5rem;
width: 100%;
justify-content: flex-end;
}

.quick-nav {
flex-direction: column;
}

.modal-content {
margin: 5% auto;
width: 95%;
padding: 1rem;
}

.question-modal-content {
margin: 10% auto;
width: 95%;
padding: 1rem;
}

.rank-display {
position: relative;
top: auto;
right: auto;
margin: 1rem 0;
width: 100%;
}

.host-dashboard {
grid-template-columns: 1fr;
}

.form-row {
flex-direction: column;
}

.form-row input, .form-row textarea, .form-row select {
min-width: 100%;
}
}

@media (min-width: 1200px) {
.container {
max-width: 1400px;
}

.content {
padding: 2rem;
}
}

@media (max-width: 480px) {
body {
padding: 10px;
}

.container {
border-radius: 8px;
}

.card {
padding: 1rem;
margin: 1rem 0;
}

h2 {
font-size: 1.3rem;
}

h3 {
font-size: 1.1rem;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="header-content">
<div class="quiz-timer" id="quiz-timer">
⏱️ الاختبار: لم يبدأ بعد
</div>
<div class="header-title">
<h1>منصة الاختبارات القضائية</h1>
<p class="subtitle">أجب على الأسئلة في الوقت المحدد</p>
</div>
<div class="player-count" id="player-count">
👤 <span id="current-player-count">0</span> لاعبين
</div>
</div>
</header>

<div class="tabs">
<div class="tab active" onclick="switchTab('player')">المشارك</div>
<div class="tab" onclick="switchTab('host')">المشرف</div>
<div class="tab" onclick="switchTab('news-events')">النشرة والإعلانات</div>
<div class="tab" onclick="switchTab('about')">حول التطبيق</div>
</div>

<div class="content">
<!-- Player Tab -->
<div id="player" class="tab-content active">
<h2>انضم إلى الاختبار</h2>
<div class="time-info" id="quiz-time-info">
<p>هذا الاختبار مجدول لـ <strong id="quiz-time-range">غداً من 12:00 ظهراً إلى 12:30 ظهراً</strong></p>
<p id="quiz-status">الحالة: <span id="quiz-status-text">لم يبدأ بعد</span></p>
</div>

<div class="card">
<input id="player-code" placeholder="أدخل رمز الدخول الخاص بك">
<button id="joinBtn">انضم إلى الاختبار</button>

<div id="player-question"></div>
<div id="countdown" class="countdown"></div>
<div id="player-answers"></div>
</div>

<div class="instructions">
<h3>تعليمات المشارك</h3>
<ol>
<li>أدخل رمز الدخول الخاص بك واضغط "انضم إلى الاختبار"</li>
<li>انتظر حتى يبدأ المشرف الاختبار</li>
<li>اختر إجابتك عندما تظهر الأسئلة</li>
<li>سيتم تسجيل إجاباتك ووقت استجابتك</li>
<li>كل جهاز له جلسة منفصلة - لن تتعارض الرموز</li>
<li>اعرض نتائجك وقم بتنزيلها في النهاية</li>
<li><strong>ملاحظة:</strong> يمكنك إكمال الاختبار مرة واحدة فقط لكل جلسة</li>
</ol>
</div>
</div>

<!-- Host Tab -->
<div id="host" class="tab-content">
<h2>مشرف الاختبار (المسؤول)</h2>

<div class="admin-section">
<h3>الوصول الإداري</h3>
<div class="security-notice">
<h4>🔒 إشعار الأمان</h4>
<p>التحكم الإداري الخاص بك هو <strong>تحكم كامل على المنصة</strong>. تم التحقق منه بشكل آمن محلياً.</p>
</div>
<div class="form-group">
<label for="admin-code">أدخل رمز المسؤول:</label>
<input type="password" id="admin-code" placeholder="أدخل رمز المسؤول">
<button onclick="verifyAdmin()">الوصول إلى ميزات المشرف</button>
</div>
<div id="admin-status" class="url-status">أدخل رمز المسؤول للوصول إلى ميزات المشرف</div>
</div>

<div id="admin-features" style="display: none;">
<!-- Host Dashboard -->
<div class="host-dashboard">
<div class="dashboard-card">
<h3>حالة الاختبار</h3>
<div class="dashboard-stat" id="dashboard-quiz-status">لم يبدأ</div>
<div class="dashboard-label" id="dashboard-quiz-time">الوقت: --:-- - --:--</div>
<div class="dashboard-actions">
<button onclick="scrollToSection('time-config')">تعيين الوقت</button>
<button onclick="scrollToSection('quiz-model')">اختر النموذج</button>
</div>
</div>

<div class="dashboard-card">
<h3>المشاركون</h3>
<div class="dashboard-stat" id="dashboard-player-count">0</div>
<div class="dashboard-label">المشاركون النشطون</div>
<div class="dashboard-actions">
<button onclick="scrollToSection('user-management')">إدارة المستخدمين</button>
<button onclick="loadQuizResults()">عرض النتائج</button>
</div>
</div>

<div class="dashboard-card">
<h3>الأسئلة</h3>
<div class="dashboard-stat" id="dashboard-question-count">0</div>
<div class="dashboard-label">إجمالي الأسئلة</div>
<div class="dashboard-actions">
<button onclick="scrollToSection('question-management')">إضافة أسئلة</button>
<button onclick="viewAllQuestions()">عرض الكل</button>
</div>
</div>

<div class="dashboard-card">
<h3>النموذج النشط</h3>
<div class="dashboard-stat" id="dashboard-active-model">لا يوجد</div>
<div class="dashboard-label">نموذج الاختبار المحدد</div>
<div class="dashboard-actions">
<button onclick="scrollToSection('quiz-model')">تغيير النموذج</button>
<button onclick="clearActiveModel()">مسح</button>
</div>
</div>
</div>

<!-- Quick Navigation -->
<div class="quick-nav">
<button class="quick-nav-btn" onclick="scrollToSection('active-model')">النموذج النشط</button>
<button class="quick-nav-btn" onclick="scrollToSection('password-change')">كلمة المرور</button>
<button class="quick-nav-btn" onclick="scrollToSection('time-config')">وقت الاختبار</button>
<button class="quick-nav-btn" onclick="scrollToSection('quiz-model')">النماذج</button>
<button class="quick-nav-btn" onclick="scrollToSection('user-management')">المستخدمين</button>
<button class="quick-nav-btn" onclick="scrollToSection('question-management')">الأسئلة</button>
<button class="quick-nav-btn" onclick="scrollToSection('quiz-results')">النتائج</button>
</div>

<!-- Active Model Display -->
<div class="active-model-display" id="active-model">
<h3>نموذج الاختبار النشط</h3>
<p id="active-model-info">لم يتم تحديد نموذج. سيرى المشاركون جميع الأسئلة.</p>
<button onclick="clearActiveModel()" class="model-btn deselect">مسح التحديد</button>
</div>

<!-- Password Change Section -->
<div class="password-change" id="password-change">
<h3>تغيير كلمة مرور المسؤول</h3>
<div class="form-group">
<label for="current-password">كلمة المرور الحالية:</label>
<input type="password" id="current-password" placeholder="أدخل كلمة المرور الحالية">
</div>
<div class="form-group">
<label for="new-password">كلمة المرور الجديدة:</label>
<input type="password" id="new-password" placeholder="أدخل كلمة المرور الجديدة">
</div>
<div class="form-group">
<label for="confirm-password">تأكيد كلمة المرور الجديدة:</label>
<input type="password" id="confirm-password" placeholder="تأكيد كلمة المرور الجديدة">
</div>
<button onclick="changeAdminPassword()">تغيير كلمة المرور</button>
<div id="password-status" class="url-status">قم بتغيير كلمة مرور المسؤول هنا</div>
</div>

<div class="time-config" id="time-config">
<h3>تكوين توقيت الاختبار</h3>
<p>حدد متى سيكون اختبارك نشطاً</p>

<div class="form-group">
<label for="host-quiz-date">تاريخ الاختبار:</label>
<input type="date" id="host-quiz-date">
</div>

<div class="form-group">
<label for="host-start-time">وقت البدء:</label>
<div class="time-input-group">
<input type="number" id="host-start-hour" min="1" max="12" value="12" placeholder="ساعة">
<input type="number" id="host-start-minute" min="0" max="59" value="0" placeholder="دقيقة">
<select id="host-start-ampm">
<option value="AM">ص</option>
<option value="PM" selected>م</option>
</select>
</div>
</div>

<div class="form-group">
<label for="host-quiz-duration">مدة الاختبار (دقائق):</label>
<select id="host-quiz-duration">
<option value="15">15 دقيقة</option>
<option value="30" selected>30 دقيقة</option>
<option value="45">45 دقيقة</option>
<option value="60">1 ساعة</option>
<option value="90">1.5 ساعة</option>
<option value="120">2 ساعة</option>
</select>
</div>

<button onclick="saveHostQuizTime()">حفظ وقت الاختبار</button>
<div id="host-time-status" class="url-status">اضبط متى سيكون اختبارك نشطاً</div>
</div>

<!-- Quiz Models Section -->
<div class="quiz-model" id="quiz-model">
<h3>إدارة نماذج الاختبار</h3>

<div class="form-group">
<label for="model-name">اسم النموذج:</label>
<input type="text" id="model-name" placeholder="أدخل اسم النموذج">
</div>

<button onclick="addQuizModel()">إنشاء نموذج جديد</button>
<div id="model-status" class="url-status">أنشئ نماذج اختبار لتنظيم الأسئلة</div>

<div class="question-list">
<h4>النماذج الحالية - انقر لعرض الأسئلة</h4>
<div id="models-container"></div>
</div>

<!-- Model Recovery Tools -->
<div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 5px;">
<h4>🔧 أدوات استعادة النماذج</h4>
<p style="font-size: 0.9rem; margin-bottom: 0.5rem;">استخدم هذا إذا فقدت الأسئلة ارتباطها بالنموذج:</p>
<button onclick="recoverMissingModels()" class="model-btn" style="background: #ff9800;">استعادة النماذج المفقودة</button>
<button onclick="validateAllModels()" class="model-btn" style="background: #2196f3;">التحقق من جميع النماذج</button>
<button onclick="debugModelQuestions()" class="model-btn" style="background: #607d8b;">تصحيح النماذج والأسئلة</button>
</div>
</div>

<!-- User Management Section -->
<div class="user-management" id="user-management">
<h3>إدارة المستخدمين</h3>

<div class="form-group">
<label for="user-name">اسم المستخدم:</label>
<input type="text" id="user-name" placeholder="أدخل الاسم الحقيقي للمستخدم">
</div>

<div class="form-group">
<label for="user-code">رمز الدخول:</label>
<input type="text" id="user-code" placeholder="أدخل رمز دخول فريد">
</div>

<button onclick="addUser()">إضافة مستخدم</button>
<div id="user-status" class="url-status">أضف مستخدمين برموز دخول فريدة</div>

<div class="user-list">
<h4>المستخدمون الحاليون</h4>
<div id="users-container"></div>
</div>
</div>

<div class="admin-section" id="question-management">
<h3>إدارة الأسئلة</h3>

<div class="form-group">
<label for="question-model">اختر النموذج:</label>
<select id="question-model">
<option value="">-- اختر نموذجًا --</option>
</select>
</div>

<div class="form-group">
<label for="question-text">السؤال:</label>
<textarea id="question-text" placeholder="أدخل سؤالك"></textarea>
</div>

<div class="form-group">
<label>خيارات الإجابة:</label>
<div class="answer-option">
<input type="text" id="answer-1" placeholder="أدخل الإجابة 1">
<input type="radio" name="correct-answer" value="0" checked> الإجابة الصحيحة
</div>
<div class="answer-option">
<input type="text" id="answer-2" placeholder="أدخل الإجابة 2">
<input type="radio" name="correct-answer" value="1"> الإجابة الصحيحة
</div>
<div class="answer-option">
<input type="text" id="answer-3" placeholder="أدخل الإجابة 3">
<input type="radio" name="correct-answer" value="2"> الإجابة الصحيحة
</div>
<div class="answer-option">
<input type="text" id="answer-4" placeholder="أدخل الإجابة 4">
<input type="radio" name="correct-answer" value="3"> الإجابة الصحيحة
</div>
</div>

<button onclick="addQuestion()">إضافة سؤال</button>
<div id="question-status" class="url-status">أضف سؤالاً جديداً إلى الاختبار</div>
</div>

<div class="question-list">
<h3>الأسئلة الحالية <span id="current-model-display"></span></h3>
<button class="admin-btn" onclick="viewAllQuestions()" style="margin-bottom: 10px;">عرض جميع الأسئلة</button>
<div id="questions-container"></div>
</div>

<div class="admin-section" id="quiz-results">
<h3>نتائج الاختبار</h3>
<div class="export-buttons">
<button class="export-btn" onclick="exportToExcel()">📊 تصدير إلى Excel</button>
<button class="export-btn csv" onclick="exportToCSV()">📄 تصدير إلى CSV</button>
<button class="export-btn csv" onclick="downloadAllUserResults()">📥 تنزيل جميع النتائج الفردية (المحاولة الأولى فقط)</button>
<button class="export-btn delete" onclick="confirmDeleteResults()">🗑️ حذف جميع النتائج</button>
<button onclick="loadQuizResults()">🔄 تحديث النتائج</button>
</div>
<div id="results-container" class="question-list">انقر "تحديث النتائج" لتحميل بيانات الاختبار</div>

<!-- Individual User Results -->
<div class="user-results">
<h3>النتائج الفردية للمستخدمين</h3>
<div id="user-results-container"></div>
</div>
</div>
</div>

<div class="instructions">
<h3>تعليمات المشرف</h3>
<ol>
<li>أدخل رمز المسؤول للوصول إلى ميزات المشرف</li>
<li>أنشئ نماذج اختبار لتنظيم الأسئلة</li>
<li>انقر على أسماء النماذج لعرض أسئلتها</li>
<li>استخدم زر "تحديد" لتعيين نموذج كنشط للاختبار</li>
<li>استخدم زر "إلغاء التحديد" لإزالة النموذج من النشط</li>
<li>أضف مستخدمين برموز دخول فريدة</li>
<li>حدد التاريخ والوقت لاختبارك</li>
<li>أضف أسئلة باستخدام نموذج إدارة الأسئلة</li>
<li>استخدم أزرار إظهار/إخفاء للتحكم في الأسئلة النشطة</li>
<li>اعرض النتائج في قسم نتائج الاختبار</li>
<li>قم بتصدير النتائج إلى Excel أو CSV للتحليل</li>
<li>يدعم 30+ مستخدم متزامن بسهولة</li>
<li>يمنع المستخدمين من إعادة بدء الاختبار عن طريق التحديث</li>
</ol>
</div>
</div>

<!-- News and Events Tab -->
<div id="news-events" class="tab-content">
<h2>النشرة والإعلانات للموظفين</h2>

<div class="news-events-section">
<div class="news-events-tabs">
<div class="news-events-tab active" onclick="switchNewsEventsTab('news')">النشرة اليومية</div>
<div class="news-events-tab" onclick="switchNewsEventsTab('events')">الفعاليات</div>
<div class="news-events-tab" onclick="switchNewsEventsTab('add')">إضافة جديد</div>
</div>

<!-- News Content -->
<div id="news-content" class="news-events-content active">
<h3>آخر الأخبار والتحديثات</h3>
<div id="news-container">
<!-- News items will be populated here -->
</div>
</div>

<!-- Events Content -->
<div id="events-content" class="news-events-content">
<h3>الفعاليات القادمة</h3>
<div id="events-container">
<!-- Event items will be populated here -->
</div>
</div>

<!-- Add News/Event Content -->
<div id="add-content" class="news-events-content">
<div class="add-news-event">
<h4>إضافة خبر جديد أو فعالية</h4>
<div class="form-group">
<label for="item-type">النوع:</label>
<select id="item-type">
<option value="news">خبر</option>
<option value="event">فعالية</option>
</select>
</div>
<div class="form-group">
<label for="item-title">العنوان:</label>
<input type="text" id="item-title" placeholder="أدخل العنوان">
</div>
<div class="form-group">
<label for="item-content">المحتوى/الوصف:</label>
<textarea id="item-content" placeholder="أدخل المحتوى أو الوصف"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label for="item-date">التاريخ:</label>
<input type="date" id="item-date">
</div>
<div class="form-group" id="event-time-group" style="display: none;">
<label for="event-time">الوقت:</label>
<input type="time" id="event-time">
</div>
</div>
<div class="form-group" id="event-location-group" style="display: none;">
<label for="event-location">المكان:</label>
<input type="text" id="event-location" placeholder="أدخل مكان الفعالية">
</div>
<button onclick="addNewsEvent()">إضافة</button>
<div id="news-event-status" class="url-status">أضف خبراً جديداً أو فعالية للموظفين</div>
</div>
</div>
</div>
</div>

<!-- About Tab -->
<div id="about" class="tab-content">
<h2>معلومات حول منصة الاختبارات القضائية</h2>

<div class="setup-complete">
<h3>✅ منصة الاختبارات القضائية جاهزة! ✅</h3>
<p>تم تحسين تطبيق اختبارات القضاء للاستخدام الإنتاجي مع Firebase.</p>
<p><strong>السعة:</strong> 30+ مستخدم متزامن | <strong>التخزين:</strong> قاعدة بيانات Firebase في الوقت الفعلي</p>
<button onclick="switchTab('player')">انتقل إلى تبويب المشارك</button>
</div>

<div class="admin-section">
<h3>سعة منصة الاختبارات القضائية</h3>
<div class="stats-grid">
<div class="stat-card">
<span class="stat-number">100</span>
<span class="stat-label">أقصى عدد للمستخدمين المتزامنين</span>
</div>
<div class="stat-card">
<span class="stat-number">1GB</span>
<span class="stat-label">حد البيانات الشهري</span>
</div>
<div class="stat-card">
<span class="stat-number">∞</span>
<span class="stat-label">جلسات الاختبار</span>
</div>
<div class="stat-card">
<span class="stat-number">$0</span>
<span class="stat-label">التكلفة الشهرية</span>
</div>
</div>
</div>

<div class="instructions">
<h3>مميزات منصة الاختبارات القضائية</h3>
<ol>
<li><strong>التحكم الإداري:</strong> تحكم كامل في الاختبار</li>
<li><strong>حماية البيانات:</strong> جميع البيانات مشفرة في Firebase</li>
<li><strong>التصنيف في الوقت الفعلي:</strong> شاهد التصنيفات الحية أثناء الاختبار</li>
<li><strong>تصدير المحاولة الأولى:</strong> قم بتنزيل المحاولات الأولى فقط بشكل جماعي</li>
<li><strong>التصدير الفردي:</strong> قم بتصدير جميع المحاولات لمستخدمين محددين</li>
</ol>
</div>

<div class="card">
<h3>مميزات منصة الاختبارات القضائية</h3>
<ul>
<li>✅ نتائج المشاركين مع الإحصائيات</li>
<li>✅ تنزيل النتائج للمشاركين</li>
<li>✅ ملاحظات محسنة للإجابة</li>
<li>✅ حالة النجاح/الرسوب (حد 50%)</li>
<li>✅ نظام التصنيف في الوقت الفعلي</li>
</ul>
</div>
</div>
</div>
</div>

<!-- Model Selection Modal -->
<div id="modelSelectionModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>اختر النموذج للتصدير</h3>
<button class="close-modal" onclick="closeModelSelection()">&times;</button>
</div>
<div class="model-selection-list" id="modelSelectionList">
<!-- Models will be populated here -->
</div>
<div class="modal-footer">
<button onclick="exportSelectedModel()" style="background: #4caf50; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">تصدير النموذج المحدد</button>
<button onclick="closeModelSelection()" style="background: #f44336; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-right: 10px;">إلغاء</button>
</div>
</div>
</div>

<!-- Question View Modal -->
<div id="questionViewModal" class="question-modal">
<div class="question-modal-content">
<div class="question-modal-header">
<h3 class="question-modal-title">تفاصيل السؤال</h3>
<button class="close-modal" onclick="closeQuestionView()">&times;</button>
</div>
<div class="question-modal-body" id="question-modal-body">
<!-- Question details will be populated here -->
</div>
</div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyDnt-BAUsCbQMZ-PPALhp3_tsYqcHAKEZ8",
authDomain: "thequizfs.firebaseapp.com",
databaseURL: "https://thequizfs-default-rtdb.firebaseio.com",
projectId: "thequizfs",
storageBucket: "thequizfs.firebasestorage.app",
messagingSenderId: "16144411406",
appId: "1:16144411406:web:d83affb2013dea665e055f",
measurementId: "G-NXX4GQZ4NF"
};

// Initialize Firebase with error handling
let app;
try {
app = firebase.initializeApp(firebaseConfig);
} catch (error) {
if (error.code === 'app/duplicate-app') {
app = firebase.app();
} else {
console.error('Firebase initialization error:', error);
}
}
const database = firebase.database();

// Store admin password in Firebase to persist across sessions
let adminCode = "adminCourt"; // Default password

// Load admin password from Firebase on startup
function loadAdminPassword() {
database.ref('adminPassword').once('value')
.then((snapshot) => {
const savedPassword = snapshot.val();
if (savedPassword) {
adminCode = savedPassword;
console.log("Admin password loaded from Firebase");
}
})
.catch((error) => {
console.error("Error loading admin password:", error);
});
}

// Save admin password to Firebase
function saveAdminPassword(newPassword) {
database.ref('adminPassword').set(newPassword)
.then(() => {
console.log("Admin password saved to Firebase");
})
.catch((error) => {
console.error("Error saving admin password:", error);
});
}

// Session management - unique for each device with fallback for incognito mode
function getSessionId() {
// Try sessionStorage first (normal browser)
if (sessionStorage.getItem('playerSessionId')) {
return sessionStorage.getItem('playerSessionId');
}

// Try localStorage as fallback (incognito mode)
if (localStorage.getItem('playerSessionId')) {
return localStorage.getItem('playerSessionId');
}

// Create new session ID
const sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

// Try to save in sessionStorage first
try {
sessionStorage.setItem('playerSessionId', sessionId);
} catch (e) {
// If sessionStorage fails (incognito), use localStorage
localStorage.setItem('playerSessionId', sessionId);
}

return sessionId;
}

// Tab switching functionality
function switchTab(tabName) {
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
document.getElementById(tabName).classList.add('active');

document.querySelectorAll('.tab').forEach(tab => {
tab.classList.remove('active');
});

event.target.classList.add('active');

if (tabName === 'host') {
loadHostTimeSettings();
loadUsers();
loadQuizModels();
updateActiveModelDisplay();
updateDashboard();
} else if (tabName === 'news-events') {
loadNewsAndEvents();
}
}

// Switch between news and events tabs
function switchNewsEventsTab(tabName) {
document.querySelectorAll('.news-events-content').forEach(tab => {
tab.classList.remove('active');
});
document.getElementById(tabName + '-content').classList.add('active');

document.querySelectorAll('.news-events-tab').forEach(tab => {
tab.classList.remove('active');
});

event.target.classList.add('active');

// Show/hide form fields based on selection
if (tabName === 'add') {
document.getElementById('item-type').addEventListener('change', function() {
const isEvent = this.value === 'event';
document.getElementById('event-time-group').style.display = isEvent ? 'block' : 'none';
document.getElementById('event-location-group').style.display = isEvent ? 'block' : 'none';
});
}
}

// Quick navigation function
function scrollToSection(sectionId) {
document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth' });
}

// Initialize variables
var questions = [];
var users = [];
var quizModels = [];
var currentIndex = 0;
var playerCode = "";
var countdownInterval;
var timeLeft = 25;
var questionStartTime;
var quizActive = false;
var currentModelFilter = null;
var activeQuizModel = null;
var selectedUserForExport = null;
var selectedModelForExport = null;

// Player results tracking
var playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};

// Real-time ranking system
let playerRankings = {};
let rankingUpdateInterval = null;

// Quiz timing configuration
var quizStartTime = localStorage.getItem('quizStartTime');
var quizEndTime = localStorage.getItem('quizEndTime');

if (!quizStartTime) {
var tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
tomorrow.setHours(12, 0, 0, 0);
quizStartTime = tomorrow.getTime();
localStorage.setItem('quizStartTime', quizStartTime);
} else {
quizStartTime = parseInt(quizStartTime);
}

if (!quizEndTime) {
var endTime = new Date(quizStartTime);
endTime.setMinutes(endTime.getMinutes() + 30);
quizEndTime = endTime.getTime();
localStorage.setItem('quizEndTime', quizEndTime);
} else {
quizEndTime = parseInt(quizEndTime);
}

// News and Events data
var newsItems = [];
var events = [];

// Load data from Firebase
function loadDataFromFirebase() {
if (!firebase.apps.length) {
setTimeout(loadDataFromFirebase, 1000);
return;
}

// Load admin password first
loadAdminPassword();

database.ref('quizTime').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
quizStartTime = data.startTime;
quizEndTime = data.endTime;
localStorage.setItem('quizStartTime', quizStartTime);
localStorage.setItem('quizEndTime', quizEndTime);
updateQuizTimeInfo();
updateDashboard();
}
});

database.ref('questions').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
questions = Object.values(data);
} else {
questions = [];
}

localStorage.setItem('quizQuestions', JSON.stringify(questions));
displayQuestions();
updateDashboard();

if (document.getElementById('player').classList.contains('active') &&
document.getElementById('player-question').innerHTML !== "") {
showPlayerQuestion();
}
});

// Load users
database.ref('users').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
users = Object.values(data);
} else {
users = [];
}

localStorage.setItem('quizUsers', JSON.stringify(users));
if (document.getElementById('host').classList.contains('active')) {
displayUsers();
updateDashboard();
}
});

// Load quiz models
database.ref('quizModels').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
quizModels = Object.values(data);
} else {
quizModels = [];
}

localStorage.setItem('quizModels', JSON.stringify(quizModels));
if (document.getElementById('host').classList.contains('active')) {
displayQuizModels();
updateDashboard();
}
});

// Load active quiz model
database.ref('activeQuizModel').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
activeQuizModel = data;
updateActiveModelDisplay();
updateDashboard();
} else {
activeQuizModel = null;
updateActiveModelDisplay();
updateDashboard();
}
});

// Load news and events
database.ref('news').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
newsItems = Object.values(data);
} else {
newsItems = [];
}
if (document.getElementById('news-events').classList.contains('active')) {
displayNews();
}
});

database.ref('events').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
events = Object.values(data);
} else {
events = [];
}
if (document.getElementById('news-events').classList.contains('active')) {
displayEvents();
}
});

// Track active players
database.ref('activePlayers').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
const activePlayerCount = Object.keys(data).length;
document.getElementById('current-player-count').textContent = activePlayerCount;
document.getElementById('dashboard-player-count').textContent = activePlayerCount;

// Add visual feedback when players are active
const playerCountElement = document.getElementById('player-count');
if (activePlayerCount > 0) {
playerCountElement.classList.add('active');
} else {
playerCountElement.classList.remove('active');
}
} else {
document.getElementById('current-player-count').textContent = '0';
document.getElementById('dashboard-player-count').textContent = '0';
document.getElementById('player-count').classList.remove('active');
}
});
}

// Load news and events from Firebase
function loadNewsAndEvents() {
database.ref('news').once('value')
.then((snapshot) => {
const data = snapshot.val();
if (data) {
newsItems = Object.values(data);
} else {
newsItems = [];
}
displayNews();
});

database.ref('events').once('value')
.then((snapshot) => {
const data = snapshot.val();
if (data) {
events = Object.values(data);
} else {
events = [];
}
displayEvents();
});
}

// Display news items
function displayNews() {
const container = document.getElementById('news-container');
container.innerHTML = '';

if (newsItems.length === 0) {
container.innerHTML = '<p>لا توجد أخبار حالياً.</p>';
return;
}

// Sort news by date (newest first)
newsItems.sort((a, b) => new Date(b.date) - new Date(a.date));

newsItems.forEach(news => {
const newsDate = new Date(news.date).toLocaleDateString('ar-EG');
const newsItem = document.createElement('div');
newsItem.className = 'news-item';
newsItem.innerHTML = `
<div class="news-title">${news.title}</div>
<div class="news-date">${newsDate}</div>
<div class="news-content">${news.content}</div>
`;
container.appendChild(newsItem);
});
}

// Display events
function displayEvents() {
const container = document.getElementById('events-container');
container.innerHTML = '';

if (events.length === 0) {
container.innerHTML = '<p>لا توجد فعاليات حالياً.</p>';
return;
}

// Sort events by date (upcoming first)
events.sort((a, b) => new Date(a.date) - new Date(b.date));

events.forEach(event => {
const eventDate = new Date(event.date).toLocaleDateString('ar-EG');
const eventTime = event.time || '';
const eventItem = document.createElement('div');
eventItem.className = 'event-item';
eventItem.innerHTML = `
<div class="event-title">${event.title}</div>
<div class="event-date">${eventDate}</div>
<div class="event-description">${event.description}</div>
<div class="event-details">
${event.location ? `<div class="event-location">📍 ${event.location}</div>` : ''}
${event.time ? `<div class="event-time">⏰ ${event.time}</div>` : ''}
</div>
`;
container.appendChild(eventItem);
});
}

// Add new news or event
function addNewsEvent() {
const type = document.getElementById('item-type').value;
const title = document.getElementById('item-title').value;
const content = document.getElementById('item-content').value;
const date = document.getElementById('item-date').value;
const time = document.getElementById('event-time').value;
const location = document.getElementById('event-location').value;

if (!title || !content || !date) {
document.getElementById('news-event-status').textContent = 'يرجى ملء جميع الحقول المطلوبة';
document.getElementById('news-event-status').className = 'url-status error';
return;
}

const newItem = {
id: 'item-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
title: title,
date: date,
timestamp: new Date().toISOString()
};

if (type === 'news') {
newItem.content = content;
database.ref('news/' + newItem.id).set(newItem)
.then(() => {
document.getElementById('news-event-status').textContent = 'تمت إضافة الخبر بنجاح!';
document.getElementById('news-event-status').className = 'url-status success';
clearNewsEventForm();
})
.catch((error) => {
document.getElementById('news-event-status').textContent = 'خطأ في إضافة الخبر: ' + error.message;
document.getElementById('news-event-status').className = 'url-status error';
});
} else {
newItem.description = content;
if (time) newItem.time = time;
if (location) newItem.location = location;
database.ref('events/' + newItem.id).set(newItem)
.then(() => {
document.getElementById('news-event-status').textContent = 'تمت إضافة الفعالية بنجاح!';
document.getElementById('news-event-status').className = 'url-status success';
clearNewsEventForm();
})
.catch((error) => {
document.getElementById('news-event-status').textContent = 'خطأ في إضافة الفعالية: ' + error.message;
document.getElementById('news-event-status').className = 'url-status error';
});
}
}

// Clear news/event form
function clearNewsEventForm() {
document.getElementById('item-title').value = '';
document.getElementById('item-content').value = '';
document.getElementById('item-date').value = '';
document.getElementById('event-time').value = '';
document.getElementById('event-location').value = '';
}

// Update dashboard with current stats
function updateDashboard() {
// Update quiz status
const now = new Date().getTime();
let quizStatus = 'لم يبدأ';
if (now >= quizStartTime && now <= quizEndTime) {
quizStatus = 'نشط';
} else if (now > quizEndTime) {
quizStatus = 'انتهى';
}
document.getElementById('dashboard-quiz-status').textContent = quizStatus;

// Update quiz time
const start = new Date(quizStartTime);
const end = new Date(quizEndTime);
const timeRange = start.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'}) +
' - ' + end.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
document.getElementById('dashboard-quiz-time').textContent = 'الوقت: ' + timeRange;

// Update question count
document.getElementById('dashboard-question-count').textContent = questions.length;

// Update active model
if (activeQuizModel) {
const model = quizModels.find(m => m.id === activeQuizModel);
document.getElementById('dashboard-active-model').textContent = model ? model.name : 'غير معروف';
} else {
document.getElementById('dashboard-active-model').textContent = 'لا يوجد';
}
}

// Save active quiz model to Firebase
function saveActiveQuizModel(modelId) {
database.ref('activeQuizModel').set(modelId)
.then(() => {
console.log("Active quiz model saved to Firebase");
})
.catch((error) => {
console.error("Error saving active quiz model:", error);
});
}

// Clear active quiz model
function clearActiveModel() {
activeQuizModel = null;
saveActiveQuizModel(null);
updateActiveModelDisplay();
displayQuizModels();
updateDashboard();
document.getElementById('model-status').textContent = 'تم مسح النموذج النشط. سيرى المشاركون جميع الأسئلة.';
document.getElementById('model-status').className = 'url-status success';

setTimeout(() => {
document.getElementById('model-status').textContent = 'أنشئ نماذج اختبار لتنظيم الأسئلة';
document.getElementById('model-status').className = 'url-status';
}, 3000);
}

// Update active model display
function updateActiveModelDisplay() {
const activeModelInfo = document.getElementById('active-model-info');

if (activeQuizModel) {
const model = quizModels.find(m => m.id === activeQuizModel);
const modelName = model ? model.name : 'نموذج غير معروف';
const questionCount = questions.filter(q => q.modelId === activeQuizModel).length;

activeModelInfo.innerHTML = `
<strong>${modelName}</strong> - ${questionCount} أسئلة
<br><small>سيرى المشاركون فقط الأسئلة من هذا النموذج</small>
`;
} else {
activeModelInfo.innerHTML = `
<strong>لم يتم تحديد نموذج</strong>
<br><small>سيرى المشاركون جميع الأسئلة من جميع النماذج</small>
`;
}
}

// Save quiz time to Firebase
function saveQuizTimeToFirebase(startTime, endTime) {
database.ref('quizTime').set({
startTime: startTime,
endTime: endTime
}).then(() => {
document.getElementById('host-time-status').textContent = 'تم حفظ وقت الاختبار بنجاح!';
document.getElementById('host-time-status').className = 'url-status success';
updateDashboard();
}).catch((error) => {
document.getElementById('host-time-status').textContent = 'خطأ في حفظ وقت الاختبار: ' + error.message;
document.getElementById('host-time-status').className = 'url-status error';
});
}

// Save questions to Firebase
function saveQuestionsToFirebase() {
database.ref('questions').set(questions).then(() => {
document.getElementById('question-status').textContent = 'تم حفظ الأسئلة بنجاح!';
document.getElementById('question-status').className = 'url-status success';
updateDashboard();
}).catch((error) => {
document.getElementById('question-status').textContent = 'خطأ في حفظ الأسئلة: ' + error.message;
document.getElementById('question-status').className = 'url-status error';
});
}

// Save users to Firebase
function saveUsersToFirebase() {
database.ref('users').set(users).then(() => {
document.getElementById('user-status').textContent = 'تم حفظ المستخدمين بنجاح!';
document.getElementById('user-status').className = 'url-status success';
updateDashboard();
}).catch((error) => {
document.getElementById('user-status').textContent = 'خطأ في حفظ المستخدمين: ' + error.message;
document.getElementById('user-status').className = 'url-status error';
});
}

// Save quiz models to Firebase
function saveQuizModelsToFirebase() {
database.ref('quizModels').set(quizModels).then(() => {
document.getElementById('model-status').textContent = 'تم حفظ النماذج بنجاح!';
document.getElementById('model-status').className = 'url-status success';
updateDashboard();
}).catch((error) => {
document.getElementById('model-status').textContent = 'خطأ في حفظ النماذج: ' + error.message;
document.getElementById('model-status').className = 'url-status error';
});
}

// Save quiz results to Firebase
function saveToFirebase(playerCode, playerName, question, selectedAnswer, correctAnswer, responseTime, status, modelId) {
const responseId = database.ref().child('quizResults').push().key;

const quizData = {
playerCode: playerCode || "رمز غير معروف",
playerName: playerName || "مشارك غير معروف",
question: question || "سؤال غير معروف",
selectedAnswer: selectedAnswer || "لا توجد إجابة",
correctAnswer: correctAnswer || "غير معروف",
responseTime: responseTime || 0,
status: status || "غير معروف",
timestamp: new Date().toISOString(),
questionIndex: currentIndex,
sessionId: getSessionId(),
deviceType: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'جوال' : 'كمبيوتر',
modelId: modelId || "لا يوجد نموذج"
};

database.ref('quizResults/' + responseId).set(quizData)
.then(() => {
console.log("Data saved successfully for session:", quizData.sessionId);
})
.catch((error) => {
console.error("Save error, retrying:", error);
setTimeout(() => {
database.ref('quizResults/' + responseId).set(quizData);
}, 500);
});
}

// Track active player
function trackActivePlayer(playerCode, action) {
if (!playerCode) return;

const playerRef = database.ref('activePlayers/' + playerCode);

if (action === 'join') {
playerRef.set({
joinedAt: new Date().toISOString(),
playerName: users.find(u => u.code === playerCode)?.name || 'غير معروف'
});
} else if (action === 'leave') {
playerRef.remove();
}
}

// Export functions
function exportToExcel() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('لا توجد نتائج للتصدير.');
return;
}

const data = Object.values(results);
const worksheet = XLSX.utils.json_to_sheet(data);
const workbook = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(workbook, worksheet, "نتائج الاختبار");
XLSX.writeFile(workbook, 'نتائج-الاختبار.xlsx');
alert('تم تنزيل ملف Excel بنجاح!');
})
.catch((error) => {
console.error("Error exporting to Excel:", error);
alert('خطأ في تصدير البيانات.');
});
}

function exportToCSV() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('لا توجد نتائج للتصدير.');
return;
}

const data = Object.values(results);
const csv = convertToCSV(data);
const blob = new Blob([csv], { type: 'text/csv' });
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'نتائج-الاختبار.csv';
a.click();
window.URL.revokeObjectURL(url);
alert('تم تنزيل ملف CSV بنجاح!');
})
.catch((error) => {
console.error("Error exporting to CSV:", error);
alert('خطأ في تصدير البيانات.');
});
}

function convertToCSV(data) {
if (data.length === 0) return '';

const headers = Object.keys(data[0]);
const csvRows = [];
csvRows.push(headers.join(','));

for (const row of data) {
const values = headers.map(header => {
const value = row[header] || '';
if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
return `"${value.replace(/"/g, '""')}"`;
}
return value;
});
csvRows.push(values.join(','));
}

return csvRows.join('\n');
}

// Delete all quiz results
function deleteAllResults() {
database.ref('quizResults').remove()
.then(() => {
alert('تم حذف جميع نتائج الاختبار بنجاح!');
loadQuizResults();
})
.catch((error) => {
console.error("Error deleting results:", error);
alert('خطأ في حذف النتائج. يرجى المحاولة مرة أخرى.');
});
}

// Confirm before deleting results
function confirmDeleteResults() {
if (confirm('⚠️ هل أنت متأكد من أنك تريد حذف جميع نتائج الاختبار؟\n\nلا يمكن التراجع عن هذا الإجراء!')) {
if (confirm('🚨 تحذير نهائي: هذا سيحذف جميع بيانات الاختبار بشكل دائم. متابعة؟')) {
deleteAllResults();
}
}
}

// Load and display quiz results
function loadQuizResults() {
const resultsContainer = document.getElementById('results-container');
resultsContainer.innerHTML = '<p>جاري تحميل النتائج...</p>';

database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
resultsContainer.innerHTML = '';

if (!results) {
resultsContainer.innerHTML = '<p>لا توجد نتائج بعد. ستظهر النتائج هنا عندما يجيب المشاركون على الأسئلة.</p>';
return;
}

const resultsArray = Object.values(results);
const totalResponses = resultsArray.length;
const correctAnswers = resultsArray.filter(r => r.selectedAnswer === r.correctAnswer).length;
const accuracy = totalResponses > 0 ? ((correctAnswers / totalResponses) * 100).toFixed(1) : 0;
const avgResponseTime = totalResponses > 0 ?
(resultsArray.reduce((sum, r) => sum + (r.responseTime || 0), 0) / totalResponses).toFixed(2) : 0;

const uniquePlayers = new Set(resultsArray.map(r => r.playerCode)).size;

let resultsHTML = `
<div class="stats-container">
<h3>إحصائيات الاختبار</h3>
<div class="stats-grid">
<div class="stat-card">
<span class="stat-number">${uniquePlayers}</span>
<span class="stat-label">مشاركون فريدون</span>
</div>
<div class="stat-card">
<span class="stat-number">${totalResponses}</span>
<span class="stat-label">إجمالي الإجابات</span>
</div>
<div class="stat-card">
<span class="stat-number">${correctAnswers}</span>
<span class="stat-label">إجابات صحيحة</span>
</div>
<div class="stat-card">
<span class="stat-number">${accuracy}%</span>
<span class="stat-label">الدقة</span>
</div>
<div class="stat-card">
<span class="stat-number">${avgResponseTime}ثانية</span>
<span class="stat-label">متوسط وقت الاستجابة</span>
</div>
</div>
</div>
`;

resultsHTML += '<div class="results-table">';
resultsHTML += '<div class="result-header">';
resultsHTML += '<span>المشارك</span><span>السؤال</span><span>الإجابة</span><span>الصحيحة</span><span>الوقت</span><span>الحالة</span><span>الجهاز</span><span>النموذج</span>';
resultsHTML += '</div>';

resultsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

resultsArray.forEach((result) => {
const isCorrect = result.selectedAnswer === result.correctAnswer;
const shortQuestion = result.question.length > 30 ?
result.question.substring(0, 30) + '...' : result.question;
const model = quizModels.find(m => m.id === result.modelId);
const modelName = model ? model.name : 'لا يوجد نموذج';

resultsHTML += `
<div class="result-row ${isCorrect ? 'correct' : 'incorrect'}">
<span>${result.playerName} (${result.playerCode})</span>
<span title="${result.question}">${shortQuestion}</span>
<span>${result.selectedAnswer}</span>
<span>${result.correctAnswer}</span>
<span>${result.responseTime}ثانية</span>
<span>${result.status}</span>
<span>${result.deviceType}</span>
<span>${modelName}</span>
</div>
`;
});

resultsHTML += '</div>';
resultsContainer.innerHTML = resultsHTML;
})
.catch((error) => {
console.error("Error loading results:", error);
resultsContainer.innerHTML = '<p>خطأ في تحميل النتائج.</p>';
});
}

// Quiz Models Functions
function addQuizModel() {
var modelName = document.getElementById('model-name').value.trim();

if (!modelName) {
document.getElementById('model-status').textContent = 'الرجاء إدخال اسم النموذج';
document.getElementById('model-status').className = 'url-status error';
return;
}

// Check if model name already exists
if (quizModels.some(m => m.name.toLowerCase() === modelName.toLowerCase())) {
document.getElementById('model-status').textContent = 'اسم النموذج موجود مسبقاً';
document.getElementById('model-status').className = 'url-status error';
return;
}

var newModel = {
id: 'model-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
name: modelName,
createdAt: new Date().toISOString()
};

quizModels.push(newModel);
saveQuizModelsToFirebase();

document.getElementById('model-status').textContent = 'تم إنشاء النموذج بنجاح!';
document.getElementById('model-status').className = 'url-status success';

document.getElementById('model-name').value = '';

setTimeout(() => {
document.getElementById('model-status').textContent = 'أنشئ نماذج اختبار لتنظيم الأسئلة';
document.getElementById('model-status').className = 'url-status';
}, 3000);
}

function displayQuizModels() {
var container = document.getElementById('models-container');
var modelSelect = document.getElementById('question-model');

container.innerHTML = '';
modelSelect.innerHTML = '<option value="">-- اختر نموذجًا --</option>';

if (quizModels.length === 0) {
container.innerHTML = '<p>لا توجد نماذج بعد.</p>';
return;
}

quizModels.forEach((model, index) => {
const questionCount = questions.filter(q => q.modelId === model.id).length;

// Add to models container as clickable items
var modelItem = document.createElement('div');
modelItem.className = 'model-item';
modelItem.onclick = function() {
filterQuestionsByModel(model.id);
};

// Check if this model is the active one
const isActive = activeQuizModel === model.id;

modelItem.innerHTML = `
<div class="model-info">
<div class="model-name">${model.name} ${isActive ? '⭐' : ''}</div>
<div class="model-count">${questionCount} أسئلة</div>
</div>
<div class="model-controls">
${isActive ?
`<button class="model-btn deselect" onclick="event.stopPropagation(); deselectQuizModel()">إلغاء التحديد</button>` :
`<button class="model-btn select" onclick="event.stopPropagation(); selectQuizModel('${model.id}')">تحديد</button>`
}
<button class="model-btn delete" onclick="event.stopPropagation(); deleteQuizModel(${index})">حذف</button>
<button class="model-btn" onclick="event.stopPropagation(); viewModelQuestions('${model.id}')" style="background: #2196f3;">عرض</button>
</div>
`;
container.appendChild(modelItem);

// Add to model select dropdown
var option = document.createElement('option');
option.value = model.id;
option.textContent = model.name;
modelSelect.appendChild(option);
});
}

// View questions in a model
function viewModelQuestions(modelId) {
const model = quizModels.find(m => m.id === modelId);
const modelQuestions = questions.filter(q => q.modelId === modelId);

if (modelQuestions.length === 0) {
alert(`لا توجد أسئلة في النموذج "${model.name}".`);
return;
}

// Build the modal content
let modalContent = `
<h3>الأسئلة في "${model.name}"</h3>
<p>إجمالي الأسئلة: ${modelQuestions.length}</p>
<div class="question-modal-answers">
`;

modelQuestions.forEach((q, index) => {
const correctIndex = q.answers.indexOf(q.correct);
modalContent += `
<div class="answer-item">
<strong>السؤال ${index + 1}:</strong> ${q.question}
<div style="margin-top: 10px;">
${q.answers.map((answer, i) => `
<div class="answer-item ${i === correctIndex ? 'correct' : ''}" style="margin: 5px 0; padding: 8px; border-radius: 4px;">
${i === correctIndex ? '✅ ' : '❌ '} ${answer}
</div>
`).join('')}
</div>
</div>
`;
});

modalContent += `</div>`;

document.getElementById('question-modal-body').innerHTML = modalContent;
document.getElementById('questionViewModal').style.display = 'block';
}

// View all questions
function viewAllQuestions() {
if (questions.length === 0) {
alert('لا توجد أسئلة متاحة.');
return;
}

// Build the modal content
let modalContent = `
<h3>جميع الأسئلة</h3>
<p>إجمالي الأسئلة: ${questions.length}</p>
<div class="question-modal-answers">
`;

questions.forEach((q, index) => {
const model = quizModels.find(m => m.id === q.modelId);
const modelName = model ? model.name : 'لا يوجد نموذج';
const correctIndex = q.answers.indexOf(q.correct);

modalContent += `
<div class="answer-item">
<strong>السؤال ${index + 1} (${modelName}):</strong> ${q.question}
<div style="margin-top: 10px;">
${q.answers.map((answer, i) => `
<div class="answer-item ${i === correctIndex ? 'correct' : ''}" style="margin: 5px 0; padding: 8px; border-radius: 4px;">
${i === correctIndex ? '✅ ' : '❌ '} ${answer}
</div>
`).join('')}
</div>
</div>
`;
});

modalContent += `</div>`;

document.getElementById('question-modal-body').innerHTML = modalContent;
document.getElementById('questionViewModal').style.display = 'block';
}

// Close question view modal
function closeQuestionView() {
document.getElementById('questionViewModal').style.display = 'none';
}

// Select a model for the quiz
function selectQuizModel(modelId) {
activeQuizModel = modelId;
saveActiveQuizModel(modelId);

const model = quizModels.find(m => m.id === modelId);
const modelName = model ? model.name : 'نموذج غير معروف';

document.getElementById('model-status').textContent = `"${modelName}" هو الآن نموذج الاختبار النشط. سيرى المشاركون فقط الأسئلة من هذا النموذج.`;
document.getElementById('model-status').className = 'url-status success';

// Update the display
displayQuizModels();
updateActiveModelDisplay();
updateDashboard();

setTimeout(() => {
document.getElementById('model-status').textContent = 'أنشئ نماذج اختبار لتنظيم الأسئلة';
document.getElementById('model-status').className = 'url-status';
}, 5000);
}

// Deselect a model for the quiz
function deselectQuizModel() {
activeQuizModel = null;
saveActiveQuizModel(null);

document.getElementById('model-status').textContent = 'تم إلغاء تحديد النموذج. سيرى المشاركون جميع الأسئلة.';
document.getElementById('model-status').className = 'url-status success';

// Update the display
displayQuizModels();
updateActiveModelDisplay();
updateDashboard();

setTimeout(() => {
document.getElementById('model-status').textContent = 'أنشئ نماذج اختبار لتنظيم الأسئلة';
document.getElementById('model-status').className = 'url-status';
}, 5000);
}

// Filter questions by model
function filterQuestionsByModel(modelId) {
currentModelFilter = modelId;
const model = quizModels.find(m => m.id === modelId);
const modelName = model ? model.name : 'نموذج غير معروف';

// Update display header
document.getElementById('current-model-display').innerHTML = `- ${modelName}`;

// Display filtered questions
displayQuestions();
}

// Show all questions (clear filter)
function showAllQuestions() {
currentModelFilter = null;
document.getElementById('current-model-display').innerHTML = '';
displayQuestions();
}

function deleteQuizModel(index) {
const model = quizModels[index];
const modelQuestions = questions.filter(q => q.modelId === model.id);

if (modelQuestions.length > 0) {
if (!confirm(`هذا النموذج يحتوي على ${modelQuestions.length} أسئلة. حذفه سيزيل ارتباط النموذج من هذه الأسئلة. هل أنت متأكد من أنك تريد حذف هذا النموذج؟`)) {
return;
}

// Remove model association from questions instead of deleting them
questions.forEach(question => {
if (question.modelId === model.id) {
question.modelId = null;
question.modelName = null;
}
});
saveQuestionsToFirebase();
}

// If this was the active model, clear the active model
if (activeQuizModel === model.id) {
activeQuizModel = null;
saveActiveQuizModel(null);
}

quizModels.splice(index, 1);
saveQuizModelsToFirebase();
displayQuizModels();
updateDashboard();

// If we were viewing this model, show all questions
if (currentModelFilter === model.id) {
showAllQuestions();
}
}

// NEW FUNCTION: Recover questions with missing models
function recoverMissingModels() {
let recoveredCount = 0;
let assignedToDefault = 0;

questions.forEach(question => {
if (!question.modelId || question.modelId === "لا يوجد نموذج" || !quizModels.find(m => m.id === question.modelId)) {
// Try to find a model by name first
if (question.modelName && quizModels.length > 0) {
const model = quizModels.find(m => m.name === question.modelName);
if (model) {
question.modelId = model.id;
recoveredCount++;
return;
}
}

// If still no model, assign to first available model
if (quizModels.length > 0) {
const firstModel = quizModels[0];
question.modelId = firstModel.id;
question.modelName = firstModel.name;
assignedToDefault++;
}
}
});

if (recoveredCount > 0 || assignedToDefault > 0) {
saveQuestionsToFirebase();
displayQuestions();
let message = '';
if (recoveredCount > 0) message += `تم استعادة ${recoveredCount} سؤالاً بعلاقات نموذج مفقودة! `;
if (assignedToDefault > 0) message += `تم تعيين ${assignedToDefault} سؤالاً للنموذج الافتراضي.`;
alert(message);
} else {
alert('لم يتم العثور على أسئلة بنماذج مفقودة.');
}
}

// NEW FUNCTION: Validate all models and questions
function validateAllModels() {
let issuesFound = 0;

// Check for questions with missing models
questions.forEach((question, index) => {
if (!question.modelId || !quizModels.find(m => m.id === question.modelId)) {
console.warn(`السؤال ${index} به نموذج مفقود:`, question);
issuesFound++;
}
});

// Check for models with no questions
quizModels.forEach(model => {
const modelQuestions = questions.filter(q => q.modelId === model.id);
if (modelQuestions.length === 0) {
console.warn(`النموذج "${model.name}" لا يحتوي على أسئلة`);
issuesFound++;
}
});

if (issuesFound === 0) {
alert('✅ جميع النماذج والأسئلة مرتبطة بشكل صحيح!');
} else {
alert(`تم العثور على ${issuesFound} مشكلة في ربط النماذج والأسئلة. تحقق من وحدة التحكم للتفاصيل.`);
}
}

// NEW FUNCTION: Debug model and question relationships
function debugModelQuestions() {
console.log("=== DEBUG: النماذج والأسئلة ===");
console.log("إجمالي النماذج:", quizModels.length);
console.log("إجمالي الأسئلة:", questions.length);

quizModels.forEach(model => {
const modelQuestions = questions.filter(q => q.modelId === model.id);
console.log(`النموذج "${model.name}" (${model.id}): ${modelQuestions.length} أسئلة`);

modelQuestions.forEach((q, index) => {
console.log(` س${index + 1}: ${q.question.substring(0, 50)}...`);
});
});

// Check for questions without models
const orphanedQuestions = questions.filter(q => !q.modelId || !quizModels.find(m => m.id === q.modelId));
console.log("الأسئلة اليتيمة (لا يوجد نموذج صالح):", orphanedQuestions.length);

orphanedQuestions.forEach((q, index) => {
console.log(` سؤال يتيم ${index + 1}: ${q.question.substring(0, 50)}... (النموذج: ${q.modelId})`);
});

alert(`اكتمل التصحيح. تحقق من وحدة التحكم للتفاصيل.\nإجمالي النماذج: ${quizModels.length}\nإجمالي الأسئلة: ${questions.length}\nالأسئلة اليتيمة: ${orphanedQuestions.length}`);
}

// Verify admin code
function verifyAdmin() {
var code = document.getElementById('admin-code').value;
var status = document.getElementById('admin-status');

document.getElementById('admin-code').value = '';

if (code === adminCode) {
document.getElementById('admin-features').style.display = 'block';
status.textContent = 'تم منح الوصول الإداري! تم فتح الميزات.';
status.className = 'url-status success';
loadQuizResults();
updateDashboard();

document.querySelector('.admin-section:first-child').style.display = 'none';
} else {
status.textContent = 'رمز مسؤول غير صالح. يرجى المحاولة مرة أخرى.';
status.className = 'url-status error';
}
}

// Change admin password
function changeAdminPassword() {
var currentPassword = document.getElementById('current-password').value;
var newPassword = document.getElementById('new-password').value;
var confirmPassword = document.getElementById('confirm-password').value;
var status = document.getElementById('password-status');

if (currentPassword !== adminCode) {
status.textContent = 'كلمة المرور الحالية غير صحيحة.';
status.className = 'url-status error';
return;
}

if (newPassword !== confirmPassword) {
status.textContent = 'كلمات المرور الجديدة غير متطابقة.';
status.className = 'url-status error';
return;
}

if (newPassword.length < 4) {
status.textContent = 'يجب أن تكون كلمة المرور الجديدة 4 أحرف على الأقل.';
status.className = 'url-status error';
return;
}

adminCode = newPassword;
saveAdminPassword(newPassword);

status.textContent = 'تم تغيير كلمة المرور بنجاح!';
status.className = 'url-status success';

// Clear the form
document.getElementById('current-password').value = '';
document.getElementById('new-password').value = '';
document.getElementById('confirm-password').value = '';
}

// Save quiz time configuration
function saveHostQuizTime() {
var date = document.getElementById('host-quiz-date').value;
var hour = parseInt(document.getElementById('host-start-hour').value);
var minute = parseInt(document.getElementById('host-start-minute').value);
var ampm = document.getElementById('host-start-ampm').value;
var duration = document.getElementById('host-quiz-duration').value;

if (!date || isNaN(hour) || isNaN(minute) || !duration) {
document.getElementById('host-time-status').textContent = 'الرجاء ملء جميع الحقول بشكل صحيح';
document.getElementById('host-time-status').className = 'url-status error';
return;
}

if (ampm === 'PM' && hour < 12) hour += 12;
else if (ampm === 'AM' && hour === 12) hour = 0;

var startDate = new Date(date);
startDate.setHours(hour, minute, 0, 0);
var endDate = new Date(startDate.getTime() + parseInt(duration) * 60000);

quizStartTime = startDate.getTime();
quizEndTime = endDate.getTime();

saveQuizTimeToFirebase(quizStartTime, quizEndTime);
updateQuizTimeInfo();
updateDashboard();

setTimeout(() => {
document.getElementById('host-time-status').textContent = 'تم حفظ تكوين وقت الاختبار';
document.getElementById('host-time-status').className = 'url-status';
}, 3000);
}

// Add a new user
function addUser() {
var userName = document.getElementById('user-name').value;
var userCode = document.getElementById('user-code').value;

if (!userName || !userCode) {
document.getElementById('user-status').textContent = 'الرجاء ملء جميع الحقول';
document.getElementById('user-status').className = 'url-status error';
return;
}

// Check if code already exists
if (users.some(u => u.code === userCode)) {
document.getElementById('user-status').textContent = 'رمز الدخول هذا مستخدم بالفعل';
document.getElementById('user-status').className = 'url-status error';
return;
}

var newUser = {
name: userName,
code: userCode,
active: true
};

users.push(newUser);
saveUsersToFirebase();

document.getElementById('user-status').textContent = 'تم إضافة المستخدم بنجاح!';
document.getElementById('user-status').className = 'url-status success';

document.getElementById('user-name').value = '';
document.getElementById('user-code').value = '';

setTimeout(() => {
document.getElementById('user-status').textContent = 'أضف مستخدمين برموز دخول فريدة';
document.getElementById('user-status').className = 'url-status';
}, 3000);
}

// Display all users
function displayUsers() {
var container = document.getElementById('users-container');
container.innerHTML = '';

if (users.length === 0) {
container.innerHTML = '<p>لا يوجد مستخدمون بعد.</p>';
return;
}

users.forEach((user, index) => {
var userItem = document.createElement('div');
userItem.className = 'user-item';

userItem.innerHTML = `
<div class="user-info">
<div class="user-name">${user.name}</div>
<div class="user-code">رمز الدخول: ${user.code}</div>
</div>
<span class="user-status status-${user.active ? 'active' : 'inactive'}">
${user.active ? 'نشط' : 'غير نشط'}
</span>
<div class="user-controls">
<button class="user-btn toggle" onclick="toggleUserStatus(${index})">
${user.active ? 'تعطيل' : 'تفعيل'}
</button>
<button class="user-btn delete" onclick="deleteUser(${index})">حذف</button>
</div>
`;
container.appendChild(userItem);
});
}

// Toggle user status
function toggleUserStatus(index) {
users[index].active = !users[index].active;
saveUsersToFirebase();
displayUsers();
}

// Delete a user
function deleteUser(index) {
if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
users.splice(index, 1);
saveUsersToFirebase();
displayUsers();
}
}

// Add a new question - FIXED VERSION
function addQuestion() {
var questionText = document.getElementById('question-text').value;
var answer1 = document.getElementById('answer-1').value;
var answer2 = document.getElementById('answer-2').value;
var answer3 = document.getElementById('answer-3').value;
var answer4 = document.getElementById('answer-4').value;
var modelId = document.getElementById('question-model').value;

if (!questionText || !answer1 || !answer2 || !answer3 || !answer4) {
document.getElementById('question-status').textContent = 'الرجاء ملء جميع الحقول';
document.getElementById('question-status').className = 'url-status error';
return;
}

if (!modelId) {
document.getElementById('question-status').textContent = 'الرجاء اختيار نموذج';
document.getElementById('question-status').className = 'url-status error';
return;
}

// VALIDATE THAT THE SELECTED MODEL STILL EXISTS
const selectedModel = quizModels.find(m => m.id === modelId);
if (!selectedModel) {
document.getElementById('question-status').textContent = 'خطأ: النموذج المحدد لم يعد موجوداً. الرجاء اختيار نموذج صالح.';
document.getElementById('question-status').className = 'url-status error';

// Refresh the model dropdown
displayQuizModels();
return;
}

var correctAnswerIndex = parseInt(document.querySelector('input[name="correct-answer"]:checked').value);
var answers = [answer1, answer2, answer3, answer4];
var correctAnswer = answers[correctAnswerIndex];

var newQuestion = {
question: questionText,
answers: answers,
correct: correctAnswer,
hidden: false,
modelId: modelId,
modelName: selectedModel.name,
timestamp: new Date().toISOString(),
questionId: 'q-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
};

questions.push(newQuestion);
saveQuestionsToFirebase();

document.getElementById('question-status').textContent = `تم إضافة السؤال بنجاح إلى نموذج "${selectedModel.name}"! إجمالي الأسئلة في هذا النموذج: ${questions.filter(q => q.modelId === modelId).length}`;
document.getElementById('question-status').className = 'url-status success';

// Clear form but KEEP the model selection
document.getElementById('question-text').value = '';
document.getElementById('answer-1').value = '';
document.getElementById('answer-2').value = '';
document.getElementById('answer-3').value = '';
document.getElementById('answer-4').value = '';
document.querySelector('input[name="correct-answer"][value="0"]').checked = true;

// Refresh questions display to show the new question
displayQuestions();
updateDashboard();

setTimeout(() => {
document.getElementById('question-status').textContent = 'أضف سؤالاً جديداً إلى الاختبار';
document.getElementById('question-status').className = 'url-status';
}, 4000);
}

// Display all questions with show/hide toggle
function displayQuestions() {
var container = document.getElementById('questions-container');
container.innerHTML = '';

// Add "Show All" button when filtered
if (currentModelFilter) {
const showAllButton = document.createElement('button');
showAllButton.className = 'admin-btn';
showAllButton.textContent = 'عرض جميع الأسئلة';
showAllButton.onclick = showAllQuestions;
showAllButton.style.marginBottom = '1rem';
container.appendChild(showAllButton);
}

let filteredQuestions = questions;

// Apply model filter if active
if (currentModelFilter) {
filteredQuestions = questions.filter(q => q.modelId === currentModelFilter);
}

if (filteredQuestions.length === 0) {
container.innerHTML += '<p>لم يتم العثور على أسئلة.</p>';
return;
}

filteredQuestions.forEach((q, index) => {
// Find the actual index in the main questions array
const actualIndex = questions.findIndex(question => question === q);

var questionItem = document.createElement('div');
questionItem.className = 'question-item';
if (q.hidden) {
questionItem.classList.add('hidden');
}

var correctIndex = q.answers.indexOf(q.correct);
var status = q.hidden ? 'مخفي' : 'مرئي';

// Get model name with fallback
var model = quizModels.find(m => m.id === q.modelId);
var modelName = 'لا يوجد نموذج';

if (model) {
modelName = model.name;
} else if (q.modelName) {
// If model ID not found but model name exists, try to find by name
modelName = q.modelName + ' (مفقود)';

// Try to recover the model ID
const foundModel = quizModels.find(m => m.name === q.modelName);
if (foundModel) {
q.modelId = foundModel.id;
modelName = q.modelName;
// Auto-save the fix
setTimeout(saveQuestionsToFirebase, 1000);
}
}

// Calculate the question number within the current model
const modelQuestions = questions.filter(question => question.modelId === q.modelId);
const modelQuestionIndex = modelQuestions.indexOf(q) + 1;

questionItem.innerHTML = `
<strong>س${modelQuestionIndex}:</strong> ${q.question}
<span class="model-badge">${modelName}</span>
<span class="status-badge status-${status}">${status.toUpperCase()}</span>
<div class="response-time">الإجابة الصحيحة: ${q.correct} (الخيار ${correctIndex + 1})</div>
<div class="admin-controls">
<button class="admin-btn edit" onclick="editExistingQuestion(${actualIndex})">تعديل</button>
<button class="admin-btn toggle" onclick="toggleQuestionVisibility(${actualIndex})">
${q.hidden ? 'إظهار' : 'إخفاء'}
</button>
<button class="admin-btn delete" onclick="deleteQuestion(${actualIndex})">حذف</button>
<button class="admin-btn" onclick="viewQuestion(${actualIndex})" style="background: #2196f3;">عرض</button>
</div>
`;
container.appendChild(questionItem);
});
}

// View a single question
function viewQuestion(index) {
const q = questions[index];
const model = quizModels.find(m => m.id === q.modelId);
const modelName = model ? model.name : 'لا يوجد نموذج';
const correctIndex = q.answers.indexOf(q.correct);

let modalContent = `
<h3>تفاصيل السؤال</h3>
<p><strong>النموذج:</strong> ${modelName}</p>
<p><strong>السؤال:</strong> ${q.question}</p>
<div class="question-modal-answers">
<h4>خيارات الإجابة:</h4>
${q.answers.map((answer, i) => `
<div class="answer-item ${i === correctIndex ? 'correct' : ''}">
${i === correctIndex ? '✅ ' : '❌ '} ${answer}
</div>
`).join('')}
</div>
`;

document.getElementById('question-modal-body').innerHTML = modalContent;
document.getElementById('questionViewModal').style.display = 'block';
}

// Edit a question
function editExistingQuestion(index) {
var q = questions[index];

document.getElementById('question-text').value = q.question;
document.getElementById('answer-1').value = q.answers[0];
document.getElementById('answer-2').value = q.answers[1];
document.getElementById('answer-3').value = q.answers[2];
document.getElementById('answer-4').value = q.answers[3];
document.getElementById('question-model').value = q.modelId || '';

var correctIndex = q.answers.indexOf(q.correct);
document.querySelectorAll('input[name="correct-answer"]').forEach((radio, i) => {
radio.checked = (i === correctIndex);
});

questions.splice(index, 1);
saveQuestionsToFirebase();

document.getElementById('question-status').textContent = 'جاري تعديل السؤال. قم بتحديث الحقول أعلاه وانقر "إضافة سؤال" لحفظ التغييرات.';
document.getElementById('question-status').className = 'url-status success';

document.getElementById('question-text').scrollIntoView({ behavior: 'smooth' });
}

// Toggle question visibility
function toggleQuestionVisibility(index) {
questions[index].hidden = !questions[index].hidden;
saveQuestionsToFirebase();
displayQuestions();
}

// Delete a question
function deleteQuestion(index) {
if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
questions.splice(index, 1);
saveQuestionsToFirebase();
displayQuestions();
updateDashboard();
}
}

// Update quiz time info display
function updateQuizTimeInfo() {
var start = new Date(quizStartTime);
var end = new Date(quizEndTime);

var options = {
weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
hour: '2-digit', minute: '2-digit'
};

var timeRange = start.toLocaleDateString('ar-EG', options) + ' إلى ' +
end.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});

document.getElementById('quiz-time-range').textContent = timeRange;

var now = new Date().getTime();
var quizTimer = document.getElementById('quiz-timer');
var quizStatus = document.getElementById('quiz-status-text');

if (now < quizStartTime) {
var timeUntilStart = Math.floor((quizStartTime - now) / 1000);
var hours = Math.floor(timeUntilStart / 3600);
var minutes = Math.floor((timeUntilStart % 3600) / 60);
var seconds = timeUntilStart % 60;

quizTimer.textContent = `⏱️ يبدأ بعد: ${hours}س ${minutes}د ${seconds}ث`;
quizStatus.textContent = 'لم يبدأ';
quizStatus.style.color = '#ff9800';
quizActive = false;
stopRankingSystem(); // Stop ranking before quiz starts
} else if (now >= quizStartTime && now <= quizEndTime) {
var timeLeft = Math.floor((quizEndTime - now) / 1000);
var minutes = Math.floor(timeLeft / 60);
var seconds = timeLeft % 60;

quizTimer.textContent = `⏱️ الوقت المتبقي: ${minutes}د ${seconds}ث`;
quizStatus.textContent = 'نشط';
quizStatus.style.color = '#4caf50';
quizActive = true;
// Ranking system will start when players join
} else {
quizTimer.textContent = '⏱️ انتهى الاختبار';
quizStatus.textContent = 'انتهى';
quizStatus.style.color = '#f44336';
quizActive = false;
stopRankingSystem(); // Stop ranking after quiz ends
}
}

// Save quiz progress with fallback for incognito mode
function saveQuizProgress() {
var progress = {
currentIndex: currentIndex,
playerResults: playerResults,
timestamp: Date.now()
};

// Try sessionStorage first, fallback to localStorage for incognito
try {
sessionStorage.setItem('quizProgress', JSON.stringify(progress));
} catch (e) {
localStorage.setItem('quizProgress', JSON.stringify(progress));
}
}

// Resume quiz from saved progress with fallback for incognito mode
function resumeQuiz() {
playerCode = getStoredValue('playerCode');
var savedProgress = getStoredValue('quizProgress');

if (savedProgress) {
var progress = JSON.parse(savedProgress);
currentIndex = progress.currentIndex || 0;
playerResults = progress.playerResults || {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};
}

document.getElementById("player-code").style.display = "none";
document.getElementById("joinBtn").style.display = "none";
document.getElementById('player-question').innerHTML = "";
showPlayerQuestion();
}

// Get stored value with fallback for incognito mode
function getStoredValue(key) {
// Try sessionStorage first
let value = sessionStorage.getItem(key);
if (value !== null) return value;

// Fallback to localStorage for incognito mode
value = localStorage.getItem(key);
return value;
}

// Set stored value with fallback for incognito mode
function setStoredValue(key, value) {
// Try sessionStorage first
try {
sessionStorage.setItem(key, value);
} catch (e) {
// Fallback to localStorage for incognito mode
localStorage.setItem(key, value);
}
}

// Remove stored value with fallback for incognito mode
function removeStoredValue(key) {
// Try sessionStorage first
try {
sessionStorage.removeItem(key);
} catch (e) {
// Fallback to localStorage for incognito mode
localStorage.removeItem(key);
}
}

// Reset quiz session with fallback for incognito mode
function resetQuizSession() {
removeStoredValue('quizCompleted');
removeStoredValue('quizStarted');
removeStoredValue('quizProgress');
removeStoredValue('playerCode');
location.reload();
}

// Countdown timer function
function startCountdown() {
timeLeft = 25;
document.getElementById('countdown').textContent = `الوقت المتبقي: ${timeLeft}ثانية`;

clearInterval(countdownInterval);
countdownInterval = setInterval(() => {
timeLeft--;
document.getElementById('countdown').textContent = `الوقت المتبقي: ${timeLeft}ثانية`;

if (timeLeft <= 0) {
clearInterval(countdownInterval);
var visibleQuestions = getVisibleQuestions();
var q = visibleQuestions[currentIndex];
var responseTime = (Date.now() - questionStartTime) / 1000;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'مشارك غير معروف';

saveToFirebase(playerCode, userName, q.question, "لا إجابة", q.correct, responseTime, "لم يتم الإجابة", q.modelId);

playerResults.incorrect++;
playerResults.total++;
playerResults.responseTimes.push(responseTime);
playerResults.accuracy = (playerResults.correct / playerResults.total) * 100;

saveQuizProgress();
moveToNextQuestion();
}
}, 1000);
}

// 2-second countdown before next question
function startNextQuestionCountdown() {
var countdownTime = 5;
document.getElementById('countdown').textContent = `السؤال التالي في: ${countdownTime}ثانية`;
document.getElementById('countdown').style.color = "#1a3a5f";
document.getElementById('countdown').style.fontWeight = "bold";

var countdownInterval = setInterval(function() {
countdownTime--;
document.getElementById('countdown').textContent = `السؤال التالي في: ${countdownTime}ثانية`;

if (countdownTime <= 0) {
clearInterval(countdownInterval);
document.getElementById('countdown').textContent = "";
moveToNextQuestion();
}
}, 1000);
}

// Get visible questions based on active model - FIXED VERSION
function getVisibleQuestions() {
let visibleQuestions = questions.filter(q => !q.hidden);

// If an active model is selected, filter questions by that model
if (activeQuizModel) {
console.log("تصفية الأسئلة للنموذج النشط:", activeQuizModel);
visibleQuestions = visibleQuestions.filter(q => {
const matches = q.modelId === activeQuizModel;
if (!matches) {
console.log("تم تصفية السؤال - معرف النموذج:", q.modelId, "المتوقع:", activeQuizModel);
}
return matches;
});
console.log("الأسئلة المرئية بعد التصفية:", visibleQuestions.length);
} else {
console.log("لا يوجد نموذج نشط - عرض جميع الأسئلة المرئية:", visibleQuestions.length);
}

return visibleQuestions;
}

// Move to next question automatically
function moveToNextQuestion() {
currentIndex++;
var visibleQuestions = getVisibleQuestions();

if (currentIndex < visibleQuestions.length) {
saveQuizProgress();
showPlayerQuestion();
} else {
showPlayerResults();
}
}

// Show player results at the end of quiz with final rank
function showPlayerResults() {
// Stop ranking updates
stopRankingSystem();

// Mark quiz as completed immediately when user finishes last question
setStoredValue('quizCompleted', 'true');
removeStoredValue('quizProgress');
removeStoredValue('quizStarted');

// Track player leaving
trackActivePlayer(playerCode, 'leave');

var avgResponseTime = playerResults.responseTimes.length > 0
? (playerResults.responseTimes.reduce((a, b) => a + b, 0) / playerResults.responseTimes.length).toFixed(2)
: 0;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'مشارك غير معروف';

// Calculate pass/fail (50% threshold)
const accuracy = playerResults.accuracy;
const passFail = accuracy >= 50 ? 'ناجح' : 'راسب';
const passFailClass = passFail === 'ناجح' ? 'result-correct' : 'result-incorrect';

// Get final rank
const currentPlayerRank = playerRankings[playerCode];
const finalRank = currentPlayerRank ? currentPlayerRank.rank : 'غير متاح';
const totalPlayers = Object.keys(playerRankings).length;

// Remove live rank display
const liveRankDisplay = document.getElementById('current-rank-display');
if (liveRankDisplay) {
liveRankDisplay.remove();
}

document.getElementById('player-question').innerHTML = `
<div class="player-results">
<h2>🎉 اكتمل الاختبار! 🎉</h2>
<p>شكراً للمشاركة، ${userName}!</p>

<!-- Final Rank Display -->
<div class="final-rank-section">
<div style="font-size: 1.2rem; margin-bottom: 10px; opacity: 0.9;">
ترتيبك النهائي
</div>
<div style="font-size: 3.5rem; font-weight: bold; margin: 10px 0;">
#${finalRank}
</div>
<div style="font-size: 1rem; opacity: 0.8;">
من أصل ${totalPlayers} مشارك
</div>
${finalRank <= 3 ? `
<div style="margin-top: 15px; font-size: 1.5rem;">
${finalRank === 1 ? '🥇 الميدالية الذهبية!' : ''}
${finalRank === 2 ? '🥈 الميدالية الفضية!' : ''}
${finalRank === 3 ? '🥉 الميدالية البرونزية!' : ''}
</div>
` : ''}
</div>

<div class="result-stats">
<div class="result-stat">
<span class="result-number result-correct">${playerResults.correct}</span>
<span class="result-label">الإجابات الصحيحة</span>
</div>
<div class="result-stat">
<span class="result-number result-incorrect">${playerResults.incorrect}</span>
<span class="result-label">الإجابات الخاطئة</span>
</div>
<div class="result-stat">
<span class="result-number result-accuracy">${playerResults.accuracy.toFixed(1)}%</span>
<span class="result-label">الدقة</span>
</div>
<div class="result-stat">
<span class="result-number result-time">${avgResponseTime}ثانية</span>
<span class="result-label">متوسط وقت الاستجابة</span>
</div>
<div class="result-stat">
<span class="result-number ${passFailClass}">${passFail}</span>
<span class="result-label">النتيجة النهائية</span>
</div>
</div>

<button class="download-btn" onclick="downloadPlayerResults()">
📥 تنزيل نتائجي
</button>

<div class="session-warning">
<h3>⚠️ اكتمل الاختبار</h3>
<p>لقد أكملت هذا الاختبار بنجاح.</p>
<p><strong>ملاحظة:</strong> لا يمكنك إعادة اختبار هذا الاختبار.</p>
</div>
</div>
`;

document.getElementById('player-answers').innerHTML = "";
document.getElementById('countdown').textContent = "";
}

// Download player results as CSV
function downloadPlayerResults() {
var avgResponseTime = playerResults.responseTimes.length > 0
? (playerResults.responseTimes.reduce((a, b) => a + b, 0) / playerResults.responseTimes.length).toFixed(2)
: 0;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'مشارك غير معروف';

// Calculate pass/fail
const accuracy = playerResults.accuracy;
const passFail = accuracy >= 50 ? 'ناجح' : 'راسب';

var csvData = [
['اسم المشارك', 'رمز المشارك', 'الإجابات الصحيحة', 'الإجابات الخاطئة', 'إجمالي الأسئلة', 'الدقة', 'متوسط وقت الاستجابة', 'النتيجة النهائية'],
[userName, playerCode, playerResults.correct, playerResults.incorrect, playerResults.total, playerResults.accuracy.toFixed(1) + '%', avgResponseTime + 'ثانية', passFail]
];

var csv = csvData.map(row => row.join(',')).join('\n');
var blob = new Blob([csv], { type: 'text/csv' });
var url = window.URL.createObjectURL(blob);
var a = document.createElement('a');
a.href = url;
a.download = `نتائج-${userName}-${new Date().toISOString().split('T')[0]}.csv`;
a.click();
window.URL.revokeObjectURL(url);
}

// Real-time ranking system
// Start tracking player rankings
function startRankingSystem() {
// Clear any existing interval
if (rankingUpdateInterval) {
clearInterval(rankingUpdateInterval);
}

// Update rankings every 2 seconds during quiz
rankingUpdateInterval = setInterval(updatePlayerRankings, 2000);
}

// Stop ranking system
function stopRankingSystem() {
if (rankingUpdateInterval) {
clearInterval(rankingUpdateInterval);
rankingUpdateInterval = null;
}
}

// Update player rankings based on speed and accuracy
function updatePlayerRankings() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) return;

const allResults = Object.values(results);
const currentTime = Date.now();

// Filter results from the last 5 minutes for active players
const recentResults = allResults.filter(result =>
currentTime - new Date(result.timestamp).getTime() < 5 * 60 * 1000
);

// Calculate scores for each player
const playerScores = {};

recentResults.forEach(result => {
if (!playerScores[result.playerCode]) {
playerScores[result.playerCode] = {
correct: 0,
totalTime: 0,
questions: 0,
lastActivity: new Date(result.timestamp).getTime(),
playerName: result.playerName
};
}

const player = playerScores[result.playerCode];
player.questions++;

if (result.selectedAnswer === result.correctAnswer) {
player.correct++;
// Faster correct answers get higher scores
const speedBonus = Math.max(0, 15 - result.responseTime);
player.totalTime += result.responseTime;
}

player.lastActivity = Math.max(player.lastActivity, new Date(result.timestamp).getTime());
});

// Calculate ranking score (accuracy + speed)
const rankedPlayers = Object.entries(playerScores).map(([playerCode, data]) => {
const accuracy = data.questions > 0 ? (data.correct / data.questions) * 100 : 0;
const avgTime = data.correct > 0 ? (data.totalTime / data.correct) : 0;
const speedScore = Math.max(0, 100 - (avgTime * 10)); // Lower time = higher score
const activityRecency = (currentTime - data.lastActivity) < 60000 ? 50 : 0; // Bonus for recent activity

return {
playerCode,
playerName: data.playerName,
score: (accuracy * 0.6) + (speedScore * 0.3) + (activityRecency * 0.1),
correct: data.correct,
questions: data.questions,
accuracy: accuracy,
avgTime: avgTime
};
});

// Sort by score (descending)
rankedPlayers.sort((a, b) => b.score - a.score);

// Update global rankings
playerRankings = {};
rankedPlayers.forEach((player, index) => {
playerRankings[player.playerCode] = {
rank: index + 1,
...player
};
});

// Update ranking display for current player
updateCurrentPlayerRankDisplay();
})
.catch((error) => {
console.error("Error updating rankings:", error);
});
}

// Update current player's rank display
function updateCurrentPlayerRankDisplay() {
if (!playerCode || !quizActive) return;

const currentPlayerRank = playerRankings[playerCode];
const rankDisplay = document.getElementById('current-rank-display');

if (!rankDisplay) {
// Create rank display if it doesn't exist
const newRankDisplay = document.createElement('div');
newRankDisplay.id = 'current-rank-display';
newRankDisplay.className = 'rank-display';
document.body.appendChild(newRankDisplay);
}

const displayElement = document.getElementById('current-rank-display');

if (currentPlayerRank) {
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'أنت';

displayElement.innerHTML = `
<div style="font-weight: bold; margin-bottom: 8px; color: #1a3a5f;">🏆 التصنيف المباشر</div>
<div style="font-size: 1.5rem; font-weight: bold; color: #4caf50; text-align: center;">
#${currentPlayerRank.rank}
</div>
<div style="font-size: 0.9rem; text-align: center; margin-bottom: 8px;">
${userName}
</div>
<div style="font-size: 0.8rem; color: #666;">
📊 ${currentPlayerRank.correct}/${currentPlayerRank.questions} صحيحة
</div>
<div style="font-size: 0.8rem; color: #666;">
⚡ متوسط: ${currentPlayerRank.avgTime ? currentPlayerRank.avgTime.toFixed(1) + 'ثانية' : 'غير متاح'}
</div>
<div style="font-size: 0.8rem; color: #2196f3; margin-top: 5px;">
إجمالي المشاركين: ${Object.keys(playerRankings).length}
</div>
`;
} else {
displayElement.innerHTML = `
<div style="font-weight: bold; margin-bottom: 8px; color: #1a3a5f;">🏆 التصنيف المباشر</div>
<div style="text-align: center; color: #666; font-size: 0.9rem;">
أجب على الأسئلة لترى ترتيبك!
</div>
`;
}
}

// Initialize the application
document.getElementById("joinBtn").onclick = function() {
if (!quizActive) {
alert("الاختبار غير نشط حالياً. يرجى التحقق من جدول الاختبار.");
return;
}

// Improved session state management to prevent retaking quiz
if (getStoredValue('quizCompleted') === 'true') {
alert("لقد أكملت هذا الاختبار بالفعل. لا يمكنك إعادة اختباره.");
return;
}

// Reset any incomplete quiz state
if (getStoredValue('quizStarted') === 'true' && !getStoredValue('quizCompleted')) {
if (!confirm("لقد بدأت هذا الاختبار بالفعل. هل تريد متابعة من حيث توقفت؟")) {
// Clear the incomplete state if user doesn't want to continue
removeStoredValue('quizStarted');
removeStoredValue('quizProgress');
}
}

playerCode = document.getElementById("player-code").value.trim();
if (playerCode !== "") {
// Check if user code is valid and active
const user = users.find(u => u.code === playerCode);
if (!user) {
alert("رمز دخول غير صالح. يرجى التحقق من الرمز والمحاولة مرة أخرى.");
return;
}

if (!user.active) {
alert("حسابك غير نشط. يرجى الاتصال بمشرف الاختبار.");
return;
}

// Mark quiz as started
setStoredValue('quizStarted', 'true');
setStoredValue('playerCode', playerCode);

// Track active player
trackActivePlayer(playerCode, 'join');

// Reset results when starting new quiz
playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};

// Restore progress if exists
var savedProgress = getStoredValue('quizProgress');
if (savedProgress) {
var progress = JSON.parse(savedProgress);
currentIndex = progress.currentIndex || 0;
playerResults = progress.playerResults || playerResults;
}

// START RANKING SYSTEM WHEN PLAYER JOINS
startRankingSystem();

currentIndex = 0;
document.getElementById("player-code").style.display = "none";
document.getElementById("joinBtn").style.display = "none";
showPlayerQuestion();
} else {
alert("الرجاء إدخال رمز الدخول للانضمام إلى اللعبة.");
}
};

// Update quiz timer every second
setInterval(updateQuizTimeInfo, 1000);
updateQuizTimeInfo();

// Improved session state management to prevent lag issues
window.addEventListener('beforeunload', function (e) {
if (getStoredValue('quizStarted') === 'true' && getStoredValue('quizCompleted') !== 'true') {
// Save progress before leaving
saveQuizProgress();
// Track player leaving
trackActivePlayer(playerCode, 'leave');
e.preventDefault();
e.returnValue = 'لديك اختبار قيد التقدم. هل أنت متأكد من أنك تريد المغادرة؟';
return 'لديك اختبار قيد التقدم. هل أنت متأكد من أنك تريد المغادرة؟';
}
});

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
document.getElementById('player').classList.add('active');

// Wait for Firebase to load before showing quiz status
function checkQuizStatusAfterLoad() {
// Check if user already completed quiz (after Firebase loads)
if (getStoredValue('quizCompleted') === 'true') {
const playerCode = getStoredValue('playerCode') || 'غير معروف';
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'مشارك';

document.getElementById('player-question').innerHTML = `
<div class="player-results">
<h2>🏁 اكتمل الاختبار بالفعل</h2>
<p>مرحباً <strong>${userName}</strong>، لقد أكملت هذا الاختبار بنجاح!</p>
<div class="session-warning">
<h3>⚠️ تم الوصول إلى حد المحاولة</h3>
<p>يمكن لكل مشارك إكمال الاختبار مرة واحدة فقط.</p>
</div>
</div>
`;
document.getElementById("player-code").style.display = "none";
// Disable the join button instead of hiding it
document.getElementById("joinBtn").disabled = true;
document.getElementById("joinBtn").style.background = "#ccc";
document.getElementById("joinBtn").textContent = "اكتمل الاختبار";
document.getElementById("joinBtn").style.cursor = "not-allowed";
}
}

function initializeApp() {
try {
loadDataFromFirebase();
// Check status again after Firebase fully loads
setTimeout(checkQuizStatusAfterLoad, 2000);
} catch (error) {
setTimeout(initializeApp, 2000);
}
}
initializeApp();
console.log("تم تهيئة منصة الاختبارات القضائية المحسنة مع نظام التصنيف");
});
</script>
</body>
</html>
