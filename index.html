<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kahoot FS - Enhanced</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- Excel Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
color: #333;
line-height: 1.6;
min-height: 100vh;
padding: 20px;
display: flex;
justify-content: center;
align-items: center;
}

.container {
width: 95%;
max-width: 1200px;
background: white;
border-radius: 12px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
overflow: hidden;
}

header {
background: linear-gradient(135deg, #6e8efb, #a777e3);
color: white;
padding: 1.5rem;
text-align: center;
position: relative;
}

.quiz-timer {
position: absolute;
top: 10px;
right: 20px;
background: rgba(255, 255, 255, 0.2);
padding: 5px 10px;
border-radius: 20px;
font-weight: bold;
font-size: 0.9rem;
}

h1 {
font-size: 2rem;
margin-bottom: 0.5rem;
}

.subtitle {
font-size: 1rem;
opacity: 0.9;
}

.tabs {
display: flex;
background: #f0f0f0;
border-bottom: 2px solid #ddd;
position: sticky;
top: 0;
z-index: 100;
flex-wrap: nowrap;
overflow-x: auto;
}

.tab {
padding: 1rem;
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
text-align: center;
flex: 1;
font-size: 0.9rem;
min-width: 120px;
white-space: nowrap;
}

.tab:hover {
background: #e0e0e0;
}

.tab.active {
background: white;
border-bottom: 3px solid #6e8efb;
}

.content {
padding: 1.5rem;
min-height: 500px;
}

.tab-content {
display: none;
}

.tab-content.active {
display: block;
animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.card {
background: white;
border-radius: 10px;
padding: 1.5rem;
margin: 1.5rem 0;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
border-left: 4px solid #6e8efb;
}

h2 {
font-size: 1.6rem;
color: #6e8efb;
margin-bottom: 1rem;
}

h3 {
font-size: 1.3rem;
color: #a777e3;
margin: 1.2rem 0 0.8rem;
}

input, button, select, textarea {
padding: 0.8rem 1rem;
margin: 0.5rem 0;
border-radius: 5px;
border: 1px solid #ddd;
font-size: 0.9rem;
}

input, select, textarea {
width: 100%;
max-width: 300px;
}

textarea {
min-height: 100px;
resize: vertical;
}

button {
background: #6e8efb;
color: white;
border: none;
cursor: pointer;
transition: all 0.3s ease;
font-weight: 600;
}

button:hover {
background: #5a7df9;
transform: translateY(-2px);
}

button:disabled {
background: #ccc;
cursor: not-allowed;
transform: none;
}

/* Enhanced answer button styles for grid layout with better spacing */
.answers-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px; /* Increased gap for better separation */
margin: 1.5rem 0;
}

.answer-btn {
display: flex;
align-items: center;
justify-content: center;
text-align: center;
margin: 0;
padding: 1.5rem;
background: #f8f9fa;
color: #333;
border: 2px solid #ddd;
border-radius: 10px;
transition: all 0.3s ease;
font-size: 1.1rem;
font-weight: 500;
min-height: 100px;
word-wrap: break-word;
hyphens: auto;
cursor: pointer;
position: relative;
z-index: 1; /* Ensure buttons stay in their own space */
}

.answer-btn:hover {
background: #e9ecef;
transform: translateY(-3px);
border-color: #6e8efb;
box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.answer-btn.correct {
background-color: #4caf50 !important;
color: white !important;
border-color: #4caf50 !important;
opacity: 1 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
z-index: 2; /* Ensure correct answer appears above others */
}

.answer-btn.incorrect {
background-color: #f44336 !important;
color: white !important;
border-color: #f44336 !important;
opacity: 1 !important;
transform: scale(1.03);
box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
z-index: 2; /* Ensure incorrect answer appears above others */
}

.answer-btn:disabled {
opacity: 1 !important;
pointer-events: none;
}

/* Force color visibility with higher specificity */
#player-answers .answer-btn.correct,
#player-answers .answer-btn.incorrect {
background-color: inherit !important;
color: inherit !important;
border-color: inherit !important;
}

/* Responsive design for mobile */
@media (max-width: 768px) {
.answers-grid {
grid-template-columns: 1fr;
gap: 15px; /* Slightly smaller gap on mobile */
}

.answer-btn {
padding: 1.2rem;
min-height: 80px;
font-size: 1rem;
}
}

.instructions {
background: #fff8e1;
border-left: 4px solid #ffc107;
padding: 1.2rem;
margin: 1.5rem 0;
border-radius: 4px;
}

.instructions h3 {
color: #ff9800;
margin-bottom: 0.8rem;
}

.instructions ol {
margin-left: 1.5rem;
margin-bottom: 1rem;
}

.instructions li {
margin-bottom: 0.5rem;
}

.countdown {
font-size: 1.4rem;
font-weight: bold;
text-align: center;
margin: 1rem 0;
color: #6e8efb;
}

.url-status {
margin-top: 10px;
padding: 8px;
border-radius: 4px;
text-align: center;
font-size: 0.9rem;
}

.url-status.success {
background-color: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.url-status.error {
background-color: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

.setup-complete {
text-align: center;
padding: 1.5rem;
background: #e8f5e9;
border-radius: 8px;
margin: 1.5rem 0;
}

.time-info {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.time-config {
background: #f3e5f5;
border-left: 4px solid #9c27b0;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.time-config h3 {
color: #7b1fa2;
}

.form-group {
margin: 1rem 0;
}

label {
display: block;
margin-bottom: 0.5rem;
font-weight: 600;
}

.admin-section {
background: #fff3e0;
border-left: 4px solid #ff9800;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.admin-section h3 {
color: #ef6c00;
}

.question-list {
margin: 1rem 0;
max-height: 300px;
overflow-y: auto;
border: 1px solid #ddd;
border-radius: 5px;
padding: 1rem;
background: #f9f9f9;
}

.question-item {
padding: 0.5rem;
border-bottom: 1px solid #eee;
}

.question-item:last-child {
border-bottom: none;
}

.admin-controls {
display: flex;
gap: 10px;
margin-top: 0.5rem;
flex-wrap: wrap;
}

.admin-btn {
padding: 0.5rem 1rem;
font-size: 0.8rem;
}

.admin-btn.edit {
background: #ff9800;
}

.admin-btn.toggle {
background: #9c27b0;
}

.admin-btn.delete {
background: #f44336;
}

.answer-option {
display: flex;
align-items: center;
margin-bottom: 0.5rem;
gap: 10px;
}

.answer-option input[type="text"] {
flex: 1;
max-width: none;
}

.response-time {
font-style: italic;
color: #666;
font-size: 0.9rem;
margin-top: 5px;
}

.time-input-group {
display: flex;
align-items: center;
gap: 10px;
flex-wrap: wrap;
}

.time-input-group input {
max-width: 100px;
}

.time-input-group select {
max-width: 100px;
}

.firebase-config-help {
background: #ffebee;
border-left: 4px solid #f44336;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.firebase-config-help h3 {
color: #c62828;
}

/* Results Styles */
.stats-container {
background: #f5f5f5;
padding: 1rem;
border-radius: 8px;
margin-bottom: 1rem;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin-top: 1rem;
}

.stat-card {
background: white;
padding: 1rem;
border-radius: 8px;
text-align: center;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-number {
display: block;
font-size: 1.8rem;
font-weight: bold;
color: #6e8efb;
}

.stat-label {
font-size: 0.8rem;
color: #666;
}

.results-table {
margin-top: 1rem;
border: 1px solid #ddd;
border-radius: 5px;
overflow: auto;
max-height: 400px;
}

.result-header, .result-row {
display: grid;
grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 2fr;
gap: 1px;
padding: 0.5rem;
min-width: 800px;
}

.result-header {
background: #6e8efb;
color: white;
font-weight: bold;
position: sticky;
top: 0;
}

.result-row {
background: #f9f9f9;
border-bottom: 1px solid #eee;
}

.result-row.correct {
background: #e8f5e9;
}

.result-row.incorrect {
background: #ffebee;
}

.result-row:last-child {
border-bottom: none;
}

.export-buttons {
display: flex;
gap: 10px;
margin: 1rem 0;
flex-wrap: wrap;
}

.export-btn {
background: #4caf50;
padding: 0.8rem 1.2rem;
}

.export-btn.csv {
background: #2196f3;
}

.export-btn.delete {
background: #f44336;
}

/* Host features container */
#admin-features {
max-height: 70vh;
overflow-y: auto;
}

/* Security notice */
.security-notice {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
font-size: 0.9rem;
}

.security-notice h4 {
color: #1565c0;
margin-bottom: 0.5rem;
}

/* Show/Hide question styles */
.question-toggle {
background: #ff9800;
padding: 0.3rem 0.8rem;
font-size: 0.8rem;
margin-left: 10px;
}

.question-toggle.hidden {
background: #f44336;
}

.question-item.hidden {
opacity: 0.6;
background: #f5f5f5;
border-left: 4px solid #ff9800;
}

.status-badge {
display: inline-block;
padding: 0.2rem 0.5rem;
border-radius: 12px;
font-size: 0.7rem;
font-weight: bold;
margin-left: 10px;
}

.status-visible {
background: #4caf50;
color: white;
}

.status-hidden {
background: #f44336;
color: white;
}

/* Player results styles */
.player-results {
text-align: center;
padding: 2rem;
background: #f8f9fa;
border-radius: 10px;
margin: 1rem 0;
}

.result-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 1rem;
margin: 2rem 0;
}

.result-stat {
background: white;
padding: 1.5rem;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.result-number {
font-size: 2.5rem;
font-weight: bold;
display: block;
}

.result-correct { color: #4caf50; }
.result-incorrect { color: #f44336; }
.result-accuracy { color: #2196f3; }
.result-time { color: #ff9800; }

.result-label {
font-size: 0.9rem;
color: #666;
margin-top: 0.5rem;
}

.download-btn {
background: #4caf50;
padding: 1rem 2rem;
font-size: 1.1rem;
margin: 1rem;
}

.download-btn:hover {
background: #45a049;
transform: translateY(-2px);
}

.session-warning {
background: #fff3cd;
border-left: 4px solid #ffc107;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
text-align: center;
}

.session-warning h3 {
color: #856404;
margin-bottom: 0.5rem;
}

/* New styles for user management */
.user-management {
background: #e8f5e9;
border-left: 4px solid #4caf50;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.user-management h3 {
color: #2e7d32;
}

.user-list {
margin: 1rem 0;
max-height: 300px;
overflow-y: auto;
border: 1px solid #ddd;
border-radius: 5px;
padding: 1rem;
background: #f9f9f9;
}

.user-item {
padding: 0.8rem;
border-bottom: 1px solid #eee;
display: flex;
justify-content: space-between;
align-items: center;
}

.user-item:last-child {
border-bottom: none;
}

.user-info {
flex: 1;
}

.user-name {
font-weight: bold;
}

.user-code {
font-size: 0.8rem;
color: #666;
margin-top: 0.2rem;
}

.user-status {
display: inline-block;
padding: 0.2rem 0.5rem;
border-radius: 12px;
font-size: 0.7rem;
font-weight: bold;
margin-left: 10px;
}

.status-active {
background: #4caf50;
color: white;
}

.status-inactive {
background: #f44336;
color: white;
}

.user-controls {
display: flex;
gap: 5px;
}

.user-btn {
padding: 0.3rem 0.8rem;
font-size: 0.7rem;
}

.user-btn.toggle {
background: #9c27b0;
}

.user-btn.delete {
background: #f44336;
}

.user-btn.export {
background: #2196f3;
}

.user-btn.delete-results {
background: #ff9800;
}

/* Individual user results */
.user-results {
margin-top: 1rem;
}

.user-result-item {
background: white;
padding: 1rem;
margin: 0.5rem 0;
border-radius: 5px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.user-result-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
}

.user-result-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
gap: 0.5rem;
margin-top: 0.5rem;
}

.user-stat {
text-align: center;
padding: 0.5rem;
background: #f5f5f5;
border-radius: 4px;
}

.user-stat-number {
font-weight: bold;
font-size: 1.2rem;
}

.user-stat-label {
font-size: 0.7rem;
color: #666;
}

/* Password change form */
.password-change {
background: #e3f2fd;
border-left: 4px solid #2196f3;
padding: 1rem;
margin: 1rem 0;
border-radius: 4px;
}

.password-change h3 {
color: #1565c0;
}

/* Responsive Design */
@media (max-width: 768px) {
.container {
width: 100%;
margin: 10px;
padding: 0;
}

header {
padding: 1rem;
}

h1 {
font-size: 1.6rem;
}

.tabs {
flex-direction: row;
overflow-x: auto;
}

.tab {
padding: 0.8rem;
min-width: 100px;
font-size: 0.8rem;
}

.content {
padding: 1rem;
}

.quiz-timer {
position: static;
margin-top: 10px;
display: inline-block;
}

.admin-controls {
flex-direction: column;
}

.answer-option {
flex-direction: column;
align-items: flex-start;
}

.answer-option input[type="text"] {
width: 100%;
margin-right: 0;
margin-bottom: 5px;
}

.time-input-group {
flex-direction: column;
align-items: flex-start;
}

.time-input-group input, .time-input-group select {
max-width: 100%;
}

.result-header, .result-row {
grid-template-columns: 1fr;
font-size: 0.8rem;
min-width: auto;
}

.stats-grid {
grid-template-columns: 1fr;
}

.export-buttons {
flex-direction: column;
}

.result-stats {
grid-template-columns: 1fr;
}

.user-item {
flex-direction: column;
align-items: flex-start;
}

.user-controls {
margin-top: 0.5rem;
width: 100%;
justify-content: flex-end;
}
}

@media (min-width: 1200px) {
.container {
max-width: 1400px;
}

.content {
padding: 2rem;
}
}

@media (max-width: 480px) {
body {
padding: 10px;
}

.container {
border-radius: 8px;
}

.card {
padding: 1rem;
margin: 1rem 0;
}

h2 {
font-size: 1.3rem;
}

h3 {
font-size: 1.1rem;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>Kahoot FS - Enhanced</h1>
<p class="subtitle">Answer questions within the time limit</p>
<div class="quiz-timer" id="quiz-timer">Quiz: Not started</div>
</header>

<div class="tabs">
<div class="tab active" onclick="switchTab('player')">Player</div>
<div class="tab" onclick="switchTab('host')">Host</div>
<div class="tab" onclick="switchTab('firebase-help')">About</div>
</div>

<div class="content">
<!-- Player Tab -->
<div id="player" class="tab-content active">
<h2>Join Quiz</h2>
<div class="time-info" id="quiz-time-info">
<p>This quiz is scheduled for <strong id="quiz-time-range">tomorrow from 12:00 PM to 12:30 PM</strong></p>
<p id="quiz-status">Status: <span id="quiz-status-text">Not started</span></p>
</div>

<div class="card">
<input id="player-code" placeholder="Enter your access code">
<button id="joinBtn">Join Game</button>

<div id="player-question"></div>
<div id="countdown" class="countdown"></div>
<div id="player-answers"></div>
</div>

<div class="instructions">
<h3>Player Instructions</h3>
<ol>
<li>Enter your access code and click "Join Game"</li>
<li>Wait for the host to start the quiz</li>
<li>Select your answer when questions appear</li>
<li>Your answers and response time will be recorded</li>
<li>Each device has separate session - codes won't conflict</li>
<li>View your results and download them at the end</li>
<li><strong>Note:</strong> You can only complete the quiz once per session</li>
</ol>
</div>
</div>

<!-- Host Tab -->
<div id="host" class="tab-content">
<h2>Quiz Host (Admin)</h2>

<div class="admin-section">
<h3>Admin Access</h3>
<div class="security-notice">
<h4>🔒 Security Notice</h4>
<p>Your admin control is <strong>Full control over kahoot</strong>. It's securely verified locally and never transmitted in clear text.</p>
</div>
<div class="form-group">
<label for="admin-code">Enter Admin Code:</label>
<input type="password" id="admin-code" placeholder="Enter admin code">
<button onclick="verifyAdmin()">Access Admin Features</button>
</div>
<div id="admin-status" class="url-status">Enter the admin code to access host features</div>
</div>

<div id="admin-features" style="display: none;">
<!-- Password Change Section -->
<div class="password-change">
<h3>Change Admin Password</h3>
<div class="form-group">
<label for="current-password">Current Password:</label>
<input type="password" id="current-password" placeholder="Enter current password">
</div>
<div class="form-group">
<label for="new-password">New Password:</label>
<input type="password" id="new-password" placeholder="Enter new password">
</div>
<div class="form-group">
<label for="confirm-password">Confirm New Password:</label>
<input type="password" id="confirm-password" placeholder="Confirm new password">
</div>
<button onclick="changeAdminPassword()">Change Password</button>
<div id="password-status" class="url-status">Change your admin password here</div>
</div>

<div class="time-config">
<h3>Quiz Timing Configuration</h3>
<p>Set when your quiz will be active</p>

<div class="form-group">
<label for="host-quiz-date">Quiz Date:</label>
<input type="date" id="host-quiz-date">
</div>

<div class="form-group">
<label for="host-start-time">Start Time:</label>
<div class="time-input-group">
<input type="number" id="host-start-hour" min="1" max="12" value="12" placeholder="Hour">
<input type="number" id="host-start-minute" min="0" max="59" value="0" placeholder="Minute">
<select id="host-start-ampm">
<option value="AM">AM</option>
<option value="PM" selected>PM</option>
</select>
</div>
</div>

<div class="form-group">
<label for="host-quiz-duration">Quiz Duration (minutes):</label>
<select id="host-quiz-duration">
<option value="15">15 minutes</option>
<option value="30" selected>30 minutes</option>
<option value="45">45 minutes</option>
<option value="60">1 hour</option>
<option value="90">1.5 hours</option>
<option value="120">2 hours</option>
</select>
</div>

<button onclick="saveHostQuizTime()">Save Quiz Time</button>
<div id="host-time-status" class="url-status">Configure when your quiz will be active</div>
</div>

<!-- User Management Section -->
<div class="user-management">
<h3>User Management</h3>

<div class="form-group">
<label for="user-name">User Name:</label>
<input type="text" id="user-name" placeholder="Enter user's real name">
</div>

<div class="form-group">
<label for="user-code">Access Code:</label>
<input type="text" id="user-code" placeholder="Enter unique access code">
</div>

<button onclick="addUser()">Add User</button>
<div id="user-status" class="url-status">Add users with unique access codes</div>

<div class="user-list">
<h4>Current Users</h4>
<div id="users-container"></div>
</div>
</div>

<div class="admin-section">
<h3>Question Management</h3>

<div class="form-group">
<label for="question-text">Question:</label>
<textarea id="question-text" placeholder="Enter your question"></textarea>
</div>

<div class="form-group">
<label>Answer Options:</label>
<div class="answer-option">
<input type="text" id="answer-1" placeholder="Enter answer 1">
<input type="radio" name="correct-answer" value="0" checked> Correct Answer
</div>
<div class="answer-option">
<input type="text" id="answer-2" placeholder="Enter answer 2">
<input type="radio" name="correct-answer" value="1"> Correct Answer
</div>
<div class="answer-option">
<input type="text" id="answer-3" placeholder="Enter answer 3">
<input type="radio" name="correct-answer" value="2"> Correct Answer
</div>
<div class="answer-option">
<input type="text" id="answer-4" placeholder="Enter answer 4">
<input type="radio" name="correct-answer" value="3"> Correct Answer
</div>
</div>

<button onclick="addQuestion()">Add Question</button>
<div id="question-status" class="url-status">Add a new question to the quiz</div>
</div>

<div class="question-list">
<h3>Current Questions</h3>
<div id="questions-container"></div>
</div>

<div class="admin-section">
<h3>Quiz Results</h3>
<div class="export-buttons">
<button class="export-btn" onclick="exportToExcel()">📊 Export to Excel</button>
<button class="export-btn csv" onclick="exportToCSV()">📄 Export to CSV</button>
<button class="export-btn delete" onclick="confirmDeleteResults()">🗑️ Delete All Results</button>
<button onclick="loadQuizResults()">🔄 Refresh Results</button>
</div>
<div id="results-container" class="question-list">Click "Refresh Results" to load quiz data</div>

<!-- Individual User Results -->
<div class="user-results">
<h3>Individual User Results</h3>
<div id="user-results-container"></div>
</div>
</div>
</div>

<div class="instructions">
<h3>Host Instructions</h3>
<ol>
<li>Enter the admin code to access host features</li>
<li>Add users with unique access codes</li>
<li>Set the date and time for your quiz</li>
<li>Add questions using the question management form</li>
<li>Use Show/Hide buttons to control which questions are active</li>
<li>View results in the Quiz Results section</li>
<li>Export results to Excel or CSV for analysis</li>
<li>Supports 30+ concurrent users easily</li>
<li>Prevents users from restarting quiz by refreshing</li>
</ol>
</div>
</div>

<!-- Firebase Help Tab -->
<div id="firebase-help" class="tab-content">
<h2>Kahoot FS Information</h2>

<div class="setup-complete">
<h3>✅ Kahoot FS Ready!✅</h3>
<p>Your quiz app is optimized for production use with Firebase.</p>
<p><strong>Capacity:</strong> 30+ concurrent users | <strong>Storage:</strong> Firebase Realtime Database</p>
<button onclick="switchTab('player')">Go to Player Tab</button>
</div>

<div class="admin-section">
<h3>Kahoot FS Capacity</h3>
<div class="stats-grid">
<div class="stat-card">
<span class="stat-number">100</span>
<span class="stat-label">Max Concurrent Users</span>
</div>
<div class="stat-card">
<span class="stat-number">1GB</span>
<span class="stat-label">Monthly Data Limit</span>
</div>
<div class="stat-card">
<span class="stat-number">∞</span>
<span class="stat-label">Quiz Sessions</span>
</div>
<div class="stat-card">
<span class="stat-number">$0</span>
<span class="stat-label">Monthly Cost</span>
</div>
</div>
</div>

<div class="instructions">
<h3>Kahoot FS Features</h3>
<ol>
<li><strong>Admin control:</strong> Full control over quiz</li>
<li><strong>User Management:</strong> Add users with unique access codes</li>
<li><strong>Session Isolation:</strong> Each device has separate session</li>
<li><strong>Data Protection:</strong> All data encrypted in Firebase</li>
</ol>
</div>

<div class="card">
<h3>Kahoot FS Features</h3>
<ul>
<li>✅ Player results with statistics</li>
<li>✅ Results download for players</li>
<li>✅ Session progress saving</li>
<li>✅ Enhanced answer feedback</li>
<li>✅ Individual user management</li>
<li>✅ Admin password change</li>
</ul>
</div>
</div>
</div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyDnt-BAUsCbQMZ-PPALhp3_tsYqcHAKEZ8",
authDomain: "thequizfs.firebaseapp.com",
databaseURL: "https://thequizfs-default-rtdb.firebaseio.com",
projectId: "thequizfs",
storageBucket: "thequizfs.firebasestorage.app",
messagingSenderId: "16144411406",
appId: "1:16144411406:web:d83affb2013dea665e055f",
measurementId: "G-NXX4GQZ4NF"
};

// Initialize Firebase with error handling
let app;
try {
app = firebase.initializeApp(firebaseConfig);
} catch (error) {
if (error.code === 'app/duplicate-app') {
app = firebase.app();
} else {
console.error('Firebase initialization error:', error);
}
}
const database = firebase.database();

// Session management - unique for each device with fallback for incognito mode
function getSessionId() {
// Try sessionStorage first (normal browser)
if (sessionStorage.getItem('playerSessionId')) {
return sessionStorage.getItem('playerSessionId');
}

// Try localStorage as fallback (incognito mode)
if (localStorage.getItem('playerSessionId')) {
return localStorage.getItem('playerSessionId');
}

// Create new session ID
const sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

// Try to save in sessionStorage first
try {
sessionStorage.setItem('playerSessionId', sessionId);
} catch (e) {
// If sessionStorage fails (incognito), use localStorage
localStorage.setItem('playerSessionId', sessionId);
}

return sessionId;
}

// Tab switching functionality
function switchTab(tabName) {
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
document.getElementById(tabName).classList.add('active');

document.querySelectorAll('.tab').forEach(tab => {
tab.classList.remove('active');
});

event.target.classList.add('active');

if (tabName === 'host') {
loadHostTimeSettings();
loadUsers();
}
}

// Initialize variables
var questions = [];
var users = [];
var currentIndex = 0;
var playerCode = "";
var countdownInterval;
var timeLeft = 15;
var questionStartTime;
var quizActive = false;
var adminCode = "adminHafsa";

// Player results tracking
var playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};

// Quiz timing configuration
var quizStartTime = localStorage.getItem('quizStartTime');
var quizEndTime = localStorage.getItem('quizEndTime');

if (!quizStartTime) {
var tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
tomorrow.setHours(12, 0, 0, 0);
quizStartTime = tomorrow.getTime();
localStorage.setItem('quizStartTime', quizStartTime);
} else {
quizStartTime = parseInt(quizStartTime);
}

if (!quizEndTime) {
var endTime = new Date(quizStartTime);
endTime.setMinutes(endTime.getMinutes() + 30);
quizEndTime = endTime.getTime();
localStorage.setItem('quizEndTime', quizEndTime);
} else {
quizEndTime = parseInt(quizEndTime);
}

// Load data from Firebase
function loadDataFromFirebase() {
if (!firebase.apps.length) {
setTimeout(loadDataFromFirebase, 1000);
return;
}

database.ref('quizTime').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
quizStartTime = data.startTime;
quizEndTime = data.endTime;
localStorage.setItem('quizStartTime', quizStartTime);
localStorage.setItem('quizEndTime', quizEndTime);
updateQuizTimeInfo();
}
});

database.ref('questions').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
questions = Object.values(data);
} else {
questions = [];
}

localStorage.setItem('quizQuestions', JSON.stringify(questions));
displayQuestions();

if (document.getElementById('player').classList.contains('active') &&
document.getElementById('player-question').innerHTML !== "") {
showPlayerQuestion();
}
});

// Load users
database.ref('users').on('value', (snapshot) => {
const data = snapshot.val();
if (data) {
users = Object.values(data);
} else {
users = [];
}

localStorage.setItem('quizUsers', JSON.stringify(users));
if (document.getElementById('host').classList.contains('active')) {
displayUsers();
}
});
}

// Save quiz time to Firebase
function saveQuizTimeToFirebase(startTime, endTime) {
database.ref('quizTime').set({
startTime: startTime,
endTime: endTime
}).then(() => {
document.getElementById('host-time-status').textContent = 'Quiz time saved successfully!';
document.getElementById('host-time-status').className = 'url-status success';
}).catch((error) => {
document.getElementById('host-time-status').textContent = 'Error saving quiz time: ' + error.message;
document.getElementById('host-time-status').className = 'url-status error';
});
}

// Save questions to Firebase
function saveQuestionsToFirebase() {
database.ref('questions').set(questions).then(() => {
document.getElementById('question-status').textContent = 'Questions saved successfully!';
document.getElementById('question-status').className = 'url-status success';
}).catch((error) => {
document.getElementById('question-status').textContent = 'Error saving questions: ' + error.message;
document.getElementById('question-status').className = 'url-status error';
});
}

// Save users to Firebase
function saveUsersToFirebase() {
database.ref('users').set(users).then(() => {
document.getElementById('user-status').textContent = 'Users saved successfully!';
document.getElementById('user-status').className = 'url-status success';
}).catch((error) => {
document.getElementById('user-status').textContent = 'Error saving users: ' + error.message;
document.getElementById('user-status').className = 'url-status error';
});
}

// Save quiz results to Firebase
function saveToFirebase(playerCode, playerName, question, selectedAnswer, correctAnswer, responseTime, status) {
const responseId = database.ref().child('quizResults').push().key;

const quizData = {
playerCode: playerCode || "Unknown Code",
playerName: playerName || "Unknown Player",
question: question || "Unknown Question",
selectedAnswer: selectedAnswer || "No Answer",
correctAnswer: correctAnswer || "Unknown",
responseTime: responseTime || 0,
status: status || "Unknown",
timestamp: new Date().toISOString(),
questionIndex: currentIndex,
sessionId: getSessionId(),
deviceType: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
};

database.ref('quizResults/' + responseId).set(quizData)
.then(() => {
console.log("Data saved successfully for session:", quizData.sessionId);
})
.catch((error) => {
console.error("Save error, retrying:", error);
setTimeout(() => {
database.ref('quizResults/' + responseId).set(quizData);
}, 500);
});
}

// Export functions
function exportToExcel() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results to export.');
return;
}

const data = Object.values(results);
const worksheet = XLSX.utils.json_to_sheet(data);
const workbook = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(workbook, worksheet, "Quiz Results");
XLSX.writeFile(workbook, 'quiz-results.xlsx');
alert('Excel file downloaded successfully!');
})
.catch((error) => {
console.error("Error exporting to Excel:", error);
alert('Error exporting data.');
});
}

function exportToCSV() {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results to export.');
return;
}

const data = Object.values(results);
const csv = convertToCSV(data);
const blob = new Blob([csv], { type: 'text/csv' });
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'quiz-results.csv';
a.click();
window.URL.revokeObjectURL(url);
alert('CSV file downloaded successfully!');
})
.catch((error) => {
console.error("Error exporting to CSV:", error);
alert('Error exporting data.');
});
}

function convertToCSV(data) {
if (data.length === 0) return '';

const headers = Object.keys(data[0]);
const csvRows = [];
csvRows.push(headers.join(','));

for (const row of data) {
const values = headers.map(header => {
const value = row[header] || '';
if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
return `"${value.replace(/"/g, '""')}"`;
}
return value;
});
csvRows.push(values.join(','));
}

return csvRows.join('\n');
}

// Delete all quiz results
function deleteAllResults() {
database.ref('quizResults').remove()
.then(() => {
alert('All quiz results have been deleted successfully!');
loadQuizResults();
})
.catch((error) => {
console.error("Error deleting results:", error);
alert('Error deleting results. Please try again.');
});
}

// Delete results for a specific user
function deleteUserResults(playerCode) {
if (confirm(`Are you sure you want to delete all results for user with code: ${playerCode}?`)) {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results found for this user.');
return;
}

const updates = {};
Object.keys(results).forEach(key => {
if (results[key].playerCode === playerCode) {
updates[key] = null;
}
});

if (Object.keys(updates).length === 0) {
alert('No results found for this user.');
return;
}

database.ref('quizResults').update(updates)
.then(() => {
alert(`All results for user ${playerCode} have been deleted successfully!`);
loadQuizResults();
})
.catch((error) => {
console.error("Error deleting user results:", error);
alert('Error deleting user results. Please try again.');
});
})
.catch((error) => {
console.error("Error loading results:", error);
alert('Error loading results.');
});
}
}

// Confirm before deleting results
function confirmDeleteResults() {
if (confirm('⚠️ Are you sure you want to delete ALL quiz results?\n\nThis action cannot be undone!')) {
if (confirm('🚨 FINAL WARNING: This will permanently delete all quiz data. Continue?')) {
deleteAllResults();
}
}
}

// Load and display quiz results
function loadQuizResults() {
const resultsContainer = document.getElementById('results-container');
resultsContainer.innerHTML = '<p>Loading results...</p>';

database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
resultsContainer.innerHTML = '';

if (!results) {
resultsContainer.innerHTML = '<p>No results yet. Results will appear here as players answer questions.</p>';
return;
}

const resultsArray = Object.values(results);
const totalResponses = resultsArray.length;
const correctAnswers = resultsArray.filter(r => r.selectedAnswer === r.correctAnswer).length;
const accuracy = totalResponses > 0 ? ((correctAnswers / totalResponses) * 100).toFixed(1) : 0;
const avgResponseTime = totalResponses > 0 ?
(resultsArray.reduce((sum, r) => sum + (r.responseTime || 0), 0) / totalResponses).toFixed(2) : 0;

const uniqueSessions = new Set(resultsArray.map(r => r.sessionId));
const uniquePlayers = uniqueSessions.size;

let resultsHTML = `
<div class="stats-container">
<h3>Quiz Statistics</h3>
<div class="stats-grid">
<div class="stat-card">
<span class="stat-number">${uniquePlayers}</span>
<span class="stat-label">Unique Players</span>
</div>
<div class="stat-card">
<span class="stat-number">${totalResponses}</span>
<span class="stat-label">Total Responses</span>
</div>
<div class="stat-card">
<span class="stat-number">${correctAnswers}</span>
<span class="stat-label">Correct Answers</span>
</div>
<div class="stat-card">
<span class="stat-number">${accuracy}%</span>
<span class="stat-label">Accuracy</span>
</div>
<div class="stat-card">
<span class="stat-number">${avgResponseTime}s</span>
<span class="stat-label">Avg Response Time</span>
</div>
</div>
</div>
`;

resultsHTML += '<div class="results-table">';
resultsHTML += '<div class="result-header">';
resultsHTML += '<span>Player</span><span>Question</span><span>Answer</span><span>Correct</span><span>Time</span><span>Status</span><span>Device</span>';
resultsHTML += '</div>';

resultsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

resultsArray.forEach((result) => {
const isCorrect = result.selectedAnswer === result.correctAnswer;
const shortQuestion = result.question.length > 30 ?
result.question.substring(0, 30) + '...' : result.question;

resultsHTML += `
<div class="result-row ${isCorrect ? 'correct' : 'incorrect'}">
<span>${result.playerName} (${result.playerCode})</span>
<span title="${result.question}">${shortQuestion}</span>
<span>${result.selectedAnswer}</span>
<span>${result.correctAnswer}</span>
<span>${result.responseTime}s</span>
<span>${result.status}</span>
<span>${result.deviceType}</span>
</div>
`;
});

resultsHTML += '</div>';
resultsContainer.innerHTML = resultsHTML;

// Load individual user results
loadIndividualUserResults(resultsArray);
})
.catch((error) => {
console.error("Error loading results:", error);
resultsContainer.innerHTML = '<p>Error loading results.</p>';
});
}

// Load individual user results
function loadIndividualUserResults(resultsArray) {
const userResultsContainer = document.getElementById('user-results-container');
userResultsContainer.innerHTML = '<p>Loading individual user results...</p>';

// Group results by playerCode
const resultsByUser = {};

resultsArray.forEach(result => {
if (!resultsByUser[result.playerCode]) {
resultsByUser[result.playerCode] = [];
}
resultsByUser[result.playerCode].push(result);
});

let userResultsHTML = '';

for (const [playerCode, userResults] of Object.entries(resultsByUser)) {
const correctAnswers = userResults.filter(r => r.selectedAnswer === r.correctAnswer).length;
const totalAnswers = userResults.length;
const accuracy = totalAnswers > 0 ? ((correctAnswers / totalAnswers) * 100).toFixed(1) : 0;
const avgResponseTime = totalAnswers > 0 ?
(userResults.reduce((sum, r) => sum + (r.responseTime || 0), 0) / totalAnswers).toFixed(2) : 0;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

userResultsHTML += `
<div class="user-result-item">
<div class="user-result-header">
<div>
<strong>${userName}</strong> (Code: ${playerCode})
</div>
<div>
<button class="user-btn export" onclick="exportUserResults('${playerCode}')">Export</button>
<button class="user-btn delete-results" onclick="deleteUserResults('${playerCode}')">Delete Results</button>
</div>
</div>
<div class="user-result-stats">
<div class="user-stat">
<span class="user-stat-number">${correctAnswers}</span>
<span class="user-stat-label">Correct</span>
</div>
<div class="user-stat">
<span class="user-stat-number">${totalAnswers - correctAnswers}</span>
<span class="user-stat-label">Incorrect</span>
</div>
<div class="user-stat">
<span class="user-stat-number">${totalAnswers}</span>
<span class="user-stat-label">Total</span>
</div>
<div class="user-stat">
<span class="user-stat-number">${accuracy}%</span>
<span class="user-stat-label">Accuracy</span>
</div>
<div class="user-stat">
<span class="user-stat-number">${avgResponseTime}s</span>
<span class="user-stat-label">Avg Time</span>
</div>
</div>
</div>
`;
}

userResultsContainer.innerHTML = userResultsHTML;
}

// Export individual user results
function exportUserResults(playerCode) {
database.ref('quizResults').once('value')
.then((snapshot) => {
const results = snapshot.val();
if (!results) {
alert('No results to export.');
return;
}

const allResults = Object.values(results);
const userResults = allResults.filter(r => r.playerCode === playerCode);

if (userResults.length === 0) {
alert('No results found for this user.');
return;
}

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

const worksheet = XLSX.utils.json_to_sheet(userResults);
const workbook = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(workbook, worksheet, "User Results");
XLSX.writeFile(workbook, `quiz-results-${userName}-${playerCode}.xlsx`);
alert(`Excel file for ${userName} downloaded successfully!`);
})
.catch((error) => {
console.error("Error exporting user results:", error);
alert('Error exporting data.');
});
}

// Load questions from localStorage
var savedQuestions = localStorage.getItem('quizQuestions');
if (savedQuestions) {
questions = JSON.parse(savedQuestions);
} else {
questions = [];
}

// Load users from localStorage
var savedUsers = localStorage.getItem('quizUsers');
if (savedUsers) {
users = JSON.parse(savedUsers);
} else {
users = [];
}

// Load host time settings
function loadHostTimeSettings() {
var quizDate = new Date(quizStartTime);
document.getElementById('host-quiz-date').value = quizDate.toISOString().split('T')[0];

var startTime = new Date(quizStartTime);
var hours = startTime.getHours();
var ampm = hours >= 12 ? 'PM' : 'AM';
hours = hours % 12;
hours = hours ? hours : 12;

document.getElementById('host-start-hour').value = hours;
document.getElementById('host-start-minute').value = startTime.getMinutes();
document.getElementById('host-start-ampm').value = ampm;

var duration = Math.round((quizEndTime - quizStartTime) / 60000);
document.getElementById('host-quiz-duration').value = duration;

displayQuestions();
displayUsers();
}

// Verify admin code
function verifyAdmin() {
var code = document.getElementById('admin-code').value;
var status = document.getElementById('admin-status');

document.getElementById('admin-code').value = '';

if (code === adminCode) {
document.getElementById('admin-features').style.display = 'block';
status.textContent = 'Admin access granted! Features unlocked.';
status.className = 'url-status success';
loadQuizResults();

document.querySelector('.admin-section:first-child').style.display = 'none';
} else {
status.textContent = 'Invalid admin code. Please try again.';
status.className = 'url-status error';
}
}

// Change admin password
function changeAdminPassword() {
var currentPassword = document.getElementById('current-password').value;
var newPassword = document.getElementById('new-password').value;
var confirmPassword = document.getElementById('confirm-password').value;
var status = document.getElementById('password-status');

if (currentPassword !== adminCode) {
status.textContent = 'Current password is incorrect.';
status.className = 'url-status error';
return;
}

if (newPassword !== confirmPassword) {
status.textContent = 'New passwords do not match.';
status.className = 'url-status error';
return;
}

if (newPassword.length < 4) {
status.textContent = 'New password must be at least 4 characters long.';
status.className = 'url-status error';
return;
}

adminCode = newPassword;
status.textContent = 'Password changed successfully!';
status.className = 'url-status success';

// Clear the form
document.getElementById('current-password').value = '';
document.getElementById('new-password').value = '';
document.getElementById('confirm-password').value = '';
}

// Save quiz time configuration
function saveHostQuizTime() {
var date = document.getElementById('host-quiz-date').value;
var hour = parseInt(document.getElementById('host-start-hour').value);
var minute = parseInt(document.getElementById('host-start-minute').value);
var ampm = document.getElementById('host-start-ampm').value;
var duration = document.getElementById('host-quiz-duration').value;

if (!date || isNaN(hour) || isNaN(minute) || !duration) {
document.getElementById('host-time-status').textContent = 'Please fill in all fields correctly';
document.getElementById('host-time-status').className = 'url-status error';
return;
}

if (ampm === 'PM' && hour < 12) hour += 12;
else if (ampm === 'AM' && hour === 12) hour = 0;

var startDate = new Date(date);
startDate.setHours(hour, minute, 0, 0);
var endDate = new Date(startDate.getTime() + parseInt(duration) * 60000);

quizStartTime = startDate.getTime();
quizEndTime = endDate.getTime();

saveQuizTimeToFirebase(quizStartTime, quizEndTime);
updateQuizTimeInfo();

setTimeout(() => {
document.getElementById('host-time-status').textContent = 'Quiz time configuration saved';
document.getElementById('host-time-status').className = 'url-status';
}, 3000);
}

// Add a new user
function addUser() {
var userName = document.getElementById('user-name').value;
var userCode = document.getElementById('user-code').value;

if (!userName || !userCode) {
document.getElementById('user-status').textContent = 'Please fill in all fields';
document.getElementById('user-status').className = 'url-status error';
return;
}

// Check if code already exists
if (users.some(u => u.code === userCode)) {
document.getElementById('user-status').textContent = 'This access code is already in use';
document.getElementById('user-status').className = 'url-status error';
return;
}

var newUser = {
name: userName,
code: userCode,
active: true
};

users.push(newUser);
saveUsersToFirebase();

document.getElementById('user-status').textContent = 'User added successfully!';
document.getElementById('user-status').className = 'url-status success';

document.getElementById('user-name').value = '';
document.getElementById('user-code').value = '';

setTimeout(() => {
document.getElementById('user-status').textContent = 'Add users with unique access codes';
document.getElementById('user-status').className = 'url-status';
}, 3000);
}

// Display all users
function displayUsers() {
var container = document.getElementById('users-container');
container.innerHTML = '';

if (users.length === 0) {
container.innerHTML = '<p>No users added yet.</p>';
return;
}

users.forEach((user, index) => {
var userItem = document.createElement('div');
userItem.className = 'user-item';

userItem.innerHTML = `
<div class="user-info">
<div class="user-name">${user.name}</div>
<div class="user-code">Access Code: ${user.code}</div>
</div>
<span class="user-status status-${user.active ? 'active' : 'inactive'}">
${user.active ? 'ACTIVE' : 'INACTIVE'}
</span>
<div class="user-controls">
<button class="user-btn toggle" onclick="toggleUserStatus(${index})">
${user.active ? 'Deactivate' : 'Activate'}
</button>
<button class="user-btn delete" onclick="deleteUser(${index})">Delete</button>
</div>
`;
container.appendChild(userItem);
});
}

// Toggle user status
function toggleUserStatus(index) {
users[index].active = !users[index].active;
saveUsersToFirebase();
displayUsers();
}

// Delete a user
function deleteUser(index) {
if (confirm('Are you sure you want to delete this user?')) {
users.splice(index, 1);
saveUsersToFirebase();
displayUsers();
}
}

// Add a new question
function addQuestion() {
var questionText = document.getElementById('question-text').value;
var answer1 = document.getElementById('answer-1').value;
var answer2 = document.getElementById('answer-2').value;
var answer3 = document.getElementById('answer-3').value;
var answer4 = document.getElementById('answer-4').value;

if (!questionText || !answer1 || !answer2 || !answer3 || !answer4) {
document.getElementById('question-status').textContent = 'Please fill in all fields';
document.getElementById('question-status').className = 'url-status error';
return;
}

var correctAnswerIndex = parseInt(document.querySelector('input[name="correct-answer"]:checked').value);
var answers = [answer1, answer2, answer3, answer4];
var correctAnswer = answers[correctAnswerIndex];

var newQuestion = {
question: questionText,
answers: answers,
correct: correctAnswer,
hidden: false
};

questions.push(newQuestion);
saveQuestionsToFirebase();

document.getElementById('question-status').textContent = 'Question added successfully!';
document.getElementById('question-status').className = 'url-status success';

document.getElementById('question-text').value = '';
document.getElementById('answer-1').value = '';
document.getElementById('answer-2').value = '';
document.getElementById('answer-3').value = '';
document.getElementById('answer-4').value = '';
document.querySelector('input[name="correct-answer"][value="0"]').checked = true;

setTimeout(() => {
document.getElementById('question-status').textContent = 'Add a new question to the quiz';
document.getElementById('question-status').className = 'url-status';
}, 3000);
}

// Display all questions with show/hide toggle
function displayQuestions() {
var container = document.getElementById('questions-container');
container.innerHTML = '';

if (questions.length === 0) {
container.innerHTML = '<p>No questions added yet.</p>';
return;
}

questions.forEach((q, index) => {
var questionItem = document.createElement('div');
questionItem.className = 'question-item';
if (q.hidden) {
questionItem.classList.add('hidden');
}

var correctIndex = q.answers.indexOf(q.correct);
var status = q.hidden ? 'hidden' : 'visible';

questionItem.innerHTML = `
<strong>Q${index + 1}:</strong> ${q.question}
<span class="status-badge status-${status}">${status.toUpperCase()}</span>
<div class="response-time">Correct answer: ${q.correct} (Option ${correctIndex + 1})</div>
<div class="admin-controls">
<button class="admin-btn edit" onclick="editExistingQuestion(${index})">Edit</button>
<button class="admin-btn toggle" onclick="toggleQuestionVisibility(${index})">
${q.hidden ? 'Show' : 'Hide'}
</button>
<button class="admin-btn delete" onclick="deleteQuestion(${index})">Delete</button>
</div>
`;
container.appendChild(questionItem);
});
}

// Edit a question
function editExistingQuestion(index) {
var q = questions[index];

document.getElementById('question-text').value = q.question;
document.getElementById('answer-1').value = q.answers[0];
document.getElementById('answer-2').value = q.answers[1];
document.getElementById('answer-3').value = q.answers[2];
document.getElementById('answer-4').value = q.answers[3];

var correctIndex = q.answers.indexOf(q.correct);
document.querySelectorAll('input[name="correct-answer"]').forEach((radio, i) => {
radio.checked = (i === correctIndex);
});

questions.splice(index, 1);
saveQuestionsToFirebase();

document.getElementById('question-status').textContent = 'Editing question. Update the fields above and click "Add Question" to save changes.';
document.getElementById('question-status').className = 'url-status success';

document.getElementById('question-text').scrollIntoView({ behavior: 'smooth' });
}

// Toggle question visibility
function toggleQuestionVisibility(index) {
questions[index].hidden = !questions[index].hidden;
saveQuestionsToFirebase();
displayQuestions();
}

// Delete a question
function deleteQuestion(index) {
if (confirm('Are you sure you want to delete this question?')) {
questions.splice(index, 1);
saveQuestionsToFirebase();
displayQuestions();
}
}

// Update quiz time info display
function updateQuizTimeInfo() {
var start = new Date(quizStartTime);
var end = new Date(quizEndTime);

var options = {
weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
hour: '2-digit', minute: '2-digit'
};

var timeRange = start.toLocaleDateString('en-US', options) + ' to ' +
end.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

document.getElementById('quiz-time-range').textContent = timeRange;

var now = new Date().getTime();
var quizTimer = document.getElementById('quiz-timer');
var quizStatus = document.getElementById('quiz-status-text');

if (now < quizStartTime) {
var timeUntilStart = Math.floor((quizStartTime - now) / 1000);
var hours = Math.floor(timeUntilStart / 3600);
var minutes = Math.floor((timeUntilStart % 3600) / 60);
var seconds = timeUntilStart % 60;

quizTimer.textContent = `Starts in: ${hours}h ${minutes}m ${seconds}s`;
quizStatus.textContent = 'Not started';
quizStatus.style.color = '#ff9800';
quizActive = false;
} else if (now >= quizStartTime && now <= quizEndTime) {
var timeLeft = Math.floor((quizEndTime - now) / 1000);
var minutes = Math.floor(timeLeft / 60);
var seconds = timeLeft % 60;

quizTimer.textContent = `Time left: ${minutes}m ${seconds}s`;
quizStatus.textContent = 'Active';
quizStatus.style.color = '#4caf50';
quizActive = true;
} else {
quizTimer.textContent = 'Quiz ended';
quizStatus.textContent = 'Ended';
quizStatus.style.color = '#f44336';
quizActive = false;
}
}

// Save quiz progress with fallback for incognito mode
function saveQuizProgress() {
var progress = {
currentIndex: currentIndex,
playerResults: playerResults,
timestamp: Date.now()
};

// Try sessionStorage first, fallback to localStorage for incognito
try {
sessionStorage.setItem('quizProgress', JSON.stringify(progress));
} catch (e) {
localStorage.setItem('quizProgress', JSON.stringify(progress));
}
}

// Resume quiz from saved progress with fallback for incognito mode
function resumeQuiz() {
playerCode = getStoredValue('playerCode');
var savedProgress = getStoredValue('quizProgress');

if (savedProgress) {
var progress = JSON.parse(savedProgress);
currentIndex = progress.currentIndex || 0;
playerResults = progress.playerResults || {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};
}

document.getElementById("player-code").style.display = "none";
document.getElementById("joinBtn").style.display = "none";
document.getElementById('player-question').innerHTML = "";
showPlayerQuestion();
}

// Get stored value with fallback for incognito mode
function getStoredValue(key) {
// Try sessionStorage first
let value = sessionStorage.getItem(key);
if (value !== null) return value;

// Fallback to localStorage for incognito mode
value = localStorage.getItem(key);
return value;
}

// Set stored value with fallback for incognito mode
function setStoredValue(key, value) {
// Try sessionStorage first
try {
sessionStorage.setItem(key, value);
} catch (e) {
// Fallback to localStorage for incognito mode
localStorage.setItem(key, value);
}
}

// Remove stored value with fallback for incognito mode
function removeStoredValue(key) {
// Try sessionStorage first
try {
sessionStorage.removeItem(key);
} catch (e) {
// Fallback to localStorage for incognito mode
localStorage.removeItem(key);
}
}

// Reset quiz session with fallback for incognito mode
function resetQuizSession() {
removeStoredValue('quizCompleted');
removeStoredValue('quizStarted');
removeStoredValue('quizProgress');
removeStoredValue('playerCode');
location.reload();
}

// Countdown timer function
function startCountdown() {
timeLeft = 15;
document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

clearInterval(countdownInterval);
countdownInterval = setInterval(() => {
timeLeft--;
document.getElementById('countdown').textContent = `Time left: ${timeLeft}s`;

if (timeLeft <= 0) {
clearInterval(countdownInterval);
var visibleQuestions = questions.filter(q => !q.hidden);
var q = visibleQuestions[currentIndex];
var responseTime = (Date.now() - questionStartTime) / 1000;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

saveToFirebase(playerCode, userName, q.question, "No Answer", q.correct, responseTime, "Unanswered");

playerResults.incorrect++;
playerResults.total++;
playerResults.responseTimes.push(responseTime);
playerResults.accuracy = (playerResults.correct / playerResults.total) * 100;

saveQuizProgress();
moveToNextQuestion();
}
}, 1000);
}

// 5-second countdown before next question
function startNextQuestionCountdown() {
var countdownTime = 5;
document.getElementById('countdown').textContent = `Next question in: ${countdownTime}s`;
document.getElementById('countdown').style.color = "#6e8efb";
document.getElementById('countdown').style.fontWeight = "bold";

var countdownInterval = setInterval(function() {
countdownTime--;
document.getElementById('countdown').textContent = `Next question in: ${countdownTime}s`;

if (countdownTime <= 0) {
clearInterval(countdownInterval);
document.getElementById('countdown').textContent = "";
moveToNextQuestion();
}
}, 1000);
}

// Move to next question automatically
function moveToNextQuestion() {
currentIndex++;
var visibleQuestions = questions.filter(q => !q.hidden);

if (currentIndex < visibleQuestions.length) {
saveQuizProgress();
showPlayerQuestion();
} else {
showPlayerResults();
}
}

// Show player results at the end of quiz
function showPlayerResults() {
// Mark quiz as completed
setStoredValue('quizCompleted', 'true');
removeStoredValue('quizProgress');
removeStoredValue('quizStarted');

var avgResponseTime = playerResults.responseTimes.length > 0
? (playerResults.responseTimes.reduce((a, b) => a + b, 0) / playerResults.responseTimes.length).toFixed(2)
: 0;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

document.getElementById('player-question').innerHTML = `
<div class="player-results">
<h2>🎉 Quiz Completed! 🎉</h2>
<p>Thank you for participating, ${userName}!</p>

<div class="result-stats">
<div class="result-stat">
<span class="result-number result-correct">${playerResults.correct}</span>
<span class="result-label">Correct Answers</span>
</div>
<div class="result-stat">
<span class="result-number result-incorrect">${playerResults.incorrect}</span>
<span class="result-label">Incorrect Answers</span>
</div>
<div class="result-stat">
<span class="result-number result-accuracy">${playerResults.accuracy.toFixed(1)}%</span>
<span class="result-label">Accuracy</span>
</div>
<div class="result-stat">
<span class="result-number result-time">${avgResponseTime}s</span>
<span class="result-label">Avg Response Time</span>
</div>
</div>

<button class="download-btn" onclick="downloadPlayerResults()">
📥 Download My Results
</button>

<div class="session-warning">
<h3>⚠️ Quiz Completed</h3>
<p>You have completed this quiz.</p>
<p><strong>Note:</strong> You cannot retake this quiz.</p>
</div>
</div>
`;

document.getElementById('player-answers').innerHTML = "";
document.getElementById('countdown').textContent = "";
}

// Download player results as CSV
function downloadPlayerResults() {
var avgResponseTime = playerResults.responseTimes.length > 0
? (playerResults.responseTimes.reduce((a, b) => a + b, 0) / playerResults.responseTimes.length).toFixed(2)
: 0;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

var csvData = [
['Player Name', 'Player Code', 'Correct Answers', 'Incorrect Answers', 'Total Questions', 'Accuracy', 'Average Response Time'],
[userName, playerCode, playerResults.correct, playerResults.incorrect, playerResults.total, playerResults.accuracy.toFixed(1) + '%', avgResponseTime + 's']
];

var csv = csvData.map(row => row.join(',')).join('\n');
var blob = new Blob([csv], { type: 'text/csv' });
var url = window.URL.createObjectURL(blob);
var a = document.createElement('a');
a.href = url;
a.download = `quiz-results-${userName}-${new Date().toISOString().split('T')[0]}.csv`;
a.click();
window.URL.revokeObjectURL(url);
}

// Enhanced player view functions with grid layout
function showPlayerQuestion() {
// Filter out hidden questions
var visibleQuestions = questions.filter(q => !q.hidden);

if (currentIndex >= visibleQuestions.length) {
showPlayerResults();
return;
}

var q = visibleQuestions[currentIndex];
document.getElementById("player-question").innerHTML = "<h3>Question " + (currentIndex + 1) + ":</h3><p>" + q.question + "</p>";

var answersDiv = document.getElementById("player-answers");
answersDiv.innerHTML = "<h3>Select your answer:</h3>";

// Create grid container
var gridContainer = document.createElement("div");
gridContainer.className = "answers-grid";

questionStartTime = Date.now();

q.answers.forEach(a => {
var btn = document.createElement("button");
btn.className = "answer-btn";
btn.innerHTML = a;
btn.onclick = function() {
if (!quizActive) {
alert("The quiz is not currently active. Please check the quiz schedule.");
return;
}

var selected = a;
var correct = q.correct;
var responseTime = (Date.now() - questionStartTime) / 1000;

clearInterval(countdownInterval);

// Immediately disable all buttons to prevent multiple clicks
var allButtons = document.querySelectorAll('.answer-btn');
allButtons.forEach(button => {
button.disabled = true;
button.style.pointerEvents = 'none';
});

// ENHANCED COLOR LOGIC - More reliable with immediate feedback
allButtons.forEach(button => {
// Remove any existing classes first
button.classList.remove('correct', 'incorrect');

if (button.innerHTML === correct) {
// Correct answer - always show green immediately
button.classList.add('correct');
} else if (button.innerHTML === selected) {
// User's wrong selection - show red immediately
button.classList.add('incorrect');
} else {
// Other options - gray out
button.style.opacity = "0.6";
button.style.background = "#f0f0f0";
}
});

// TRACK RESULTS
if (selected === correct) {
playerResults.correct++;
} else {
playerResults.incorrect++;
}
playerResults.total++;
playerResults.responseTimes.push(responseTime);
playerResults.accuracy = (playerResults.correct / playerResults.total) * 100;

// Find user name
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Unknown User';

saveToFirebase(playerCode, userName, q.question, selected, correct, responseTime, "Answered");
saveQuizProgress();

// Start countdown for next question
startNextQuestionCountdown();
};
gridContainer.appendChild(btn);
});

answersDiv.appendChild(gridContainer);
startCountdown();
}

// Initialize the application
document.getElementById("joinBtn").onclick = function() {
if (!quizActive) {
alert("The quiz is not currently active. Please check the quiz schedule.");
return;
}

// Check if user already completed quiz in this session
if (getStoredValue('quizCompleted') === 'true') {
alert("You have already completed this quiz. You cannot retake it.");
return;
}

// Check if user already started quiz
if (getStoredValue('quizStarted') === 'true' && !getStoredValue('quizCompleted')) {
if (!confirm("You have already started this quiz. Do you want to continue where you left off?")) {
return;
}
}

playerCode = document.getElementById("player-code").value.trim();
if (playerCode !== "") {
// Check if user code is valid and active
const user = users.find(u => u.code === playerCode);
if (!user) {
alert("Invalid access code. Please check your code and try again.");
return;
}

if (!user.active) {
alert("Your account is inactive. Please contact the quiz administrator.");
return;
}

// Mark quiz as started
setStoredValue('quizStarted', 'true');
setStoredValue('playerCode', playerCode);

// Reset results when starting new quiz
playerResults = {
correct: 0,
incorrect: 0,
total: 0,
responseTimes: [],
accuracy: 0
};

// Restore progress if exists
var savedProgress = getStoredValue('quizProgress');
if (savedProgress) {
var progress = JSON.parse(savedProgress);
currentIndex = progress.currentIndex || 0;
playerResults = progress.playerResults || playerResults;
}

currentIndex = 0;
document.getElementById("player-code").style.display = "none";
document.getElementById("joinBtn").style.display = "none";
showPlayerQuestion();
} else {
alert("Please enter your access code to join the game.");
}
};

// Update quiz timer every second
setInterval(updateQuizTimeInfo, 1000);
updateQuizTimeInfo();

// Prevent accidental page refresh
window.addEventListener('beforeunload', function (e) {
if (getStoredValue('quizStarted') === 'true' && getStoredValue('quizCompleted') !== 'true') {
e.preventDefault();
e.returnValue = 'You have an ongoing quiz. Are you sure you want to leave?';
return 'You have an ongoing quiz. Are you sure you want to leave?';
}
});

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
document.querySelectorAll('.tab-content').forEach(tab => {
tab.classList.remove('active');
});
document.getElementById('player').classList.add('active');
// Wait for Firebase to load before showing quiz status
function checkQuizStatusAfterLoad() {
// Check if user already completed quiz (after Firebase loads)
if (getStoredValue('quizCompleted') === 'true') {
const playerCode = getStoredValue('playerCode') || 'Unknown';
const user = users.find(u => u.code === playerCode);
const userName = user ? user.name : 'Player';

document.getElementById('player-question').innerHTML = `
<div class="player-results">
<h2>🏁 Quiz Already Completed</h2>
<p>Hello <strong>${userName}</strong>, you have successfully completed this quiz!</p>
<div class="session-warning">
<h3>⚠️ Attempt Limit Reached</h3>
<p>Each participant can only complete the quiz once.</p>
</div>
</div>
`;
document.getElementById("player-code").style.display = "none";
// Disable the join button instead of hiding it
document.getElementById("joinBtn").disabled = true;
document.getElementById("joinBtn").style.background = "#ccc";
document.getElementById("joinBtn").textContent = "Quiz Completed";
document.getElementById("joinBtn").style.cursor = "not-allowed";
}
}
// Wait a bit for Firebase to initialize before checking status
setTimeout(checkQuizStatusAfterLoad, 1000); // 1 second delay
function initializeApp() {
try {
loadDataFromFirebase();
// Check status again after Firebase fully loads
setTimeout(checkQuizStatusAfterLoad, 2000);
} catch (error) {
setTimeout(initializeApp, 2000);
}
}
initializeApp();
console.log("Enhanced Kahoot FS with User Management Initialized");
});
</script>
</body>
</html>
